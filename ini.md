# 项目开发文档 (ini.md) 

## 前言

我已经完成了本项目的核心架构设计、数据模型定义以及初步的数据同步与计算实现。我们正处于从后端逻辑开发过渡到前端交互完善的关键阶段。

你的首要任务是，严格以这份文档中描述的业务逻辑和已确认的代码结构为基础，继续完成后续的开发工作。 这份文档经过了最终审查，修正了之前所有已知的错误和不一致之处，是你可以完全信赖的、唯一的真相来源。

---

## 本次开发周期总结 (截至 2025年7月18日)

**状态：** 本次迭代的所有核心需求均已完成。

1.  **【已完成】Bug修复 - 月嫂合同下户日期计算错误:**
    *   **问题:** 月嫂合同的预计下户日期仅根据实际上户日期加固定天数，未考虑预产期与实际上户日期的偏差。
    *   **解决方案:** 修正了 `billing_api.py` 中的计算逻辑，���在会根据“实际上户日”与“预产期”的差值，动态调整原始的合同结束日期，以保证合同总时长不变。

2.  **【已完成】Bug修复 - 月嫂合同重复账单:**
    *   **问题:** 在特定情况下，系统会为同一个服务周期生成重复的月度账单。
    *   **解决方案:** 锁定了 `billing_engine.py` 中的根源问题。通过实现更健壮的“Get or Create”逻辑，确保了对任意一个服务周期，系统只会创建唯一的一张账单，彻底杜绝了重复。

3.  **【已完成】功能增强 - 自动识别月签育儿嫂合同:**
    *   **需求:** 根据金数据“补充条款”字段中的“延续一个月”字样，自动将合同标记为月签。
    *   **解决方案:** 在 `data_sync_service.py` 中增加了关键字识别逻辑，实现了合同类型的自动分类。

4.  **【已完成】功能增强 - 增加“合同剩余月数”:**
    *   **需求:** 在合同列表和详情页展示合同的剩余有效期。
    *   **解决方案:** 在后端 `billing_api.py` 中增加了动态计算逻辑，能正确处理“月签”、“短期”（月嫂）、以���根据是否已开始合同来计算剩余月数的多种情况。前端 `ContractList.jsx` 和 `ContractDetail.jsx` 已同步更新展示。

5.  **【已完成】功能增强 - 育儿嫂账单详情优化:**
    *   **需求:** 丰富育儿嫂账单详情，使其与月嫂账单布局一致，并实现更精细的业务计算规则。
    *   **解决方案:**
        *   **后端:** 重写了 `billing_engine.py` 中的 `_calculate_nanny_bill` 方法，实现了精确的管理费（区分年签/月签、首月/末月）、员工首月10%服务费等核心业务逻辑。
        *   **前端:** 更新了 `FinancialManagementModal.jsx` 组件，以正确展示所有新增字段，并实现了“加班费为0则不显示”、“育儿嫂不显示5%奖励”等动态渲染规则。

6.  **【待处理】功能增强 - 账单金额计算过程说明:**
    *   **需求:** 在账单详情的每个金额旁增加信息图标，悬停后显示该金额的详细计算规则和过程。
    *   **解决方案:**
        *   **后端:** 增强了 `billing_engine.py`，使其在计算日志中保存所有必要的原始值。
        *   **前端:** 在 `FinancialManagementModal.jsx` 中创建了 `getTooltipContent` 辅助函数，该函数能动态生成带有中文标签的、清晰的计算公式说明，并能优雅地处理账单未计算时的状态。

---

## 第一部分：已确认的数据库模型 (models.py)

这是我们系统的“宪法”，所有代码都必须围绕这个结构来编写。

### 核心模型:

- **BaseContract**: 合同的父模型，采用单表继承策略。关键通用字段如 `customer_name`, `employee_level`, `status`, 以及所有日期字段（`start_date`, `end_date`, `provisional_start_date`, `actual_onboarding_date`）都已定义在此模型中，所有子类共享这些列。
- **NannyContract (育儿嫂合同)**: `BaseContract` 的子类，通过 `type='nanny'` 识别，包含 `is_monthly_auto_renew` 等特有字段。
- **MaternityNurseContract (月嫂合同)**: `BaseContract` 的子类，通过 `type='maternity_nurse'` 识别，包含 `deposit_amount`, `management_fee_rate` 等特有字段。

### 人员模型:

- **User**: 系统内部员工，可登录。
- **ServicePersonnel**: 外部或历史服务人员，不可登录。
- **关联**: `BaseContract` 过 `user_id` 和 `service_personnel_id` 两个可为空的外键来关联到具体人员。

### 业务数据模型:

- **AttendanceRecord**: 考勤记录。已升级为周期模式，通过 `cycle_start_date` 和 `cycle_end_date` 记录，以支持月嫂的跨月考勤。
- **SubstituteRecord**: 替班记录。
- **FinancialAdjustment**: 财务调整项（增/减款）。

### 结果模型:

- **CustomerBill**: 客户月度账单。
- **EmployeePayroll**: 员工月度薪酬单。`employee_id` 字段已移除外键约束，可以存储来自 `User` 或 `ServicePersonnel` 的ID。

---

## 第二部分：业务逻辑与字段映射 (最终审查版)

### A. 育儿嫂合同 (Nanny Contract) - 最新版

- **核心业务模式**: 分为 **月签** 和 **非月签** 两种模式，计费逻辑有显著不同。
- **签约类型**:
  - **实现**: 通过 `NannyContract.is_monthly_auto_renew` (布尔型) 字段区分。`True` 为月签，`False` 为非月签。
- **签约时间段**: 合同的完整生命周期。
  - **实现**: `BaseContract.start_date` 和 `end_date`。
- **萌嫂/客户/级别**: 含义不变，分别对应服务人员、客户姓名和月薪。

---

#### **1. 账单周期 (`本月合同时间段`)**

- **月签合同 (`is_monthly_auto_renew=True`)**:
  - **逻辑**: 严格按 **自然月** 计算。
  - **首月**: 从合同 `start_date` 到该月最后一天。
  - **后续月份**: 从该月1号到该月最后一天。
- **非月签合同 (`is_monthly_auto_renew=False`)**:
  - **逻辑**: 严格按合同的 **签约日** 进行跨月计算。
  - **示例**: 如合同期为 `2024-03-05` 至 `2025-03-04`，则：
    - 第一个账单周期是 `2024-03-05` ~ `2024-04-04`。
    - 第二个账单周期是 `2024-04-05` ~ `2024-05-04`。
    - ...以此类推。

---

#### **2. 管理费 (`本次交管理费`)**

- **费率**: 默认为月薪的 **10%**。
- **月签合同**:
  - **逻辑**: **每月**都需要缴纳当月的管理费。
  - **实现**: 在计算每月账单时，将 `月薪 * 10%` 的金额计入当月的“客户应付款”。
- **非月签合同**:
  - **逻辑**: 在合同的**第一个月**，一次性缴纳**整个合同周期**的管理费。
  - **实现**:
    - **首月计算**:
      - 计算总合同月数（不足一月按一月计）。
      - `总管理费 = 月薪 * 10% * 总合同月数`。
      - 将 `总管理费` 全额计入第一个月账单的“客户应付款”。
    - **支付状态追踪**:
      - 通过 `NannyContract.management_fee_status` 字段 (`pending`, `paid`) 追踪支付状态，防止重复计算。
    - **末月退费**:
      - 在计算最后一个账单周期时，判断实际服务天数是否小于30天。
      - 如果是，则按比例计算应退还的管理费：`退费金额 = (月管理费 / 30) * (30 - 实际天数)`。
      - 将 `退费金额` 从客户的应付款中扣除（或作为一笔负向调整）。

---

#### **3. 合同剩余月数**

- **月签合同**:
  - **显示**: 直接显示文本“**月签**”。
- **非月签合同**:
  - **显示**: 根据当前日期和合同 `end_date`，动态计算剩余的完整月份数。用于续约提醒。

---

#### **4. 其他计算 (逻辑不变)**

- **出勤/加班**: 基于 `AttendanceRecord` 计算，逻辑不变。
- **首月员工10%费用**: 仅在第一个服务月生效，员工需要在首月支付基本*10%的费用给公司。
- **财务调整/替班**: 替班的费用算给其他阿姨，体现在在当前阿姨上就是出勤天数。因此在出勤处应该增加一个“替班”按钮，关联到“替班”操作，选择替班员工，以及替班员工的工资级别（注意替班不是按合同中的“级别”来计算，而是按替班员工的薪酬“级别”来计算）。因此本月也会有两条账单，一个合同员工的账单，一个是替班阿姨的账单。这两个账单都挂在同一个合同下。
- **最终应付款/应领款**: 是以上所有项目加总的结果。


### B. 月嫂合同 (Maternity Nurse Contract)——已完成开发

- **核心业务模式**: 按 **26天为一个服务周期** 计费，以上户日期为起点。

#### Excel 表头 (月嫂)业务逻辑解释与系统实现 (已修正)

- **级别**含义: 月嫂的级别工资，即一个完整26天服务周期的客户总支付费用。
  - **实现**: 对应 `BaseContract.employee_level`。这是所有计算的基石。
- **定金**含义: 客户签约时预付。
  - **实现**: 对应 `MaternityNurseContract.deposit_amount`。
- **客交保证金**含义: 客户上户后补齐的保证金。
  - **实现**: 对应 `MaternityNurseContract.security_deposit_paid`。
- **劳务费时段**含义: **核心！** 从实际上户日期开始计算的26天周期。
  - **起点**: `BaseContract.actual_onboarding_date`。此字段为空，则不进行任何计算。
  - **终点**: 实际上户日期 + 25天。
- **劳务天数**含义: 在当前结算周期内，员工实际工作的天数。
  - **实现**: 从对应周期的 `AttendanceRecord` 中获取 `total_days_worked`。
- **管理费**含义: 公司收取的服务费。
  - **实现**:
    - 在 `BillingEngine` 中计算：(级别工资 / 26) * 劳务天数 * 管理费率。
    - 管理费率: 从 `MaternityNurseContract.management_fee_rate` (15%或25%) 获取。
- **优惠**含义: 固定的优惠金额。
  - **实现**: 对应 `MaternityNurseContract.discount_amount`。
- **客增加款 / 退客户款**含义: 客户侧的零散收支。
  - **实现 (待开发)**: 通过 `FinancialAdjustment` 录入和管理。
- **客应付款**含义: 客户当期应付总额。
  - **实现**:
    - 在 `BillingEngine` 中计算：劳务费 + 管理费 + 客增加款 - 优惠 - 退客户款。
    - 其中，劳务费 = (级别工资 / 26) * 劳务天数。
- **是否打款 / 打款时间及渠道 / 发票记录**含义: 客户付款的后续追踪。
  - **实现 (待开发)**: 这些是 `CustomerBill` 和 `InvoiceRecord` 表中的字段，需在UI上提供修改功能。
- **萌嫂保证金(工资)**含义: 员工本周期的基础工资部分。
  - **实现**:
    - 在 `BillingEngine` 中计算：员工实际日薪 * (总出勤天数 - 节假日加班天数)。
    - 员工实际日薪 = (级别工资 * (1 - 管理费率)) / 26。
- **5%奖励**含义: 公司给予员工的额外奖励。
  - **实现**:
    - **触发条件**: 管理费率 为 15%。
    - **金额**: 级别工资 * 5%。
- **加班天数**含义: 折算后的加班天数。
  - **实现 (待开发)**: 在 `BillingEngine` 中计算：非节假日加班 + (法定节假日加班 * 2)。
- **萌嫂增款 / 减萌嫂款**含义: 员工侧的零散收支。
  - **实现 (待开发)**: 通过 `FinancialAdjustment` 录入和管理。
- **萌嫂应领款**含义: 公司当期应发给员工的总薪酬。
  - **实现**:
    - 在 `BillingEngine` 中计算：月嫂保证金(工资) + (员工实际日薪 * 加班天数) + 5%奖励 + 萌嫂增款 - 减萌嫂款。
- **是否领款 / 领款时间及渠道 / 实际领款 / 萌嫂结余 / 备注**含义: 员工薪酬的后续追踪。
  - **实现 (待开发)**: 这些是 `EmployeePayroll` 表中的字段，需在UI上提供修改功能。

---

## 第三部分：已完成的后端功能模块说明

我们已经实现了一个功能基本完备的后端。

1.  **services/data_sync_service.py - 数据同步服务**
    - `_load_credentials()`: 从数据库（`llm_api_keys`表）安全地加载并解密金数据API Key和Secret。
    - `get_form_entries()`: 核心API交互函数。使用标准的HTTP Basic Auth，向金数据 V1 API (`jinshuju.net/api/v1`) 发起请求。已实现基于游标(`next`)的自动分页，能够获取一个表单下的所有数据条目。
    - `_get_or_create_personnel_ref()`: 健壮的人员查找/创建函数。遵循“User by phone -> User by name -> ServicePersonnel by phone -> ServicePersonnel by name -> Create new ServicePersonnel”的三步查找逻辑，返回人员类型和ID。
    - `sync_contracts_from_form()`: 主同步逻辑。遍历从API获取的每一条数据，使用嵌套事务来处理单个条目的错误（如唯一性冲突），确保一个条目的失败不会导致整个任务中断。它能正确解析关联字段，清洗数据，并创建对应的 `NannyContract` 或 `MaternityNurseContract` 对象。

2.  **services/billing_engine.py - 核心计算引擎**
    - `calculate_for_month()`: 计算的总入口。它会遍历所有活动合同，并根据类型调用相应的子计算器。
    - `_calculate_maternity_nurse_bill_for_month()`: 月嫂计算逻辑（已按最新规则重构）。它会严格按照“实际上户日期”和26天周期来查找当月需要结算的服务周期。
    - `_process_one_billing_cycle()`: 核心计算函数。当找到一个需要结算的周期后，此函数会被调用。它会查找对应周期的考勤记录，并根据我们最终确认的公式，分别计算客户应付款和员工应领款，然后将结果和计算详情存入 `CustomerBill` 和 `EmployeePayroll` 表。

3.  **api/billing_api.py - 对外API接口**
    - `/sync-contracts` (POST): 触发一个后台Celery任务来执行 `DataSyncService` 的同步逻辑。
    - `/calculate-bills` (POST): 触发一个后台Celery任务来执行 `BillingEngine` 的计算逻辑。
    - `/attendance` (POST): 保存或更新一条考勤记录。
    - `/contracts` (GET): 获取合同列表。
        - 已实现：分页、按客户/员工姓名搜索、按合同类型/状态筛选。
        - 已实现: 默认只显示当前月份处于服务周期内的活动合同。
        - 已实现: 按合同开始日期降序排序。
    - `/summary` (POST): 批量获取���单摘要。接收一个合同ID列表和月份，返回这些合同在该月的应付金额。
    - `/details` (GET): 获取单个合同的单月财务详情。返回一个结构化的对象，包含了与Excel表头对应的所有字段，供前端展示。
    - `/pre-check` (POST): 计算前预检查。接收合同ID列表和月份，返回其中缺少“实际上户日期”的月嫂合同列表。
    - `/contracts/{id}` (PUT): 更新单个合同。目前用于为月嫂合同设置“实际上户日期”。

4.  **tasks.py - 异步任务**
    - 已创建 `sync_all_contracts_task` 和 `calculate_monthly_billing_task`，它们分别作为 `DataSyncService` 和 `BillingEngine` 的异步执行包装器。

---

## 第四部分：后续待办任务

我们已经走完了最艰难的0到1。你的任务是基于现有成果，完成从1到100的精细化开发。

1.  **【已完成】实现育儿嫂计费逻辑**:
    - 在 `BillingEngine` 中实现 `_calculate_nanny_bill` 函数。
    - 严格按照本交接文档中描述的自然月、26天工作日基准、加班费、首月10%费等规则进行计算。
2.  **【高优先级】实现替班与保证金结算**:
    - **替班管理**: 创建一个界面来录入 `SubstituteRecord`（替班记录），包括替班人员、时间、薪资和额外的管理费。
    - **引擎升级**: 升级 `BillingEngine`，使其在计算时能处理替班情况。
    - **保证金结算**: 升级 `BillingEngine`，在计算最后一个服务周期的账单时，能正确地动用保证金进行多退少补。
3.  **【高优先级】增加终止合同多功能：**
    1.  由于实际业务中，没有“终止”合同的操作，尤其是在“月签”自动续签的合同中，并没有“终止”的这个操作。
    2.  因此在运营人员查看账单详情或者合同详情的时候需要增加一个按钮“终止合同”，点击后弹出“确认终止日期”的弹窗，此处默认的是合同原本的终止日期，提示用户，是否按合同完成日终止合同？用户可以自行选择日期来终止合同。
    3.  终止合同后，要根据合同的终止日来判断是否要重新计算账单，同时删除已生成的后续月份账单
        1.  如果终止日 = 合同结束日，则不用调整任何账单
        2.  如果终止日 早于 合同结束日，怎结最后一个月的账单就要调整，减少账单服务周期（根据终止日来进行计算）
        3.  如果终止日 晚于 合同结束日，则在当前账单的基础上 生成一个新账单，账单服务周期为合同结束日  ~ 终止日。

4.  **【低优先级】仪表盘统计**:
    - 控制台展示，需要设计一个运营人员查看的展示板。请查看我的所有代码，来规划设计一个展示板，用来给运营人员、ceo查看当前系统的核心业务数据。
    - 在财务仪表盘顶部增加统计卡片，显示当月的总应收、总应付、总利润等关键指标。

---

## 第五部分：前端页面设计要求

为以下两个关键页面设计线框图或直接输出HTML代码。

**技术约束:**

- 使用 HTML 和 Tailwind CSS (通过 CDN 引用: `<script src="https://cdn.tailwindcss.com"></script>`)。
- 使用 Material Icons 或 Font Awesome 作为图标 (通过 CDN 引用)
- 页面必须是响应式的。
- 包含轻微的交互效果，如按钮悬停效果。
