"""Add score and result_details to DynamicFormData

Revision ID: 6ddb22b8c22d
Revises: 1fa24bddf243
Create Date: 2025-11-18 16:21:11.194308

"""
from alembic import op
import sqlalchemy as sa
from sqlalchemy.dialects import postgresql

# revision identifiers, used by Alembic.
revision = '6ddb22b8c22d'
down_revision = '1fa24bddf243'
branch_labels = None
depends_on = None


def upgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('dynamic_form_data_copy1', schema=None) as batch_op:
        batch_op.drop_index('idx_dynamic_form_data_form_id_copy1')
        batch_op.drop_index('idx_dynamic_form_data_service_personnel_id_copy1')
        batch_op.drop_index('idx_dynamic_form_data_user_id_copy1')

    op.drop_table('dynamic_form_data_copy1')
    with op.batch_alter_table('dynamic_form', schema=None) as batch_op:
        batch_op.add_column(sa.Column('passing_score', sa.Integer(), nullable=True, comment='考试及格分数 (百分比)'))
        batch_op.add_column(sa.Column('exam_duration', sa.Integer(), nullable=True, comment='考试时长 (分钟)'))
        batch_op.alter_column('form_type',
               existing_type=sa.VARCHAR(length=50),
               comment='表单类型 (ACTIVE_RECORD, HISTORICAL_READONLY, EXAM, QUESTIONNAIRE)',
               existing_comment='表单类型 (ACTIVE_RECORD, HISTORICAL_READONLY)',
               existing_nullable=False,
               existing_server_default=sa.text("'ACTIVE_RECORD'::character varying"))

    with op.batch_alter_table('dynamic_form_data', schema=None) as batch_op:
        batch_op.add_column(sa.Column('score', sa.Integer(), nullable=True, comment='考试得分'))
        batch_op.add_column(sa.Column('result_details', postgresql.JSONB(astext_type=sa.Text()), nullable=True, comment='考试结果详情 (例如每题的对错)'))

    with op.batch_alter_table('exampapercourse', schema=None) as batch_op:
        batch_op.drop_constraint('exampapercourse_exam_paper_id_fkey', type_='foreignkey')
        batch_op.drop_constraint('exampapercourse_course_id_fkey1', type_='foreignkey')
        batch_op.create_foreign_key(None, 'exampaper', ['exam_paper_id'], ['id'], ondelete='CASCADE')
        batch_op.create_foreign_key(None, 'trainingcourse', ['course_id'], ['id'], ondelete='CASCADE')

    # ### end Alembic commands ###


def downgrade():
    # ### commands auto generated by Alembic - please adjust! ###
    with op.batch_alter_table('exampapercourse', schema=None) as batch_op:
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.drop_constraint(None, type_='foreignkey')
        batch_op.create_foreign_key('exampapercourse_course_id_fkey1', 'trainingcourse', ['course_id'], ['id'], ondelete='CASCADE')
        batch_op.create_foreign_key('exampapercourse_exam_paper_id_fkey', 'exampaper', ['exam_paper_id'], ['id'], ondelete='CASCADE')

    with op.batch_alter_table('dynamic_form_data', schema=None) as batch_op:
        batch_op.drop_column('result_details')
        batch_op.drop_column('score')

    with op.batch_alter_table('dynamic_form', schema=None) as batch_op:
        batch_op.alter_column('form_type',
               existing_type=sa.VARCHAR(length=50),
               comment='表单类型 (ACTIVE_RECORD, HISTORICAL_READONLY)',
               existing_comment='表单类型 (ACTIVE_RECORD, HISTORICAL_READONLY, EXAM, QUESTIONNAIRE)',
               existing_nullable=False,
               existing_server_default=sa.text("'ACTIVE_RECORD'::character varying"))
        batch_op.drop_column('exam_duration')
        batch_op.drop_column('passing_score')

    op.create_table('dynamic_form_data_copy1',
    sa.Column('id', sa.UUID(), autoincrement=False, nullable=False, comment='主键，使用 UUID'),
    sa.Column('form_id', sa.UUID(), autoincrement=False, nullable=False, comment='关联的表单定义ID'),
    sa.Column('user_id', sa.UUID(), autoincrement=False, nullable=True, comment='提交此表单的用户ID (如果适用)'),
    sa.Column('service_personnel_id', sa.UUID(), autoincrement=False, nullable=True, comment='关联的服务人员ID (如果适用，例如员工登记表)'),
    sa.Column('data', postgresql.JSONB(astext_type=sa.Text()), autoincrement=False, nullable=False, comment='用户提交的表单数据 JSON'),
    sa.Column('created_at', postgresql.TIMESTAMP(timezone=True, precision=6), server_default=sa.text('now()'), autoincrement=False, nullable=True, comment='创建时间'),
    sa.Column('updated_at', postgresql.TIMESTAMP(timezone=True, precision=6), server_default=sa.text('now()'), autoincrement=False, nullable=True, comment='更新时间'),
    sa.ForeignKeyConstraint(['form_id'], ['dynamic_form.id'], name='dynamic_form_data_copy1_form_id_fkey', ondelete='CASCADE'),
    sa.ForeignKeyConstraint(['service_personnel_id'], ['service_personnel.id'], name='dynamic_form_data_copy1_service_personnel_id_fkey', ondelete='SET NULL'),
    sa.ForeignKeyConstraint(['user_id'], ['user.id'], name='dynamic_form_data_copy1_user_id_fkey', ondelete='SET NULL'),
    sa.PrimaryKeyConstraint('id', name='dynamic_form_data_copy1_pkey'),
    comment='动态表单数据表，存储用户提交的表单数据'
    )
    with op.batch_alter_table('dynamic_form_data_copy1', schema=None) as batch_op:
        batch_op.create_index('idx_dynamic_form_data_user_id_copy1', ['user_id'], unique=False)
        batch_op.create_index('idx_dynamic_form_data_service_personnel_id_copy1', ['service_personnel_id'], unique=False)
        batch_op.create_index('idx_dynamic_form_data_form_id_copy1', ['form_id'], unique=False)

    # ### end Alembic commands ###
