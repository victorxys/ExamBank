<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test First Display Day Logic</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-case { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .pass { background-color: #d4edda; border-color: #c3e6cb; }
        .fail { background-color: #f8d7da; border-color: #f5c6cb; }
        .test-title { font-weight: bold; margin-bottom: 10px; }
        .test-result { margin-top: 10px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 3px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>First Display Day Logic Test</h1>
    <div id="test-results"></div>

    <script type="module">
        // Mock date-fns functions
        const format = (date, formatStr) => {
            if (typeof date === 'string') date = new Date(date);
            if (formatStr === 'yyyy-MM-dd') {
                return date.toISOString().split('T')[0];
            }
            return date.toISOString();
        };

        const isSameDay = (date1, date2) => {
            if (typeof date1 === 'string') date1 = new Date(date1);
            if (typeof date2 === 'string') date2 = new Date(date2);
            return date1.toDateString() === date2.toDateString();
        };

        // Simplified AttendanceDisplayLogic for testing
        class AttendanceDisplayLogic {
            static shouldShowAttendanceType(targetDateStr, record) {
                const targetDate = new Date(targetDateStr);
                const startDate = new Date(record.date);
                const daysOffset = record.daysOffset || 0;
                
                if (daysOffset === 0) return true;
                
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + daysOffset);
                
                const isStartDay = isSameDay(targetDate, startDate);
                const isEndDay = isSameDay(targetDate, endDate);
                
                if (isStartDay) {
                    // å‡ºäº¬ã€å‡ºå¢ƒç±»å‹æ€»æ˜¯æ˜¾ç¤º
                    if (record.type === 'out_of_beijing' || record.type === 'out_of_country') {
                        return true;
                    }
                    // å…¶ä»–ç±»å‹åº”ç”¨ä¸­åˆ12ç‚¹è§„åˆ™
                    const startTime = record.startTime || '09:00';
                    const [startHour, startMinute] = startTime.split(':').map(Number);
                    const startTimeInMinutes = startHour * 60 + startMinute;
                    const noonInMinutes = 12 * 60;
                    return startTimeInMinutes < noonInMinutes;
                } else if (isEndDay) {
                    // å‡ºäº¬ã€å‡ºå¢ƒç±»å‹æ€»æ˜¯æ˜¾ç¤º
                    if (record.type === 'out_of_beijing' || record.type === 'out_of_country') {
                        return true;
                    }
                    // å…¶ä»–ç±»å‹åº”ç”¨24å°æ—¶è§„åˆ™å’ŒçŸ­æœŸè€ƒå‹¤ç‰¹æ®Šå¤„ç†
                    const startTime = record.startTime || '09:00';
                    const [startHour, startMinute] = startTime.split(':').map(Number);
                    const startTimeInMinutes = startHour * 60 + startMinute;
                    const noonInMinutes = 12 * 60;
                    const isAfterNoon = startTimeInMinutes >= noonInMinutes;
                    
                    if (isAfterNoon) {
                        return true;
                    }
                    
                    const totalHours = (record.hours || 0) + (record.minutes || 0) / 60;
                    if (totalHours < 24) {
                        const endTime = record.endTime || '18:00';
                        const [endHour, endMinute] = endTime.split(':').map(Number);
                        const hoursOnEndDay = endHour + endMinute / 60;
                        return hoursOnEndDay >= 24;
                    } else {
                        const endTime = record.endTime || '18:00';
                        const [endHour, endMinute] = endTime.split(':').map(Number);
                        const hoursOnEndDay = endHour + endMinute / 60;
                        return hoursOnEndDay >= 24;
                    }
                } else {
                    // ä¸­é—´æ—¥é€»è¾‘
                    const startTime = record.startTime || '09:00';
                    const [startHour, startMinute] = startTime.split(':').map(Number);
                    const startTimeInMinutes = startHour * 60 + startMinute;
                    const noonInMinutes = 12 * 60;
                    
                    if (startTimeInMinutes >= noonInMinutes) {
                        const startDate = new Date(record.date);
                        const targetDate = new Date(targetDateStr);
                        const daysDiff = Math.floor((targetDate - startDate) / (1000 * 60 * 60 * 24));
                        
                        if (daysDiff === 1) {
                            return true;
                        }
                        
                        const daysOffset = record.daysOffset || 0;
                        if (daysDiff <= daysOffset) {
                            return true;
                        }
                        
                        return false;
                    }
                    
                    return true;
                }
            }

            static isFirstDisplayDay(targetDateStr, record, allRecords) {
                const targetDate = new Date(targetDateStr);
                const startDate = new Date(record.date);
                const daysOffset = record.daysOffset || 0;
                
                console.log(`ğŸ” [DEBUG] isFirstDisplayDay - ç›®æ ‡æ—¥æœŸ: ${targetDateStr}, è®°å½•å¼€å§‹: ${record.date}, è·¨å¤©: ${daysOffset}`);
                
                // å•å¤©è®°å½•ï¼šå¼€å§‹æ—¥å°±æ˜¯ç¬¬ä¸€ä¸ªæ˜¾ç¤ºæ—¥
                if (daysOffset === 0) {
                    const isStartDay = isSameDay(targetDate, startDate);
                    console.log(`ğŸ“… [DEBUG] å•å¤©è®°å½•ï¼Œæ˜¯å¼€å§‹æ—¥: ${isStartDay}`);
                    return isStartDay;
                }
                
                // è·¨å¤©è®°å½•ï¼šæ‰¾åˆ°ç¬¬ä¸€ä¸ªåº”è¯¥æ˜¾ç¤ºè€ƒå‹¤ç±»å‹çš„æ—¥æœŸ
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + daysOffset);
                
                // éå†è®°å½•è¦†ç›–çš„æ‰€æœ‰æ—¥æœŸï¼Œæ‰¾åˆ°ç¬¬ä¸€ä¸ªåº”è¯¥æ˜¾ç¤ºè€ƒå‹¤ç±»å‹çš„æ—¥æœŸ
                let currentDate = new Date(startDate);
                while (currentDate <= endDate) {
                    const currentDateStr = format(currentDate, 'yyyy-MM-dd');
                    const shouldShow = this.shouldShowAttendanceType(currentDateStr, record);
                    
                    console.log(`ğŸ“Š [DEBUG] æ£€æŸ¥æ—¥æœŸ ${currentDateStr}: åº”è¯¥æ˜¾ç¤º = ${shouldShow}`);
                    
                    if (shouldShow) {
                        // æ‰¾åˆ°ç¬¬ä¸€ä¸ªåº”è¯¥æ˜¾ç¤ºçš„æ—¥æœŸ
                        const isFirstDay = isSameDay(targetDate, currentDate);
                        console.log(`ğŸ¯ [DEBUG] ç¬¬ä¸€ä¸ªæ˜¾ç¤ºæ—¥æœŸ: ${currentDateStr}, ç›®æ ‡æ˜¯ç¬¬ä¸€ä¸ª: ${isFirstDay}`);
                        return isFirstDay;
                    }
                    
                    currentDate.setDate(currentDate.getDate() + 1);
                }
                
                // å¦‚æœæ²¡æœ‰æ‰¾åˆ°åº”è¯¥æ˜¾ç¤ºçš„æ—¥æœŸï¼Œè¿”å›false
                console.log(`âŒ [DEBUG] æ²¡æœ‰æ‰¾åˆ°åº”è¯¥æ˜¾ç¤ºçš„æ—¥æœŸ`);
                return false;
            }
        }

        // Test cases
        const testCases = [
            {
                name: 'å•å¤©è®°å½• - å¼€å§‹æ—¥åº”è¯¥æ˜¯ç¬¬ä¸€æ˜¾ç¤ºæ—¥',
                record: {
                    date: '2024-03-03',
                    type: 'leave',
                    startTime: '09:00',
                    endTime: '18:00',
                    daysOffset: 0,
                    hours: 9,
                    minutes: 0
                },
                testDate: '2024-03-03',
                expected: true
            },
            {
                name: 'è·¨å¤©è®°å½• - 12ç‚¹å‰å¼€å§‹ï¼Œå¼€å§‹æ—¥åº”è¯¥æ˜¯ç¬¬ä¸€æ˜¾ç¤ºæ—¥',
                record: {
                    date: '2024-03-03',
                    type: 'rest',
                    startTime: '11:00',
                    endTime: '18:00',
                    daysOffset: 1,
                    hours: 31,
                    minutes: 0
                },
                testDate: '2024-03-03',
                expected: true
            },
            {
                name: 'è·¨å¤©è®°å½• - 12ç‚¹å‰å¼€å§‹ï¼Œç»“æŸæ—¥ä¸åº”è¯¥æ˜¯ç¬¬ä¸€æ˜¾ç¤ºæ—¥',
                record: {
                    date: '2024-03-03',
                    type: 'rest',
                    startTime: '11:00',
                    endTime: '18:00',
                    daysOffset: 1,
                    hours: 31,
                    minutes: 0
                },
                testDate: '2024-03-04',
                expected: false
            },
            {
                name: 'è·¨å¤©è®°å½• - 12ç‚¹åå¼€å§‹ï¼Œå¼€å§‹æ—¥ä¸åº”è¯¥æ˜¯ç¬¬ä¸€æ˜¾ç¤ºæ—¥',
                record: {
                    date: '2024-03-03',
                    type: 'rest',
                    startTime: '13:00',
                    endTime: '18:00',
                    daysOffset: 1,
                    hours: 29,
                    minutes: 0
                },
                testDate: '2024-03-03',
                expected: false
            },
            {
                name: 'è·¨å¤©è®°å½• - 12ç‚¹åå¼€å§‹ï¼Œç»“æŸæ—¥åº”è¯¥æ˜¯ç¬¬ä¸€æ˜¾ç¤ºæ—¥',
                record: {
                    date: '2024-03-03',
                    type: 'rest',
                    startTime: '13:00',
                    endTime: '18:00',
                    daysOffset: 1,
                    hours: 29,
                    minutes: 0
                },
                testDate: '2024-03-04',
                expected: true
            },
            {
                name: 'å‡ºäº¬ç±»å‹ - å¼€å§‹æ—¥åº”è¯¥æ€»æ˜¯ç¬¬ä¸€æ˜¾ç¤ºæ—¥',
                record: {
                    date: '2024-03-03',
                    type: 'out_of_beijing',
                    startTime: '13:00',
                    endTime: '18:00',
                    daysOffset: 1,
                    hours: 29,
                    minutes: 0
                },
                testDate: '2024-03-03',
                expected: true
            },
            {
                name: 'å‡ºäº¬ç±»å‹ - ç»“æŸæ—¥ä¸åº”è¯¥æ˜¯ç¬¬ä¸€æ˜¾ç¤ºæ—¥',
                record: {
                    date: '2024-03-03',
                    type: 'out_of_beijing',
                    startTime: '13:00',
                    endTime: '18:00',
                    daysOffset: 1,
                    hours: 29,
                    minutes: 0
                },
                testDate: '2024-03-04',
                expected: false
            }
        ];

        // Run tests
        const resultsDiv = document.getElementById('test-results');
        let passCount = 0;
        let totalCount = testCases.length;

        testCases.forEach((testCase, index) => {
            console.log(`\nğŸ§ª è¿è¡Œæµ‹è¯• ${index + 1}: ${testCase.name}`);
            
            const result = AttendanceDisplayLogic.isFirstDisplayDay(
                testCase.testDate, 
                testCase.record, 
                [testCase.record]
            );
            
            const passed = result === testCase.expected;
            if (passed) passCount++;
            
            const testDiv = document.createElement('div');
            testDiv.className = `test-case ${passed ? 'pass' : 'fail'}`;
            testDiv.innerHTML = `
                <div class="test-title">${testCase.name}</div>
                <div>æµ‹è¯•æ—¥æœŸ: ${testCase.testDate}</div>
                <div>è®°å½•: ${testCase.record.date} ${testCase.record.startTime}-${testCase.record.endTime} (${testCase.record.daysOffset}å¤©) ${testCase.record.type}</div>
                <div class="test-result">
                    <strong>ç»“æœ:</strong> ${result} | 
                    <strong>æœŸæœ›:</strong> ${testCase.expected} | 
                    <strong>çŠ¶æ€:</strong> ${passed ? 'âœ… é€šè¿‡' : 'âŒ å¤±è´¥'}
                </div>
            `;
            resultsDiv.appendChild(testDiv);
        });

        // Summary
        const summaryDiv = document.createElement('div');
        summaryDiv.className = 'test-case';
        summaryDiv.style.backgroundColor = passCount === totalCount ? '#d4edda' : '#fff3cd';
        summaryDiv.innerHTML = `
            <div class="test-title">æµ‹è¯•æ€»ç»“</div>
            <div>é€šè¿‡: ${passCount}/${totalCount}</div>
            <div>æˆåŠŸç‡: ${((passCount / totalCount) * 100).toFixed(1)}%</div>
        `;
        resultsDiv.appendChild(summaryDiv);
    </script>
</body>
</html>