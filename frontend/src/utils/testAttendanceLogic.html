<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è€ƒå‹¤é€»è¾‘æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            line-height: 1.6;
        }
        .test-case {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 16px;
            margin: 16px 0;
            background: #f9f9f9;
        }
        .test-result {
            margin: 8px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .pass {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .fail {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .summary {
            background: #e2e3e5;
            border: 1px solid #d6d8db;
            border-radius: 8px;
            padding: 16px;
            margin: 20px 0;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .code {
            background: #f8f9fa;
            border: 1px solid #e9ecef;
            border-radius: 4px;
            padding: 12px;
            font-family: 'Monaco', 'Consolas', monospace;
            font-size: 14px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <h1>ğŸ§ª è€ƒå‹¤æ˜¾ç¤ºé€»è¾‘æµ‹è¯•</h1>
    
    <div class="summary">
        <h2>ğŸ“‹ æµ‹è¯•è¯´æ˜</h2>
        <p>æœ¬é¡µé¢ç”¨äºæµ‹è¯•è€ƒå‹¤æ˜¾ç¤ºé€»è¾‘çš„å„ç§ä¸šåŠ¡åœºæ™¯ï¼ŒéªŒè¯å®ç°æ˜¯å¦ç¬¦åˆéœ€æ±‚æ–‡æ¡£ä¸­çš„è§„åˆ™ï¼š</p>
        <ul>
            <li><strong>24å°æ—¶è§„åˆ™</strong>ï¼šè·¨å¤©è®°å½•ä¸­ï¼ŒæŸå¤©è€ƒå‹¤æ—¶é•¿ç­‰äº24å°æ—¶æ‰æ˜¾ç¤ºè€ƒå‹¤ç±»å‹</li>
            <li><strong>ä¸­åˆ12ç‚¹è§„åˆ™</strong>ï¼š12ç‚¹å‰å¼€å§‹æ˜¾ç¤ºè€ƒå‹¤ç±»å‹ï¼Œ12ç‚¹åå¼€å§‹å½“å¤©æ˜¾ç¤ºå‡ºå‹¤</li>
            <li><strong>çŸ­æœŸè€ƒå‹¤ç‰¹æ®Šå¤„ç†</strong>ï¼šä¸æ»¡24å°æ—¶ä¸”12ç‚¹åå¼€å§‹ï¼Œç¬¬äºŒå¤©æ˜¾ç¤ºè€ƒå‹¤ç±»å‹</li>
            <li><strong>è§„åˆ™ä¼˜å…ˆçº§</strong>ï¼šä¸­åˆ12ç‚¹è§„åˆ™ä¼˜å…ˆäº24å°æ—¶è§„åˆ™</li>
        </ul>
    </div>

    <div>
        <button onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰æµ‹è¯•</button>
        <button onclick="clearResults()">ğŸ§¹ æ¸…ç©ºç»“æœ</button>
        <button onclick="showTestData()">ğŸ“Š æ˜¾ç¤ºæµ‹è¯•æ•°æ®</button>
    </div>

    <div id="test-results"></div>

    <div class="summary" id="test-summary" style="display: none;">
        <h2>ğŸ“Š æµ‹è¯•æ€»ç»“</h2>
        <div id="summary-content"></div>
    </div>

    <div class="test-case" id="test-data" style="display: none;">
        <h3>ğŸ“‹ æµ‹è¯•ç”¨ä¾‹æ•°æ®</h3>
        <div class="code" id="test-data-content"></div>
    </div>

    <script type="module">
        // æ¨¡æ‹Ÿ date-fns çš„åŸºæœ¬åŠŸèƒ½
        const format = (date, formatStr) => {
            const d = new Date(date);
            if (formatStr === 'yyyy-MM-dd') {
                return d.toISOString().split('T')[0];
            }
            return d.toISOString();
        };

        const isSameDay = (date1, date2) => {
            const d1 = new Date(date1);
            const d2 = new Date(date2);
            return d1.getFullYear() === d2.getFullYear() &&
                   d1.getMonth() === d2.getMonth() &&
                   d1.getDate() === d2.getDate();
        };

        // ç®€åŒ–çš„è€ƒå‹¤æ˜¾ç¤ºé€»è¾‘å®ç°
        class AttendanceDisplayLogic {
            static getDisplayTypeForDate(targetDateStr, attendanceRecords) {
                const targetDate = new Date(targetDateStr);
                
                for (const record of attendanceRecords) {
                    if (this.isDateCoveredByRecord(targetDateStr, record)) {
                        const shouldShowType = this.shouldShowAttendanceType(targetDateStr, record);
                        
                        if (shouldShowType) {
                            return {
                                type: record.type,
                                record: record,
                                typeLabel: this.getTypeLabel(record.type)
                            };
                        }
                    }
                }
                
                return {
                    type: 'normal',
                    record: null,
                    typeLabel: 'å‡ºå‹¤'
                };
            }

            static isDateCoveredByRecord(targetDateStr, record) {
                const targetDate = new Date(targetDateStr);
                const startDate = new Date(record.date);
                const daysOffset = record.daysOffset || 0;
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + daysOffset);
                
                const targetTime = targetDate.getTime();
                const startTime = startDate.getTime();
                const endTime = endDate.getTime();
                
                return targetTime >= startTime && targetTime <= endTime;
            }

            static shouldShowAttendanceType(targetDateStr, record) {
                const targetDate = new Date(targetDateStr);
                const startDate = new Date(record.date);
                const daysOffset = record.daysOffset || 0;
                
                if (daysOffset === 0) {
                    return true;
                }
                
                const endDate = new Date(startDate);
                endDate.setDate(startDate.getDate() + daysOffset);
                
                const isStartDay = isSameDay(targetDate, startDate);
                const isEndDay = isSameDay(targetDate, endDate);
                
                if (isStartDay) {
                    return this.applyNoonRule(record);
                } else if (isEndDay) {
                    return this.applyEndDayRule(record);
                } else {
                    return true;
                }
            }

            static applyNoonRule(record) {
                const startTime = record.startTime || '09:00';
                const [startHour, startMinute] = startTime.split(':').map(Number);
                const startTimeInMinutes = startHour * 60 + startMinute;
                const noonInMinutes = 12 * 60;
                
                return startTimeInMinutes < noonInMinutes;
            }

            static applyEndDayRule(record) {
                const totalHours = (record.hours || 0) + (record.minutes || 0) / 60;
                const endTime = record.endTime || '18:00';
                const [endHour, endMinute] = endTime.split(':').map(Number);
                
                if (totalHours < 24) {
                    const startTime = record.startTime || '09:00';
                    const [startHour, startMinute] = startTime.split(':').map(Number);
                    const startTimeInMinutes = startHour * 60 + startMinute;
                    const noonInMinutes = 12 * 60;
                    
                    if (startTimeInMinutes >= noonInMinutes) {
                        return true;
                    }
                    
                    const hoursOnEndDay = endHour + endMinute / 60;
                    return hoursOnEndDay >= 24;
                }
                
                const hoursOnEndDay = endHour + endMinute / 60;
                return hoursOnEndDay >= 24;
            }

            static getTypeLabel(type) {
                const typeLabels = {
                    'normal': 'å‡ºå‹¤',
                    'rest': 'ä¼‘æ¯',
                    'leave': 'è¯·å‡',
                    'overtime': 'åŠ ç­',
                    'out_of_beijing': 'å‡ºäº¬',
                    'out_of_country': 'å‡ºå¢ƒ',
                    'paid_leave': 'å¸¦è–ªä¼‘å‡',
                    'onboarding': 'ä¸Šæˆ·',
                    'offboarding': 'ä¸‹æˆ·'
                };
                
                return typeLabels[type] || 'å‡ºå‹¤';
            }
        }

        // æµ‹è¯•ç”¨ä¾‹
        const testCases = [
            {
                name: 'åœºæ™¯1ï¼šè¯·å‡1å¤©ï¼Œä»3å·9ç‚¹åˆ°4å·9ç‚¹',
                record: {
                    date: '2024-03-03',
                    type: 'leave',
                    startTime: '09:00',
                    endTime: '09:00',
                    daysOffset: 1,
                    hours: 24,
                    minutes: 0
                },
                expectations: [
                    { date: '2024-03-03', expectedType: 'leave', reason: '9ç‚¹å¼€å§‹ï¼Œ12ç‚¹å‰ï¼Œåº”æ˜¾ç¤ºè¯·å‡' },
                    { date: '2024-03-04', expectedType: 'normal', reason: 'åªæœ‰9å°æ—¶ï¼Œä¸æ»¡24å°æ—¶ï¼Œåº”æ˜¾ç¤ºå‡ºå‹¤' }
                ]
            },
            {
                name: 'åœºæ™¯2ï¼šè¯·å‡3å¤©ï¼Œä»3å·9ç‚¹åˆ°6å·9ç‚¹',
                record: {
                    date: '2024-03-03',
                    type: 'leave',
                    startTime: '09:00',
                    endTime: '09:00',
                    daysOffset: 3,
                    hours: 72,
                    minutes: 0
                },
                expectations: [
                    { date: '2024-03-03', expectedType: 'leave', reason: 'å¼€å§‹æ—¥ï¼Œ9ç‚¹å¼€å§‹ï¼Œ12ç‚¹å‰' },
                    { date: '2024-03-04', expectedType: 'leave', reason: 'ä¸­é—´æ—¥ï¼Œæ•´å¤©24å°æ—¶' },
                    { date: '2024-03-05', expectedType: 'leave', reason: 'ä¸­é—´æ—¥ï¼Œæ•´å¤©24å°æ—¶' },
                    { date: '2024-03-06', expectedType: 'normal', reason: 'ç»“æŸæ—¥ï¼Œåªæœ‰9å°æ—¶ï¼Œä¸æ»¡24å°æ—¶' }
                ]
            },
            {
                name: 'åœºæ™¯3ï¼šå½“å¤©ä¸­åˆ12ç‚¹å‰å¼€å§‹çš„ä¼‘å‡',
                record: {
                    date: '2024-03-03',
                    type: 'rest',
                    startTime: '11:00',
                    endTime: '18:00',
                    daysOffset: 1,
                    hours: 31,
                    minutes: 0
                },
                expectations: [
                    { date: '2024-03-03', expectedType: 'rest', reason: '11ç‚¹å¼€å§‹ï¼Œ12ç‚¹å‰ï¼Œåº”æ˜¾ç¤ºä¼‘å‡' }
                ]
            },
            {
                name: 'åœºæ™¯4ï¼šå½“å¤©ä¸­åˆ12ç‚¹åå¼€å§‹çš„ä¼‘å‡',
                record: {
                    date: '2024-03-03',
                    type: 'rest',
                    startTime: '13:00',
                    endTime: '18:00',
                    daysOffset: 1,
                    hours: 29,
                    minutes: 0
                },
                expectations: [
                    { date: '2024-03-03', expectedType: 'normal', reason: '13ç‚¹å¼€å§‹ï¼Œ12ç‚¹åï¼Œå½“å¤©åº”æ˜¾ç¤ºå‡ºå‹¤' },
                    { date: '2024-03-04', expectedType: 'rest', reason: 'ç¬¬äºŒå¤©åº”æ˜¾ç¤ºä¼‘å‡' }
                ]
            },
            {
                name: 'åœºæ™¯5ï¼šæ•´ä¸ªå‡æœŸä¸æ»¡24å°æ—¶ï¼Œé¦–æ—¥æ™šäºä¸­åˆ12ç‚¹å¼€å§‹',
                record: {
                    date: '2024-03-03',
                    type: 'leave',
                    startTime: '14:00',
                    endTime: '10:00',
                    daysOffset: 1,
                    hours: 20,
                    minutes: 0
                },
                expectations: [
                    { date: '2024-03-03', expectedType: 'normal', reason: '14ç‚¹å¼€å§‹ï¼Œ12ç‚¹åï¼Œé¦–æ—¥åº”æ˜¾ç¤ºå‡ºå‹¤' },
                    { date: '2024-03-04', expectedType: 'leave', reason: 'çŸ­æœŸè€ƒå‹¤ç‰¹æ®Šå¤„ç†ï¼Œç¬¬äºŒå¤©åº”æ˜¾ç¤ºè¯·å‡' }
                ]
            },
            {
                name: 'åœºæ™¯6ï¼šä¸­åˆ12ç‚¹æ•´ç‚¹è¾¹ç•Œæµ‹è¯•',
                record: {
                    date: '2024-03-03',
                    type: 'leave',
                    startTime: '12:00',
                    endTime: '18:00',
                    daysOffset: 1,
                    hours: 30,
                    minutes: 0
                },
                expectations: [
                    { date: '2024-03-03', expectedType: 'normal', reason: '12ç‚¹æ•´ç‚¹æŒ‰12ç‚¹åå¤„ç†ï¼Œåº”æ˜¾ç¤ºå‡ºå‹¤' },
                    { date: '2024-03-04', expectedType: 'leave', reason: 'ç¬¬äºŒå¤©åº”æ˜¾ç¤ºè¯·å‡' }
                ]
            }
        ];

        // å…¨å±€å˜é‡
        window.testCases = testCases;
        window.AttendanceDisplayLogic = AttendanceDisplayLogic;

        // è¿è¡Œæ‰€æœ‰æµ‹è¯•
        window.runAllTests = function() {
            const resultsDiv = document.getElementById('test-results');
            const summaryDiv = document.getElementById('test-summary');
            const summaryContent = document.getElementById('summary-content');
            
            resultsDiv.innerHTML = '';
            
            let totalTests = 0;
            let passedTests = 0;
            let failedTests = [];

            testCases.forEach((testCase, index) => {
                const testDiv = document.createElement('div');
                testDiv.className = 'test-case';
                testDiv.innerHTML = `<h3>ğŸ“‹ æµ‹è¯• ${index + 1}: ${testCase.name}</h3>`;
                
                const recordInfo = document.createElement('div');
                recordInfo.innerHTML = `<strong>è®°å½•:</strong> ${testCase.record.date} ${testCase.record.startTime}-${testCase.record.endTime} (${testCase.record.daysOffset}å¤©) ${testCase.record.type}`;
                testDiv.appendChild(recordInfo);
                
                testCase.expectations.forEach((expectation) => {
                    totalTests++;
                    
                    try {
                        const result = AttendanceDisplayLogic.getDisplayTypeForDate(expectation.date, [testCase.record]);
                        const passed = result.type === expectation.expectedType;
                        
                        const resultDiv = document.createElement('div');
                        resultDiv.className = `test-result ${passed ? 'pass' : 'fail'}`;
                        
                        if (passed) {
                            passedTests++;
                            resultDiv.innerHTML = `âœ… ${expectation.date}: ${result.type} (${result.typeLabel}) - ${expectation.reason}`;
                        } else {
                            failedTests.push({
                                testCase: testCase.name,
                                date: expectation.date,
                                expected: expectation.expectedType,
                                actual: result.type,
                                reason: expectation.reason
                            });
                            resultDiv.innerHTML = `âŒ ${expectation.date}: æœŸæœ› ${expectation.expectedType}, å®é™… ${result.type} - ${expectation.reason}`;
                        }
                        
                        testDiv.appendChild(resultDiv);
                    } catch (error) {
                        totalTests++;
                        failedTests.push({
                            testCase: testCase.name,
                            date: expectation.date,
                            expected: expectation.expectedType,
                            actual: 'ERROR',
                            reason: expectation.reason,
                            error: error.message
                        });
                        
                        const resultDiv = document.createElement('div');
                        resultDiv.className = 'test-result fail';
                        resultDiv.innerHTML = `ğŸ’¥ ${expectation.date}: æ‰§è¡Œé”™è¯¯ - ${error.message}`;
                        testDiv.appendChild(resultDiv);
                    }
                });
                
                resultsDiv.appendChild(testDiv);
            });

            // æ˜¾ç¤ºæ€»ç»“
            const successRate = ((passedTests / totalTests) * 100).toFixed(1);
            summaryContent.innerHTML = `
                <div><strong>æ€»æµ‹è¯•æ•°:</strong> ${totalTests}</div>
                <div><strong>é€šè¿‡:</strong> ${passedTests}</div>
                <div><strong>å¤±è´¥:</strong> ${failedTests.length}</div>
                <div><strong>æˆåŠŸç‡:</strong> ${successRate}%</div>
                ${failedTests.length > 0 ? `
                    <h4>âŒ å¤±è´¥çš„æµ‹è¯•:</h4>
                    <ul>
                        ${failedTests.map((failure, index) => `
                            <li>${failure.testCase} - ${failure.date}: æœŸæœ› ${failure.expected}, å®é™… ${failure.actual}</li>
                        `).join('')}
                    </ul>
                ` : '<div style="color: green; font-weight: bold;">ğŸ‰ æ‰€æœ‰æµ‹è¯•éƒ½é€šè¿‡äº†ï¼</div>'}
            `;
            
            summaryDiv.style.display = 'block';
        };

        // æ¸…ç©ºç»“æœ
        window.clearResults = function() {
            document.getElementById('test-results').innerHTML = '';
            document.getElementById('test-summary').style.display = 'none';
            document.getElementById('test-data').style.display = 'none';
        };

        // æ˜¾ç¤ºæµ‹è¯•æ•°æ®
        window.showTestData = function() {
            const testDataDiv = document.getElementById('test-data');
            const testDataContent = document.getElementById('test-data-content');
            
            testDataContent.textContent = JSON.stringify(testCases, null, 2);
            testDataDiv.style.display = 'block';
        };
    </script>
</body>
</html>