# 需求文档: 历史合同关联最新模板

## 1. 功能目标

创建一个独立的脚本，用于回填历史合同数据。脚本需要为每一份历史合同（`contracts` 表中的记录）找到其对应的最新版本的合同模板（`contract_templates` 表中的记录），并将二者关联起来。

此操作旨在确保所有合同记录都与一个明确的、带版本的模板挂钩，以实现数据一致性和未来的可追溯性。

## 2. 用户场景

数据管理员或开发人员在部署了合同模板版本化功能后，需要对存量的、没有关联模板的历史合同数据进行一次性修复。

## 3. 关键约束与非功能性要求

### 3.1. 匹配逻辑
- **合同类型匹配**: 脚本必须根据 `contracts.type` 字段的值，去匹配 `contract_templates.contract_type` 字段值完全相同的模板。
- **最新版本定义**: 在所有匹配到的同类型模板中，“最新版本”被定义为 `version` 字段值最大的记录。如果存在多个相同最高版本的模板，应优先选择 `created_at` 最晚的那个。

### 3.2. 数据安全
- **幂等性**: 脚本必须是幂等的。对于已经有关联模板 (`template_id` 不为 NULL) 的合同，脚本应直接跳过，不做任何修改。
- **空跑模式 (Dry Run)**: 脚本必须提供一个 `--dry-run` 命令行参数。在此模式下，脚本应完整地执行所有查找和匹配逻辑，并打印出将要进行的每一项变更的详细信息（例如："将会把合同 [合同ID] 的 template_id 更新为 [模板ID]"），但**不能**将任何变更写入数据库。
- **事务性**: 在正式执行模式下，所有数据库更新操作应在一个事务中完成。如果中途发生任何错误，整个过程应完全回滚，以避免部分数据更新导致的不一致状态。但考虑到数据量可能很大，也可以按每个合同一个独立事务的方式处理，以便于断点续传。

### 3.3. 日志与输出
- **清晰的日志**: 脚本执行过程中应有清晰的日志输出。
  - **启动时**: 打印当前是“正式运行”还是“试运行”模式。
  - **过程中**:
    - 对于每个被处理的合同，打印其 ID 和类型。
    - 打印找到的最新模板的 ID、名称和版本。
    - 明确指出是“更新”、“跳过（已有关联）”还是“失败（未找到模板）”。
  - **结束后**: 输出一个总结报告，包含总共检查了多少合同、成功更新了多少、跳过了多少、失败了多少。

## 4. 范围
- **输入**:
  - 数据库中的 `contracts` 表。
  - 数据库中的 `contract_templates` 表。
- **输出**:
  - `contracts` 表中 `template_id` 字段被更新。
  - 控制台日志输出。
- **不包含**:
  - 本脚本不负责创建或修改任何合同模板。
  - 本脚本不负责修改合同本身的其他任何字段。
