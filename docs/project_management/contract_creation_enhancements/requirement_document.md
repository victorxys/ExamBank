# 需求文档: 合同创建与签署流程优化

**版本:** 1.0
**日期:** 2025-11-06

## 1. 概述

本项目旨在优化“创建正式/虚拟合同”及后续的“客户签署”流程，提升管理员操作效率和数据完整性。核心是通过数据自动填充、API功能增强和客户信息后补机制，实现更流畅、智能的合同管理体验。

## 2. 功能需求

### 2.1. 后端API增强：员工搜索返回最新薪酬

-   **目标**: 在前端选择员工时，能立刻带出其当前薪酬，避免手动查询。
-   **涉及API**: 需要修改用于员工搜索的API（例如 `/api/users/search`，需确认具体接口）。
-   **需求详情**:
    -   当API根据关键词搜索并返回员工列表时，每个员工对象中必须新增一个 `latest_salary` 字段。
    -   `latest_salary` 的值应为该员工在 `employee_salary_history` 表中，`effective_date` (生效日期) 最晚的一条记录的 `base_salary` 值。
    -   如果一个员工没有任何薪酬历史，`latest_salary` 字段可以返回 `null` 或 `0`。
    -   此修改必须保持向后兼容，不影响API的其他功能。

### 2.2. 前端优化：创建合同时自动填充信息

-   **目标**: 减少管理员在创建合同过程中的重复数据录入工作。
-   **涉及页面**: “创建正式合同”模态框、“创建虚拟合同”模态框。
-   **需求详情**:
    -   **客户选择**: 当管理员在客户选择框中选中一个已存在的客户后，系统应自动将该客户的“身份证号”和“地址”填充到表单中对应的输入框。
    -   **员工选择**: 当管理员在员工选择框中选中一个已存在的员工后，系统应自动将该员工的“身份证号”、“地址”和“最新薪酬” (`latest_salary`) 填充到表单对应的输入框。
    -   **数据源**: 填充所需的数据（身份证、地址、薪酬）应来自增强后的搜索API的返回结果。
    -   **可编辑性**: 自动填充后，所有输入框应保持可编辑状态，允许管理员在必要时进行修改。

### 2.3. 客户信息后补与回写

-   **目标**: 解决在不完全掌握客户信息的情况下也能发起合同签署流程的问题，并允许客户自行完善信息，确保数据最终完整。
-   **涉及流程**: 合同创建 -> 客户签署 -> 数据回写。
-   **需求详情**:
    -   **合同创建**: 系统应允许在创建正式合同时，客户的“身份证号”、“地址”等非必填字段为空。
    -   **合同签署页面**:
        -   当客户通过唯一的签署链接打开页面时，如果系统检测到该合同关联的客户信息不完整（例如，身份证号或地址为空），页面上应显示一个表单，让客户填写这些信息。
        -   这些输入框应清晰地标记为必填项。
    -   **数据提交与回写**:
        -   客户在填写完信息并点击“确认签署”按钮后，前端需将填写的个人信息连同签名数据一同提交到后端。
        -   后端需要一个**新的API接口**来处理这个包含额外客户数据的签署请求。
        -   该接口在保存签名的同时，必须根据提交的数据更新 `Customer` 表中对应的客户记录。
        -   **安全性**: 更新操作必须是安全的。只应更新当前合同所关联的客户，且最好只更新原本为空的字段，避免覆盖已有数据。

## 3. 非功能性需求

-   **性能**: 员工搜索API的性能不应因增加薪酬查询而显著下降。应使用高效的SQL查询。
-   **安全性**: 客户信息回写接口必须严格校验权限，确保只有持有特定合同签署令牌的用户才能更新对应的客户信息。
-   **用户体验**: 自动填充过程应流畅无延迟。客户信息补填表单应简洁明了。
