# 续约账单合并重构 - 设计检查清单

### 1. 数据模型

- **检查点**: `FinancialAdjustment` 模型中是否存在一个字段（例如 `linked_bill_id` 或 `meta` JSON 字段中的一个key）来存储关联账单的ID？
- **如何检查**: 查看 `backend/models.py` 中的 `FinancialAdjustment` 类定义。
- **检查结果**: [待填充]

### 2. 后端服务 (`BillMergeService`)

- **检查点**: 整个 `merge_bills` 函数是否被 `@db.session.atomic` 或等效的事务装饰器包裹？
- **如何检查**: 审查 `backend/services/bill_merge_service.py` 中的代码。
- **检查结果**: [待填充]

- **检查点**: 服务是否能正确处理幂等性？例如，如果对同一组账单调用两次合并接口，第二次调用是否会报错或被安全地忽略，而不是重复创建调整项？
- **如何检查**: 审查服务逻辑，应在开始时检查目标账单是否已存在由本次合并产生的转移调整项。
- **检查结果**: [待填充]

- **检查点**: 调整项的计算逻辑是否正确？
- **如何检查**: 单元测试。具体场景包括：
    1.  源客户账单应收款 > 0 (欠款) -> 源创建 `DECREASE`，目标创建 `INCREASE`。
    2.  源客户账单应收款 < 0 (退款) -> 源创建 `INCREASE`，目标创建 `DECREASE`。
    3.  源员工工资单应发 > 0 -> 源创建 `DECREASE`，目标创建 `INCREASE`。
    4.  源账单包含 `EMPLOYEE_COMMISSION` -> 源创建 `OFFSET`，目标重建 `COMMISSION`。
- **检查结果**: [待填充]

- **检查点**: 自动生成的调整项 (`COMPANY_PAID_SALARY`, `DEPOSIT_PAID_SALARY`) 是否在计算冲抵金额**之前**被正确删除？
- **如何检查**: 审查代码执行顺序，并编写一个包含这些调整项的集成测试。
- **检查结果**: [待填充]

### 3. API

- **检查点**: `GET /api/bill-merges/preview` 接口是否**绝对没有**数据库写入操作？
- **如何检查**: 代码审查，确认该接口函数中没有 `db.session.add()` 或 `db.session.commit()` 等调用。
- **检查结果**: [待填充]

- **检查点**: `POST /api/bill-merges` 接口是否对传入的 `source_bill_id` 和 `target_bill_id` 进行了权限和有效性验证？（例如，确保这两个账单确实属于同一个续约流程）。
- **如何检查**: 审查接口代码和相关服务逻辑。
- **检查结果**: [待填充]

### 4. 前端 (`MergePreviewModal.jsx`)

- **检查点**: 预览模态框是否能正确解析 `preview` 接口返回的数据，并分“客户账单”和“员工工资单”两个板块清晰展示？
- **如何检查**: 联调测试。使用一个模拟的 `preview` 接口返回不同结构的JSON，观察前端渲染是否符合预期。
- **检查结果**: [待填充]

- **检查点**: “确认”按钮在数据加载或提交过程中是否被正确禁用，以防止重复提交？
- **如何检查**: UI交互测试。
- **检查结果**: [待填充]

- **检查点**: 财务调整项的跳转链接功能是否正常工作？
- **如何检查**: 在UI上点击一个带链接的调整项，确认页面能正确跳转到关联账单。
- **检查结果**: [待填充]
