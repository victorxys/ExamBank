# 月嫂合同续约与延长功能 - Todo List

## Phase 1: 需求分析与设计 ✓
- [x] 创建需求文档
- [ ] 创建设计检查清单
- [ ] 创建测试用例文档
- [ ] 评审需求文档

## Phase 2: 续约功能优化

### 2.1 后端开发
- [ ] 修改 `backend/services/contract_service.py`
    - [ ] 更新 `renew_contract` 方法
    - [ ] 添加月嫂合同自动确认上户日期逻辑
    - [ ] 添加自动触发账单生成逻辑
- [ ] 修改 `backend/api/contract_api.py`
    - [ ] 更新 `renew_contract` 端点响应
    - [ ] 添加账单生成状态返回
- [ ] 添加单元测试
    - [ ] 测试月嫂合同续约自动确认上户日期
    - [ ] 测试账单自动生成
    - [ ] 测试其他类型合同续约不受影响

### 2.2 前端开发
- [ ] 修改续约确认对话框
    - [ ] 添加月嫂合同特殊提示
    - [ ] 显示账单生成状态
- [ ] 更新续约成功提示
    - [ ] 提示实际上户日期已确认
    - [ ] 提示账单已生成

### 2.3 测试验证
- [ ] 手动测试月嫂合同续约流程
- [ ] 验证账单生成正确
- [ ] 验证其他合同类型不受影响

## Phase 3: 延长功能开发

### 3.1 后端开发
- [ ] 创建 `backend/services/contract_service.py::extend_contract`
    - [ ] 实现合同延长逻辑
    - [ ] 添加状态验证
    - [ ] 添加日期验证
- [ ] 创建 `backend/services/billing_service.py::recalculate_bills_for_extension`
    - [ ] 实现账单重新计算逻辑
    - [ ] 处理当前周期内延长
    - [ ] 处理跨周期延长
- [ ] 创建 API 端点 `PATCH /api/contracts/<id>/extend`
    - [ ] 实现请求处理
    - [ ] 添加权限验证
    - [ ] 返回延长结果和账单变更信息
- [ ] 添加单元测试
    - [ ] 测试延长 active 合同
    - [ ] 测试延长非 active 合同（应失败）
    - [ ] 测试账单重新计算（当前周期）
    - [ ] 测试账单重新计算（跨周期）

### 3.2 前端开发
- [ ] 在合同详情页添加"延长合同"按钮
    - [ ] 只对 active 状态的月嫂合同显示
- [ ] 创建延长合同对话框
    - [ ] 日期选择器
    - [ ] 显示当前结束日期
    - [ ] 显示延长说明
- [ ] 处理延长结果
    - [ ] 显示成功提示
    - [ ] 显示账单变更信息
    - [ ] 刷新合同详情

### 3.3 测试验证
- [ ] 手动测试延长功能
- [ ] 验证账单重新计算正确
- [ ] 验证权限控制

## Phase 4: 集成测试
- [ ] 端到端测试续约流程
- [ ] 端到端测试延长流程
- [ ] 回归测试现有合同功能
- [ ] 性能测试（如果需要）

## Phase 5: 文档与部署
- [ ] 更新 API 文档
- [ ] 更新用户手册
- [ ] 创建部署指南
- [ ] 准备生产环境发布

## 可选功能（低优先级）
- [ ] 延长历史记录表
- [ ] 延长操作审计日志
- [ ] 批量延长功能
- [ ] 合同到期自动提醒
