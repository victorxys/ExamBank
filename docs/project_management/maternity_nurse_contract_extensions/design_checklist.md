# 月嫂合同续约与延长功能 - 设计检查清单

## 1. 需求理解 ✓

### 1.1 续约功能
- [x] **问题理解**：月嫂合同续约时，原合同可能未确认上户日期，导致无法找到前序合同账单
- [x] **解决方案**：续约时自动确认实际上户日期（等于新合同开始日期）并生成账单
- [x] **业务规则**：
    - [x] `actual_start_date` = `start_date`
    - [x] 自动触发账单生成
    - [x] 合同状态设为 `active`

### 1.2 延长功能
- [x] **问题理解**：系统不支持直接延长合同结束日期
- [x] **解决方案**：新增延长功能，允许修改合同结束日期并重新计算账单
- [x] **业务规则**：
    - [x] 只能延长 `active` 状态的合同
    - [x] 新结束日期必须晚于当前结束日期
    - [x] 自动重新计算账单

---

## 2. 数据模型检查

### 2.1 现有字段使用
- [ ] **`actual_start_date`**：续约时是否正确设置？
- [ ] **`end_date`**：延长时是否正确更新？
- [ ] **`status`**：续约后是否正确设为 `active`？
- [ ] **`previous_contract_id`**：续约时是否正确关联？

### 2.2 数据完整性
- [ ] 续约后的合同是否包含所有必要字段？
- [ ] 延长后的合同数据是否一致？
- [ ] 是否需要新增字段记录延长历史？（可选）

---

## 3. 业务逻辑检查

### 3.1 续约逻辑
- [ ] **自动确认上户日期**：
    - [ ] 只对月嫂合同生效？
    - [ ] 其他合同类型不受影响？
- [ ] **账单生成**：
    - [ ] 是否使用与 `confirm_actual_start_date` 相同的逻辑？
    - [ ] 是否避免重复生成账单？
- [ ] **合同状态**：
    - [ ] 续约后状态是否为 `active`？
    - [ ] 原合同状态是否正确更新？

### 3.2 延长逻辑
- [ ] **状态验证**：
    - [ ] 是否只允许延长 `active` 状态的合同？
    - [ ] 其他状态是否正确拒绝？
- [ ] **日期验证**：
    - [ ] 新结束日期是否必须晚于当前结束日期？
    - [ ] 是否验证日期格式？
- [ ] **账单重新计算**：
    - [ ] 当前周期内延长：是否更新最后一个账单？
    - [ ] 跨周期延长：是否生成新账单？
    - [ ] 账单金额是否正确计算？

---

## 4. API 设计检查

### 4.1 续约 API
- [ ] **端点**：`POST /api/contracts/<id>/renew`
- [ ] **请求体**：是否包含所有必要参数？
- [ ] **响应体**：
    - [ ] 是否返回新合同信息？
    - [ ] 是否返回账单生成状态？
- [ ] **错误处理**：
    - [ ] 合同不存在
    - [ ] 合同状态不允许续约
    - [ ] 参数验证失败

### 4.2 延长 API
- [ ] **端点**：`PATCH /api/contracts/<id>/extend`
- [ ] **请求体**：
    ```json
    {
      "new_end_date": "2025-12-31"
    }
    ```
- [ ] **响应体**：
    ```json
    {
      "message": "合同延长成功",
      "contract": { ... },
      "bills_updated": 1,
      "new_bills_generated": 2
    }
    ```
- [ ] **错误处理**：
    - [ ] 合同不存在
    - [ ] 合同状态不是 `active`
    - [ ] 新结束日期无效
    - [ ] 权限不足

---

## 5. 服务层检查

### 5.1 `contract_service.py`
- [ ] **`renew_contract` 方法**：
    - [ ] 是否添加了月嫂合同特殊处理？
    - [ ] 是否调用账单生成任务？
    - [ ] 是否正确设置 `actual_start_date`？
- [ ] **`extend_contract` 方法**（新增）：
    - [ ] 是否验证合同状态？
    - [ ] 是否验证新结束日期？
    - [ ] 是否调用账单重新计算？

### 5.2 `billing_service.py`
- [ ] **`recalculate_bills_for_extension` 方法**（新增）：
    - [ ] 是否正确找到最后一个账单？
    - [ ] 是否正确判断是否需要生成新账单？
    - [ ] 是否正确计算账单金额？
    - [ ] 是否正确更新账单日期？

---

## 6. 前端界面检查

### 6.1 续约界面
- [ ] **续约确认对话框**：
    - [ ] 是否显示月嫂合同特殊提示？
    - [ ] 提示内容是否清晰？
- [ ] **续约成功提示**：
    - [ ] 是否提示实际上户日期已确认？
    - [ ] 是否提示账单已生成？

### 6.2 延长界面
- [ ] **延长按钮**：
    - [ ] 是否只对 `active` 状态的月嫂合同显示？
    - [ ] 按钮位置是否合理？
- [ ] **延长对话框**：
    - [ ] 是否显示当前结束日期？
    - [ ] 日期选择器是否限制最小日期？
    - [ ] 说明文字是否清晰？
- [ ] **延长成功提示**：
    - [ ] 是否显示账单变更信息？
    - [ ] 是否刷新合同详情？

---

## 7. 测试覆盖检查

### 7.1 单元测试
- [ ] **续约功能**：
    - [ ] 月嫂合同续约自动确认上户日期
    - [ ] 月嫂合同续约自动生成账单
    - [ ] 其他合同类型续约不受影响
- [ ] **延长功能**：
    - [ ] 延长 `active` 合同成功
    - [ ] 延长非 `active` 合同失败
    - [ ] 账单重新计算（当前周期）
    - [ ] 账单重新计算（跨周期）
    - [ ] 新结束日期验证

### 7.2 集成测试
- [ ] **续约流程**：
    - [ ] 端到端测试续约流程
    - [ ] 验证账单生成
- [ ] **延长流程**：
    - [ ] 端到端测试延长流程
    - [ ] 验证账单更新

### 7.3 回归测试
- [ ] 现有合同功能不受影响
- [ ] 其他合同类型续约功能正常

---

## 8. 安全与权限检查

### 8.1 权限控制
- [ ] **续约操作**：
    - [ ] 是否需要特定权限？
    - [ ] 是否验证用户身份？
- [ ] **延长操作**：
    - [ ] 是否需要特定权限？
    - [ ] 是否验证用户身份？

### 8.2 数据验证
- [ ] 所有输入参数是否验证？
- [ ] 是否防止 SQL 注入？
- [ ] 是否防止 XSS 攻击？

---

## 9. 性能检查

### 9.1 数据库查询
- [ ] 续约操作是否高效？
- [ ] 延长操作是否高效？
- [ ] 账单重新计算是否高效？

### 9.2 并发处理
- [ ] 是否处理并发续约？
- [ ] 是否处理并发延长？
- [ ] 是否使用事务保证一致性？

---

## 10. 文档检查

### 10.1 代码文档
- [ ] 所有新方法是否有文档字符串？
- [ ] 复杂逻辑是否有注释？

### 10.2 API 文档
- [ ] 是否更新 API 文档？
- [ ] 是否包含请求/响应示例？

### 10.3 用户文档
- [ ] 是否更新用户手册？
- [ ] 是否包含操作步骤？

---

## 11. 部署检查

### 11.1 数据库迁移
- [ ] 是否需要数据库迁移？
- [ ] 迁移脚本是否测试？

### 11.2 向后兼容
- [ ] 现有数据是否兼容？
- [ ] 现有 API 是否兼容？

### 11.3 部署步骤
- [ ] 是否创建部署指南？
- [ ] 是否定义回滚方案？

---

## 12. 验收标准

### 12.1 续约功能
- [ ] 月嫂合同续约时自动设置 `actual_start_date`
- [ ] 续约后自动生成账单
- [ ] 续约合同状态为 `active`
- [ ] 前端显示续约成功提示

### 12.2 延长功能
- [ ] 可以成功延长 `active` 状态的合同
- [ ] 延长后账单正确更新或生成
- [ ] 不能延长非 `active` 状态的合同
- [ ] 前端显示延长成功提示及账单变更信息

---

## 检查清单总结

- **需求理解**：2/2 ✓
- **数据模型**：0/4
- **业务逻辑**：0/9
- **API 设计**：0/8
- **服务层**：0/6
- **前端界面**：0/9
- **测试覆盖**：0/10
- **安全权限**：0/5
- **性能**：0/4
- **文档**：0/5
- **部署**：0/5
- **验收标准**：0/6

**总进度**：2/73 (2.7%)
