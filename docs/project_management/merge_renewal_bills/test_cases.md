# 测试用例：续约账单合并功能

### 测试用例 1: 成功路径 (Happy Path)

**测试目的:**
验证在标准月中续约场景下，账单合并功能是否能正确执行所有操作，并得到预期的财务结果。

**涉及模块/文件:**
- API: `POST /api/bill-merges`
- Service: `BillMergeService`
- Models: `FinancialAdjustment`, `CustomerBill`, `EmployeeBill`

**输入:**
- **合同A**: 结束日期 `2025-09-10`，最后一期账单包含 5000元 保证金退款和 2000元 员工工资。
- **合同B**: 开始日期 `2025-09-11`，与合同A为同一客户和员工。
- 用户在预览后点击“确认合并”。

**期望输出:**
- 合同A的最后一期客户账单“应收总额”变为0。
- 合同A的最后一期员工账单“应发总额”变为0。
- 合同B的首期客户账单中增加一笔5000元的财务调整（来自保证金转移）。
- 合同B的首期员工账单中增加一笔2000元的财务调整（来自工资转移）。
- 合同A的账单中存在明确的冲抵和核销记录，并包含跳转链接。
- 任何 `COMPANY_PAID_SALARY` 或 `DEPOSIT_PAID_SALARY` 调整项被删除。

**实际输出 & 测试结果:**
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果:** [待填充]

---

### 测试用例 2: 无续约合同

**测试目的:**
验证当不存在符合条件的续约合同时，前端不会显示“合并”按钮。

**涉及模块/文件:**
- API: `GET /api/contracts/<contract_id>/successor`
- Frontend: `BillingDashboard.jsx`

**输入:**
- **合同A**: 结束日期 `2025-09-10`。
- 不存在与客户A相同客户和员工的，在2025年9月开始的续约合同。

**期望输出:**
- `API-1` 返回 `null` 或 `204 No Content`。
- 前端页面上不渲染“合并至续约账单”按钮。

**实际输出 & 测试结果:**
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果:** [待填充]

---

### 测试用例 3: 续约合同在不同月份

**测试目的:**
验证当续约合同在不同月份时，系统不会将其识别为可合并的合同。

**涉及模块/文件:**
- API: `GET /api/contracts/<contract_id>/successor`

**输入:**
- **合同A**: 结束日期 `2025-09-10`。
- **合同B**: 开始日期 `2025-10-01`。

**期望输出:**
- `API-1` 返回 `null` 或 `204 No Content`。
- 前端不显示“合并”按钮。

**实际输出 & 测试结果:**
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果:** [待填充]

---

### 测试用例 4: 无保证金退款

**测试目的:**
验证即使没有保证金退款，合并流程依然能正确处理工资的转移。

**涉及模块/文件:**
- API: `POST /api/bill-merges`
- Service: `BillMergeService`

**输入:**
- **合同A**: 最后一期账单保证金退款为0，但有2000元员工工资。
- **合同B**: 续约合同。

**期望输出:**
- 保证金转移相关的操作被跳过或处理为0金额。
- 员工工资部分被正确转移和核销。
- 整个流程成功完成。

**实际输出 & 测试结果:**
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果:** [待填充]

---

### 测试用例 5: API幂等性测试

**测试目的:**
验证重复调用合并API不会导致重复的财务操作。

**涉及模块/文件:**
- API: `POST /api/bill-merges`
- Service: `BillMergeService`

**输入:**
- 成功执行一次合并操作后，立即用相同的参数再次调用 `POST /api/bill-merges`。

**期望输出:**
- 第二次调用应直接返回成功，或者返回一个特定的状态码/消息，指明“操作已被处理”。
- 数据库中的财务调整项数量没有增加。
- 合同B账单中的总金额没有被重复累加。

**实际输出 & 测试结果:**
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果:** [待填充]

---

### 测试用例 6: API预览功能 (`dry_run`)

**测试目的:**
验证使用 `dry_run=true` 参数调用合并API时，只返回预览数据而不修改数据库。

**涉及模块/文件:**
- API: `POST /api/bill-merges`

**输入:**
- 调用 `POST /api/bill-merges`，请求体中包含 `dry_run: true`。

**期望输出:**
- API返回一个包含所有预览信息的JSON对象（如转移金额等）。
- 数据库中的任何数据都没有发生变化。

**实际输出 & 测试结果:**
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果:** [待填充]
