# 设计检查清单 (Design Checklist)

## 第一层：数据结构分析

- **检查项**: `FinancialAdjustment` 模型是否支持存储跳转链接？
    - **如何检查**: 查看 `backend/models.py` 中的 `FinancialAdjustment` 模型定义。
    - **检查结果 (模拟)**: `FinancialAdjustment` 有一个 `remarks` 字段（类型为 `Text`）。我们可以将链接作为文本存储在 `remarks` 中，并由前端解析。例如，格式为 `“备注文本 [跳转到账单B](<link>)”`。**结论：通过。** 当前结构已足够，无需修改模型。

## 第二层：特殊情况识别

- **检查项**: 如果没有续约合同，会发生什么？
    - **如何检查**: 检查 `API-1` (`GET /api/contracts/<contract_id>/successor`) 的逻辑。
    - **检查结果 (模拟)**: API将返回空值。前端逻辑在收到空值后，不会显示“合并”按钮。**结论：通过。** 这是预期的正常流程。

- **检查项**: 如果续约合同不在同一个月开始，会发生什么？
    - **如何检查**: 再次检查 `API-1` 的查询逻辑。
    - **检查结果 (模拟)**: 根据 `requirement_document.md` 的严格定义，查询条件包含“开始年份和月份必须相同”。因此，不在此场景内的合同从一开始就会被过滤掉。**结论：通过。**

- **检查项**: 如果合同A的最后一期账单没有“保证金退款”怎么办？
    - **如何检查**: 检查 `API-2` (预览) 和 `API-3` (执行) 的核心逻辑。
    - **检查结果 (模拟)**: 预览API将显示保证金转移金额为0。执行API在计算转移金额时，结果也为0。操作应能正常完成，不会因此失败。**结论：通过。**

- **检查项**: 如果合同A的最后一期账单中，员工工资为0怎么办？
    - **如何检查**: 同样检查 `API-2` 和 `API-3` 的逻辑。
    - **检查结果 (模拟)**: 预览API将显示工资转移金额为0。执行API在创建 `EMPLOYEE_DECREASE` 和 `EMPLOYEE_CLIENT_PAYMENT` 调整项时，金额将为0。这虽然是无用操作，但不应导致错误。**结论：通过。**

## 第三层：复杂度审查

- **检查项**: 是否需要一个新的 `BillMergeService`？
    - **如何检查**: 评估合并逻辑与现有 `BillingService` 的关联性。
    - **检查结果 (模拟)**: 合并操作是一个独立的、高度专用的业务流程，它协调多个账单和合同。将其放入 `BillingService` 会使该服务变得臃肿。创建一个新的 `BillMergeService` 能让职责更清晰，符合单一职责原则。**结论：决策合理，保持创建新服务。**

- **检查项**: 三个独立的API是否是最佳选择？
    - **如何检查**: 评估前端交互流程与API的对应关系。
    - **检查结果 (模拟)**:
        1.  `API-1 (检测)`: 必须独立，因为它是在页面加载时被动调用的。
        2.  `API-2 (预览)` 和 `API-3 (执行)`: 可以合并为一个API `POST /api/bill-merges`，通过一个 `dry_run=true` 参数来区分预览和执行。这能减少API的数量。
        - **最终决策**: 采用 `dry_run` 方案。将 `API-2` 和 `API-3` 合并为一个 `POST /api/bill-merges` 端点。`dry_run=true` 时返回预览数据，`dry_run=false` 时执行操作。这更优雅。**结论：优化设计。**

## 第四层：破坏性分析

- **检查项**: 如何防止用户重复点击“确认合并”按钮？
    - **如何检查**: 审查前端状态管理和后端API的幂等性设计。
    - **检查结果 (模拟)**:
        - **前端**: 在点击“确认合并”后，应立即禁用该按钮，并显示加载状态。
        - **后端**: 在 `BillMergeService` 中，操作开始前应检查合同A的最后一期账单是否已被合并过（例如，通过检查是否存在特定的冲抵调整项）。如果已合并，则直接返回成功或特定提示，而不是重复执行。**结论：必须实现。**

## 第五层：实用性验证

- **检查项**: 预览信息是否足够用户做出判断？
    - **如何检查**: 对照 `requirement_document.md` 中对预览功能的要求。
    - **检查结果 (模拟)**: 需求中定义的预览信息（源/目标合同、转移金额、最终结果预览）是充分的。它准确地告诉了用户“什么将会发生”。**结论：通过。**
