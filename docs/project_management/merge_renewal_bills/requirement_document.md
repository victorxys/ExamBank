# 需求文档：非月签合同续约账单合并

## 1. 背景与问题

当前业务流程中，非自动月签合同在续约时遇到了资金和责任转移的难题。当一个合同（合同A）在月中结束，而其续约合同（合同B）紧接着开始时，会导致员工工资和客户费用被分割到两个月的账单中，处理流程非常繁琐且容易出错。

**具体示例:**

*   **合同A**: 服务期 `2024-09-10` ~ `2025-09-10`。在2025年9月的账单中，包含10天的员工工资，这笔费用按常规会从客户预付的保证金中抵扣。
*   **合同B**: 作为A的续约合同，服务期 `2025-09-11` ~ `2026-09-11`。在2025年9月的账单中，需要支付剩余20天的员工工资。

**核心问题:** 客户A的保证金在逻辑上会自动转移至合同B，导致合同A的最后一份账单实际上没有资金来支付那10天的员工工资，必须将这部分工资的支付责任转移到合同B的第一份账单中。

## 2. 核心目标

设计并实现一个“续约账单合并”功能，以简化非自动续签合同在切换期间的财务处理流程。最终目标是让旧合同的最后一期账单清零，所有待结算款项都合并到新合同的第一期账单中，实现平滑过渡。

## 3. 功能需求

### 3.1. 触发条件

在为一份非自动月签合同生成**最后一期**客户账单时，系统必须自动检测是否存在满足以下**所有**条件的续约合同（合同B）：

*   **同一客户**
*   **同一员工**
*   **续约合同B的开始日期** >= **当前合同A的结束日期**
*   续约合同B的**开始年份和月份** 与 当前合同A的**结束年份和月份** 完全相同。

如果存在这样的续约合同，则在合同A的最后一期账单页面上，应显示一个明确的 **“合并至续约账单”** 按钮。

### 3.2. “合并账单”操作流程

当用户点击“合并至续约账单”按钮后，系统应首先展示一个**预览界面**。

#### 3.2.1. 合并预览

预览界面必须清晰地展示以下信息：

*   **源合同与账单**: 合同A的基本信息及其最后一期账单的ID。
*   **目标合同与账单**: 续约合同B的基本信息及其首期账单的ID。
*   **将要转移的款项**:
    *   从合同A转移到合同B的**保证金**金额。
    *   从合同A转移到合同B的**员工工资**金额。
*   **最终结果预览**:
    *   合同A最终账单的关键财务数据（应收、应付）将变为0。
    *   合同B首期账单合并后的关键财务数据。

用户在预览界面确认无误后，点击“确认合并”按钮，系统才开始执行实际的后台操作。

#### 3.2.2. 后台执行操作

用户确认后，系统应在后台执行以下原子操作：

1.  **保证金转移与冲抵**:
    *   将合同A最后一期账单中的“保证金退款”金额，自动转移到合同B的首期客户账单中。
    *   在合同A的账单中，生成一笔相应的冲抵财务调整项，以确保其账务平衡。此操作的内部逻辑应与现有的手动“转移保证金”操作保持一致。

2.  **员工工资转移与核销**:
    *   **从源头（合同A）核销**:
        *   在合同A的最后一期**员工工资单**中，增加一笔财务调整项（类型: `EMPLOYEE_DECREASE`）。
        *   金额应等于该工资单中的“应发总额”。
        *   备注：“转移到新合同中合并支付员工工资”，并提供一个到合同B首期账单的跳转链接。
    *   **在目标（合同B）接收**:
        *   在合同B的首期**员工工资单**中，增加一笔财务调整项（类型: `EMPLOYEE_CLIENT_PAYMENT`）。
        *   金额等于从合同A转移过来的“代付总额”。
        *   备注：“转移支付原合同剩余的员工工资”，并提供一个到合同A最后一期账单的跳转链接。

3.  **清理旧有代付项**:
    *   检查合同A的最后一期账单，如果存在任何由系统自动生成的公司代付或保证金代付工资项（如 `COMPANY_PAID_SALARY` 或 `DEPOSIT_PAID_SALARY`），必须将其**删除**。这是因为支付责任已经完全转移到新合同。

### 3.3. 最终状态要求

操作完成后，必须达到以下状态：

*   **合同A的最后一期客户账单**:
    *   “应收总额”必须为 **0**。
*   **合同A的最后一期员工工资单**:
    *   “应发总额”必须为 **0**。
*   **合同B的首期账单**:
    *   客户账单 和 员工工资单 完整包含了整个月份的费用和工资，财务关系清晰。

## 4. 非功能性需求

*   **数据一致性**: 所有操作必须在一个事务中完成，确保数据的完整性和一致性。如果任何一步失败，整个操作必须回滚。
*   **可追溯性**: 所有的转移操作都必须有清晰的记录和备注，方便财务人员对账。链接跳转功能是强制性要求。
*   **权限控制**: “合并账单”按钮的操作权限应与现有的高级财务操作权限保持一致。

## 5. 验收标准

*   成功在一个月中存在续约场景的合同上，执行“合并账单”操作。
*   检查合同A的最后一期账单（客户和员工）是否都已清零。
*   检查合同B的首期账单是否正确合并了所有费用和工资。
*   检查所有财务调整项的金额、类型、备注和链接是否都正确无误。
*   验证旧的代付项（如 `COMPANY_PAID_SALARY`）是否已被成功删除。
