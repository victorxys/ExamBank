# 替班管理费需求规格说明书

**版本:** 2.0
**日期:** 2025年10月21日

## 1. 概述

本文档旨在明确“替班管理费”功能的需求、核心逻辑和计算规则。该功能用于处理在特定情况下，替班服务超出了主合同有效保障期限时所需收取的管理费用。

## 2. 背景

在标准业务流程中，合同内的替班服务通常不额外收取管理费。然而，当替班行为发生在合同生效范围之外时，会产生服务成本。为覆盖这部分成本，需要引入一套明确的计费规则。

## 3. 核心收费原则

**只对替班服务周期中，超出合同最终有效日期的那一部分收取管理费。**

此原则适用于所有触发场景，确保了计费逻辑的一致性。

## 4. 触发场景

以下两种业务操作会触发替班管理费的计算逻辑：

### 4.1. 合同结束后追加替班

- **描述:** 当一份主合同已经正常结束或被终止后，用户为该合同关联一笔新的替班记录。
- **处理:** 系统需要检查该替班记录的周期，并根据核心原则计算是否产生管理费。

### 4.2. 合同提前终止

- **描述:** 用户提前终止一份正在生效的主合同。
- **处理:** 在执行终止操作时，系统必须检查该合同下所有已存在的替班记录。如果替班记录的结束日期晚于合同新的终止日期，系统需要为超出部分计算管理费。

## 5. 计费逻辑

### 5.1. 计费天数计算公式

所有场景下的计费天数均使用以下统一公式进行计算：

**计费天数 = `替班记录结束日期` - `max(合同最终有效日期, 替班记录开始日期)`**

- **`合同最终有效日期`**: 优先取合同的“终止日期” (`termination_date`)；如果不存在，则取“合同结束日期” (`end_date`)。
- **`替班记录开始日期`**: 替班服务的起始日期。
- **`替班记录结束日期`**: 替班服务的结束日期。
- **`max()`**: 取两个日期中的较晚者。

如果计算出的计费天数大于0，则产生替班管理费。

### 5.2. 费用计算

总费用根据计费天数和替班人员的级别对应的费率计算：

**总管理费 = `计费天数` × `替班人员对应级别的每日管理费`**

*注：每日管理费的具体费率需从系统配置或人员档案中获取。*

### 5.3. 特殊处理规则

- **自动续签合同**: 如果一份合同是“自动续签”类型，并且没有设置“终止日期”，则该合同被视为持续有效。在此情况下，所有关联的替班记录都被认为在合同期内，**不产生**替班管理费。

## 6. 系统影响范围（设计变更）

- **替班记录模块 (`SubstituteRecord`)**: 
  - **创建/更新替班**: 在创建或更新育儿嫂替班记录时，需调用费用计算逻辑。如果计算出的“合同外管理费”大于0，且 `substitute_management_fee` 字段为空或为0，则将计算结果更新到该字段。
- **合同管理模块**: 
  - **终止合同**: 终止合同时，需遍历所有关联的育儿嫂替班记录，重新计算“合同外管理费”，并更新对应 `SubstituteRecord` 的 `substitute_management_fee` 字段。
- **账单与结算模块**: 
  - **计费引擎 (`BillingEngine`)**: 需要扩展 `_calculate_substitute_details` 函数。当为育儿嫂替班生成专属账单时，除了计算基础劳务费，还必须读取 `SubstituteRecord` 上的 `substitute_management_fee` 值，并将其作为“管理费”计入账单总额。
  - **财务调整 (`FinancialAdjustment`)**: 此类费用**不再**通过创建独立的 `FinancialAdjustment` 记录来处理。