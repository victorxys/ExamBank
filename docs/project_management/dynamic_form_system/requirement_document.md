# 需求文档：动态表单与记录管理系统

## 1. 背景

当前，公司的部分业务流程（如员工入职、合同签署）依赖于第三方表单工具“金数据”。为了将数据资产统一管理、提升系统集成度并增强业务流程的灵活性，我们计划在内部的 ExamDB 系统中构建一个全新的动态表单与记录管理模块。

此模块旨在替换现有的“金数据”流程，不仅要能导入并展示历史数据，还需要支持作为核心业务模块，处理动态、可变的业务记录（如员工档案）。

## 2. 核心需求

### 2.1. 动态表单引擎
- **需求**: 集成 SurveyJS 前端库，作为系统的核心表单渲染和编辑引擎。
- **目标**: 系统应能根据后端提供的 JSON Schema，动态生成表单界面，用于数据展示或填写。

### 2.2. 混合数据模型 (Hybrid Model)
- **需求**: 采用“核心表 + 动态扩展表”的混合模型来存储员工等核心业务对象的数据。
- **目标**:
    - **核心表 (`service_personnel`)**: 只存储最关键、稳定、需要索引和关联的字段（如 `id`, `name`, `status`, `phone`, `current_contract_id`）。
    - **动态扩展表 (`dynamic_form_data`)**: 以 JSON 格式存储所有描述性的、易变的、非关键的字段（如学历、民族、紧急联系人等）。

### 2.3. 数据同步 (属性提升)
- **需求**: 建立一个由元数据驱动的机制，将动态表单中填写的特定字段数据，同步（提升）到核心表的对应列中。
- **目标**:
    - 在表单的结构定义中，应包含一个 `sync_mapping` 配置，用于声明字段的映射关系。
    - 后端在接收到表单提交数据时，应在一个原子事务中，同时更新 `dynamic_form_data` (JSON) 和 `service_personnel` (列)。

### 2.4. 记录关联 (Association)
- **需求**: 建立一个由元数据驱动的机制，允许不同表单的记录之间建立关联。
- **目标**:
    - 在表单的结构定义中，应能定义 `record_association` 类型的字段，并配置其关联的目标表单、展示字段等。
    - 前端应提供一个自定义的、可搜索的下拉列表组件来完成关联操作。
    - 后端 API 在返回数据时，应能智能地聚合被关联记录的数据。
    - **业务流程**: 支持“先有员工，后有关联合同”以及“创建合同时，自动反向关联到员工”的业务逻辑。

### 2.5. 历史数据迁移
- **需求**: 支持从“金数据”导出的表单结构（JSON 文件）迁移到新系统中。
- **目标**:
    - 开发一个一次性的转换脚本。
    - 该脚本能将金数据的 JSON 结构，转换为 SurveyJS 兼容的 JSON Schema，并存入 `dynamic_form` 表。
    - 历史数据以只读模式进行展示。

### 2.6. 角色与权限 (RBAC)
- **需求**: 实现细粒度的权限控制。
- **目标**:
    - **普通员工**: 只能创建和修改自己档案中的部分信息。
    - **HR/管理员**: 可以查看和编辑所有员工的完整信息，包括被标记为 `private` 的字段。
    - 权限控制应能下沉到**字段级别**。

## 3. 用户场景

### 3.1. 管理员/HR
- 设计新的表单（如“年度健康调查”），或修改现有表单（如在“入职登记表”中增加“期望工作城市”字段），无需开发人员介入。
- 配置 `sync_mapping` 和 `record_association` 规则。
- 查看和编辑所有员工的完整档案信息。
- 创建一份“入职合同”，并将其关联到指定的员工。

### 3.2. 员工
- 首次入职时，通过链接填写“员工入职登记表”。
- 在个人中心，可以查看自己的档案，并修改其中允许修改的部分（如联系地址）。

## 4. 非功能性要求

- **灵活性**: 业务人员可以随时调整非核心业务的表单结构，而无需后端发布。
- **数据一致性**: 所有跨表写操作必须在同一数据库事务中完成，保证数据一致性。
- **性能**: 对核心表 `service_personnel` 的查询必须保持高性能。
- **可扩展性**: 系统的核心逻辑（同步、关联）应是通用的，未来增加新的表单和关联关系时，应只需修改配置而非代码。
