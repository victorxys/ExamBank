# 电子考勤表功能 - 测试用例

## 1. 考勤表创建测试

### 测试用例 1.1: 员工访问时自动创建考勤表

**测试目的**: 验证员工通过令牌访问时,系统能自动创建考勤表

**涉及模块/文件**: `AttendanceForm`, `BaseContract`

**输入**:
- `employee_access_token`: 有效的员工令牌

**期望输出**:
- 创建成功,返回 `AttendanceForm` 数据
- `AttendanceForm` 记录中:
  - `contract_id` 正确关联到活跃合同
  - `cycle_start_date` 为上个月1号
  - `status` = "draft"
  - `form_data` 为空对象

**实际输出 & 测试结果**:
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

### 测试用例 1.2: 重复访问不重复创建

**测试目的**: 验证同一周期已存在考勤表时,再次访问不会重复创建

**涉及模块/文件**: `AttendanceForm` 查询逻辑

**输入**:
- 已存在考勤表的 `employee_access_token`

**期望输出**:
- 返回已存在的 `AttendanceForm` 数据
- `id` 保持不变

**实际输出 & 测试结果**:
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

## 2. 考勤表填写测试

### 测试用例 2.1: 填写完整的考勤数据

**测试目的**: 验证员工能够填写所有类型的考勤数据

**涉及模块/文件**: `AttendanceForm.form_data` 字段更新

**输入**:
```json
{
  "rest_records": [{"date": "2025-01-05", "hours": 24, "minutes": 0}],
  "leave_records": [{"date": "2025-01-10", "hours": 4, "minutes": 30, "type": "事假"}],
  "overtime_records": [{"date": "2025-01-15", "hours": 2, "minutes": 0}],
  "beijing_records": [{"date": "2025-01-20", "hours": 48, "minutes": 0}],
  "country_records": [],
  "paid_leave_dates": ["2025-01-25"]
}
```

**期望输出**:
- 更新成功
- `AttendanceForm.form_data` 更新
- 自动计算统计信息(前端):
  - `attendance_days` = 25.5
  - `rest_days` = 1
  - `leave_days` = 0.1875
  - `overtime_days` = 0.0833

**实际输出 & 测试结果**:
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

### 测试用例 2.2: 时长转天数计算边界值

**测试目的**: 验证时长转天数的计算精度

**涉及模块/文件**: 考勤数据计算逻辑

**输入**:
- 加班 23小时59分钟
- 请假 1分钟

**期望输出**:
- 加班天数 = 0.999 天
- 请假天数 = 0.001 天

**实际输出 & 测试结果**:
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

## 3. 考勤表签署测试

### 测试用例 3.1: 员工确认并生成签署链接

**测试目的**: 验证员工确认考勤表后,系统生成客户签署链接

**涉及模块/文件**: `/api/attendance-forms/by-token/<token>/confirm`

**输入**:
- `employee_access_token`: 员工令牌

**期望输出**:
- 确认成功
- `status` 更新为 "employee_confirmed"
- 生成并返回 `customer_signature_token`
- 返回签署链接 URL

**实际输出 & 测试结果**:
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

### 测试用例 3.2: 客户签署流程

**测试目的**: 验证客户通过链接完成签署

**涉及模块/文件**: `/api/attendance-forms/sign/<token>`

**输入**:
- `customer_signature_token`: 签署令牌
- `signature_data`: 电子签名数据

**期望输出**:
- 签署成功
- `status` 更新为 "customer_signed"
- `customer_signed_at` 记录签署时间
- 自动触发数据同步到 `AttendanceRecord`

**实际输出 & 测试结果**:
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

### 测试用例 3.3: 未填写直接签署

**测试目的**: 验证未填写的考勤表不能签署

**涉及模块/文件**: 签署前验证逻辑

**输入**:
- 空白考勤表的 `form_data_id`

**期望输出**:
- 返回 400 错误
- 错误信息: "请先填写考勤数据"

**实际输出 & 测试结果**:
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

### 测试用例 3.4: 已签署后修改数据

**测试目的**: 验证已签署的考勤表不能修改

**涉及模块/文件**: 数据更新权限控制

**输入**:
- 已签署的 `form_data_id`
- 修改请求

**期望输出**:
- 返回 403 错误
- 错误信息: "已签署的考勤表不可修改"

**实际输出 & 测试结果**:
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

## 4. 数据同步测试

### 测试用例 4.1: 同步到 AttendanceRecord

**测试目的**: 验证签署完成后,考勤数据能正确同步到 `AttendanceRecord`

**涉及模块/文件**: 数据同步逻辑, `AttendanceRecord`

**输入**:
- 双方已签署的考勤表,包含:
  - 请假 0.5 天
  - 加班 1.5 天
  - 带薪休假 2 天

**期望输出**:
- 创建或更新 `AttendanceRecord`:
  - `total_days_worked` = 26 - 0.5 + 2 = 27.5
  - `overtime_days` = 1.5
  - `attendance_form_id` 关联到表单
  - `attendance_details` 包含原始详细数据
- `AttendanceForm.synced_to_attendance` = true
- `AttendanceForm.status` = "synced"

**实际输出 & 测试结果**:
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

### 测试用例 4.2: 防止重复同步

**测试目的**: 验证已同步的考勤表不会重复同步

**涉及模块/文件**: 同步幂等性控制

**输入**:
- 已同步的 `form_data_id`
- 再次调用同步接口

**期望输出**:
- 返回成功,但不执行实际同步操作
- 日志记录: "考勤表已同步,跳过"

**实际输出 & 测试结果**:
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

## 5. 工资重算测试

### 测试用例 5.1: 触发工资单重算

**测试目的**: 验证考勤数据同步后,能自动触发工资单重算

**涉及模块/文件**: `BillingEngine.calculate_for_month()`

**输入**:
- 同步完成的考勤数据
- 对应的合同和周期

**期望输出**:
- 调用 `BillingEngine.calculate_for_month(year, month, contract_id, force_recalculate=True)`
- `EmployeePayroll` 的 `total_due` 更新
- `calculation_details` 包含新的考勤数据

**实际输出 & 测试结果**:
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

### 测试用例 5.2: 加班费计算验证

**测试目的**: 验证加班天数正确影响工资计算

**涉及模块/文件**: `BillingEngine._calculate_maternity_nurse_details()`

**输入**:
- 月嫂合同,级别 8000 元
- 加班 2 天

**期望输出**:
- 加班费 = 8000 / 26 * 2 = 615.38 元
- `EmployeePayroll.total_due` 包含加班费

**实际输出 & 测试结果**:
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

## 6. 完整流程集成测试

### 测试用例 6.1: 端到端完整流程

**测试目的**: 验证从创建到工资更新的完整流程

**涉及模块/文件**: 所有相关模块

**输入**:
- 一个有效的合同

**期望输出**:
1. 创建考勤表成功
2. 员工填写考勤数据成功
3. 员工签署成功
4. 客户签署成功
5. 数据同步到 `AttendanceRecord` 成功
6. 工资单重算成功
7. 工资单金额正确

**实际输出 & 测试结果**:
- 单元测试: N/A
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

## 7. 异常场景测试

### 测试用例 7.1: 网络中断时的数据一致性

**测试目的**: 验证签署过程中网络中断,数据不会不一致

**涉及模块/文件**: 数据库事务处理

**输入**:
- 模拟签署过程中网络中断

**期望输出**:
- 事务回滚
- 签署状态保持原状
- 用户可以重新签署

**实际输出 & 测试结果**:
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

### 测试用例 7.2: 并发签署冲突

**测试目的**: 验证两个用户同时签署同一考勤表的处理

**涉及模块/文件**: 并发控制

**输入**:
- 员工和客户同时发起签署请求

**期望输出**:
- 使用乐观锁或悲观锁控制
- 一个成功,另一个提示"状态已变更,请刷新"

**实际输出 & 测试结果**:
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---
## 8. 账单详情显示测试

### 测试用例 8.1: 考勤字段显示验证

**测试目的**: 验证账单详情页面正确显示非零的考勤统计字段

**涉及模块/文件**: `FinancialManagementModal`, `get_billing_details`

**输入**:
- 一个已生成账单的合同,考勤记录包含:
  - 出京 5 天
  - 出境 0 天
  - 请假 1 天
  - 带薪休假 2 天
  - 休息 4 天

**期望输出**:
- 账单详情页面显示:
  - "出京天数: 5"
  - "请假天数: 1"
  - "带薪休假天数: 2"
  - "休息天数: 4"
- **不显示**: "出境天数" (因为是0)

**实际输出 & 测试结果**:
- 单元测试: N/A
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

## 9. 性能测试

### 测试用例 8.1: 大量考勤表查询性能

**测试目的**: 验证查询1000+考勤表的性能

**涉及模块/文件**: 考勤表列表查询接口

**输入**:
- 数据库中有 1000 条考勤表记录
- 查询请求(带分页)

**期望输出**:
- 响应时间 < 2秒
- 内存占用合理

**实际输出 & 测试结果**:
- 单元测试: N/A
- 集成测试: [待填充]
- **最终检查结果**: [待填充]

---

## 测试覆盖率目标

- **单元测试覆盖率**: ≥ 80%
- **集成测试覆盖率**: ≥ 60%
- **关键路径覆盖**: 100%

## 测试环境

- **开发环境**: 本地 PostgreSQL + Flask
- **测试环境**: Docker 容器
- **生产环境**: 正式数据库(只读副本)
