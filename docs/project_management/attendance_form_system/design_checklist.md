# 电子考勤表功能 - 设计检查清单

## 1. 需求理解检查

### 1.1 核心功能确认
- [x] **电子考勤表创建**: 为每个合同的计费周期生成电子考勤表
- [x] **考勤数据录入**: 员工填写出勤、请假、加班、出京、出境等信息
- [x] **在线签署**: 员工和客户双方在线签署考勤表
- [x] **自动关联工资单**: 签署后自动同步数据到 AttendanceRecord 并触发工资重算

### 1.2 数据流确认
```
员工填写考勤表 (AttendanceForm)
    ↓
提交并签署
    ↓
客户签署确认
    ↓
双方签署完成
    ↓
自动同步到 AttendanceRecord
    ↓
触发 BillingEngine 重算工资
    ↓
EmployeePayroll 更新
```

**检查结果**: ✅ 数据流清晰,不涉及财务调整项(FinancialAdjustment)

## 2. 数据模型设计检查

### 2.1 AttendanceRecord 扩展检查
**新增字段**:
- [ ] `attendance_form_id`: 关联到 AttendanceForm
- [ ] `attendance_details`: JSONB 存储详细考勤数据

**检查项**:
- [ ] 字段类型是否正确
- [ ] 外键约束是否合理
- [ ] 是否需要索引
- [ ] 是否影响现有查询性能

### 2.2 AttendanceForm 模型检查 (新表)
**核心字段**:
- [ ] `contract_id`: 关联合同
- [ ] `employee_id`: 关联员工
- [ ] `form_data`: JSONB 存储考勤数据
- [ ] `status`: 状态管理
- [ ] `employee_access_token`: 访问令牌
- [ ] `customer_signature_token`: 签署令牌

**检查项**:
- [ ] 唯一约束(contract_id + cycle_start_date)
- [ ] 索引设计(token, status)
- [ ] JSONB 字段结构定义
- [ ] 状态流转逻辑

### 2.3 数据一致性检查
- [ ] AttendanceRecord 与 AttendanceForm 的双向关联是否正确
- [ ] 删除策略是否合理(CASCADE vs SET NULL)
- [ ] 是否需要数据库级别的约束保证一致性

## 3. 业务逻辑设计检查

### 3.1 考勤数据计算逻辑
**时长转天数规则**:
- [ ] 请假时长(小时:分钟) → 天数: `(hours + minutes/60) / 24`
- [ ] 加班时长(小时:分钟) → 天数: `(hours + minutes/60) / 24`
- [ ] 出京时长 → 是否影响工资计算?
- [ ] 出境时长 → 是否影响工资计算?

**出勤天数计算**:
- [ ] `total_days_worked` = 基础出勤天数 - 请假天数 + 带薪休假天数
- [ ] 是否需要考虑周末和节假日?
- [ ] 26天制如何处理?

### 3.2 签署流程检查
**签署顺序**:
- [ ] 是否必须先员工签署,再客户签署?
- [ ] 还是可以任意顺序签署?
- [ ] 单方签署后是否可以撤回?

**签署验证**:
- [ ] 签署人身份验证机制
- [ ] 签署时间记录
- [ ] 签署IP记录
- [ ] 防止重复签署

### 3.3 数据同步逻辑检查
**同步时机**:
- [ ] 双方签署完成后立即同步
- [ ] 还是需要管理员审核后同步?

**同步内容**:
- [ ] 从 AttendanceForm.form_data 提取考勤数据
- [ ] 计算并更新 AttendanceRecord 的字段
- [ ] 保存原始详细数据到 attendance_details

**幂等性保证**:
- [ ] 如何防止重复同步?
- [ ] 同步失败如何回滚?

### 3.4 工资重算触发检查
**触发条件**:
- [ ] 考勤数据同步成功后自动触发
- [ ] 调用 `BillingEngine.calculate_for_month(year, month, contract_id, force_recalculate=True)`

**影响范围**:
- [ ] 只重算当前周期的工资单
- [ ] 是否影响其他周期?

## 4. API 接口设计检查

### 4.1 RESTful 设计检查
- [ ] URL 命名是否符合 RESTful 规范
- [ ] HTTP 方法使用是否正确(GET/POST/PUT/DELETE)
- [ ] 返回状态码是否合理(200/201/400/404/500)

### 4.2 权限控制检查
- [ ] 员工只能访问自己的考勤表
- [ ] 客户只能访问自己合同的考勤表
- [ ] 管理员可以访问所有考勤表
- [ ] 签署操作需要身份验证

### 4.3 数据验证检查
- [ ] 请求参数验证
- [ ] 业务规则验证(如:已签署不可修改)
- [ ] 错误信息是否友好

## 5. 前端设计检查

### 5.1 UI 组件库检查 (shadcn/ui)
- [ ] shadcn 组件是否已安装和配置
- [ ] 使用的组件是否符合设计规范:
  - [ ] Card - 用于内容容器
  - [ ] Form - 用于表单布局
  - [ ] Table - 用于列表展示
  - [ ] Dialog/AlertDialog - 用于弹窗和确认
  - [ ] Button - 用于操作按钮
  - [ ] Badge - 用于状态标签
  - [ ] Toast - 用于消息提示
  - [ ] Select/DatePicker - 用于筛选
- [ ] 主题配置是否与现有系统一致
- [ ] 组件样式是否需要自定义

### 5.2 自定义表单实现检查 (shadcn + react-calendar)
- [ ] react-calendar 样式定制是否完成
- [ ] 日期多选逻辑是否正确
- [ ] 实时计算逻辑是否准确
- [ ] 状态颜色标示是否清晰
- [ ] 移动端适配是否良好
- [ ] 账单详情页面 (FinancialManagementModal)
  - [ ] 考勤统计字段是否完整(出京/出境/请假/带薪休假/休息)
  - [ ] 数值为0时是否正确隐藏
  - [ ] 样式是否与现有风格一致

### 5.3 用户体验检查
- [ ] 表单填写是否流畅
- [ ] 保存草稿功能是否必要
- [ ] 错误提示是否清晰(使用 shadcn Alert/Toast)
- [ ] 签署流程是否简洁
- [ ] 加载状态是否有反馈(shadcn Skeleton/Spinner)

### 5.4 响应式设计检查
- [ ] 移动端适配(shadcn 组件自带响应式)
- [ ] 不同屏幕尺寸下的表现
- [ ] 触摸操作友好性

## 6. 性能与安全检查

### 6.1 性能检查
- [ ] 考勤表列表查询是否需要分页
- [ ] 是否需要缓存
- [ ] 数据库查询是否优化(避免 N+1 问题)
- [ ] PDF 生成是否异步处理

### 6.2 安全检查
- [ ] SQL 注入防护
- [ ] XSS 攻击防护
- [ ] CSRF 防护
- [ ] 签署数据加密存储

### 6.3 数据完整性检查
- [ ] 签署后数据不可篡改
- [ ] 数据库事务处理
- [ ] 并发控制(乐观锁/悲观锁)

## 7. 兼容性与迁移检查

### 7.1 向后兼容性
- [ ] 现有的手动录入考勤数据是否继续有效
- [ ] 新旧系统是否可以并存
- [ ] API 版本控制

### 7.2 数据迁移检查
- [ ] 迁移脚本是否可回滚
- [ ] 迁移过程是否影响线上服务
- [ ] 迁移后数据验证

## 8. 测试覆盖检查

### 8.1 单元测试
- [ ] 考勤数据计算逻辑测试
- [ ] 签署流程状态机测试
- [ ] 数据同步逻辑测试

### 8.2 集成测试
- [ ] 完整流程测试(填写→签署→同步→工资计算)
- [ ] 异常场景测试(网络中断、数据不一致等)

### 8.3 边界条件测试
- [ ] 空数据处理
- [ ] 极端值处理(如:加班999小时)
- [ ] 并发签署处理

## 9. 待确认的关键问题

### 9.1 业务规则确认
1. **考勤表生成时机**: 自动生成 vs 手动创建?
2. **签署顺序**: 必须先员工后客户 vs 任意顺序?
3. **出京/出境影响**: 是否影响工资?如何影响?
4. **带薪休假规则**: 是否计入出勤?
5. **请假扣款规则**: 是否扣工资?如何扣?
6. **客户修改权限**: 签署前客户是否可以修改考勤表?
7. **历史数据处理**: 现有手动录入数据如何处理?
8. **拒绝签署处理**: 如果一方拒绝签署,如何处理?

### 9.2 技术实现确认
1. **PDF 生成方案**: 使用什么库?前端生成 vs 后端生成?
2. **电子签名方案**: 手写签名 vs 数字证书?
3. **签署通知方式**: 短信 vs 邮件 vs 站内消息?

## 10. 检查结论

**总体评估**:
- [ ] 需求理解清晰
- [ ] 数据模型设计合理
- [ ] 业务逻辑完整
- [ ] API 设计符合规范
- [ ] 前端设计可行
- [ ] 性能和安全考虑充分
- [ ] 测试覆盖完整

**是否可以进入实现阶段**: ⬜ 是 / ⬜ 否

**阻塞问题**: 需要用户确认上述9个关键业务规则问题
