# å‘˜å·¥ç”µå­è€ƒå‹¤è¡¨ä¸å·¥èµ„å•è‡ªåŠ¨å…³è”åŠŸèƒ½ - éœ€æ±‚æ–‡æ¡£

## 1. éœ€æ±‚èƒŒæ™¯

### 1.1 ä¸šåŠ¡ç°çŠ¶
å½“å‰ç³»ç»Ÿä¸­,è€ƒå‹¤æ•°æ®(`AttendanceRecord`)çš„å½•å…¥å’Œç®¡ç†å­˜åœ¨ä»¥ä¸‹é—®é¢˜:
- è€ƒå‹¤æ•°æ®ç”±ç®¡ç†å‘˜åœ¨åå°æ‰‹åŠ¨å½•å…¥,ç¼ºä¹å‘˜å·¥å‚ä¸å’Œç¡®è®¤ç¯èŠ‚
- æ²¡æœ‰è€ƒå‹¤è¡¨çš„ç”µå­åŒ–ç­¾ç½²æµç¨‹,ç¼ºå°‘æ³•å¾‹æ•ˆåŠ›
- è€ƒå‹¤æ•°æ®ä¸å·¥èµ„å•çš„å…³è”æ˜¯ç³»ç»Ÿè‡ªåŠ¨çš„,ä½†å‘˜å·¥æ— æ³•æŸ¥çœ‹å’Œç¡®è®¤è‡ªå·±çš„è€ƒå‹¤è®°å½•
- **å‡ºäº¬/å‡ºå¢ƒç®¡ç†è´¹**æœªèƒ½è‡ªåŠ¨è®¡ç®—:
  - å‡ºäº¬å¤©æ•°:å®¢æˆ·éœ€é¢å¤–æ”¯ä»˜10%å·¥èµ„,å…¬å¸æ”¶å–é¢å¤–10%ç®¡ç†è´¹
  - å‡ºå¢ƒå¤©æ•°:å®¢æˆ·éœ€é¢å¤–æ”¯ä»˜20%å·¥èµ„,å…¬å¸æ”¶å–é¢å¤–20%ç®¡ç†è´¹
  - å½“å‰è¿™äº›è´¹ç”¨éœ€è¦æ‰‹åŠ¨è®¡ç®—å’Œè°ƒæ•´

### 1.2 ç°æœ‰ç³»ç»Ÿæ¶æ„åˆ†æ

#### æ ¸å¿ƒæ•°æ®æ¨¡å‹
1. **AttendanceRecord (è€ƒå‹¤è®°å½•è¡¨)**
   - `employee_id`: å‘˜å·¥ID
   - `contract_id`: å…³è”åˆåŒID
   - `cycle_start_date`: å‘¨æœŸå¼€å§‹æ—¥æœŸ
   - `cycle_end_date`: å‘¨æœŸç»“æŸæ—¥æœŸ
   - `total_days_worked`: æ€»å‡ºå‹¤å¤©æ•°(å«å¸¦è–ªä¼‘å‡)
   - `overtime_days`: åŠ ç­å¤©æ•°(ç²¾ç¡®åˆ°å°æ•°)
   - `statutory_holiday_days`: æ³•å®šèŠ‚å‡æ—¥å·¥ä½œå¤©æ•°
   - `out_of_beijing_days`: **å‡ºäº¬å¤©æ•°**(æ–°å¢,ç²¾ç¡®åˆ°å°æ•°)
   - `out_of_country_days`: **å‡ºå¢ƒå¤©æ•°**(æ–°å¢,ç²¾ç¡®åˆ°å°æ•°)

2. **EmployeePayroll (å‘˜å·¥å·¥èµ„å•)**
   - é€šè¿‡ `contract_id` å’Œ `cycle_start_date` ä¸è€ƒå‹¤è®°å½•å…³è”
   - `total_due`: æ€»åº”å‘é‡‘é¢
   - `calculation_details`: è®¡ç®—è¿‡ç¨‹å¿«ç…§(JSONB)

3. **DynamicForm & DynamicFormData (åŠ¨æ€è¡¨å•ç³»ç»Ÿ)**
   - å·²æœ‰çš„è¡¨å•ç³»ç»Ÿ,æ”¯æŒ SurveyJS æ ¼å¼
   - æ”¯æŒä¸ `contract_id` å…³è”
   - æ”¯æŒæ•°æ®çš„ CRUD æ“ä½œ

#### å·¥èµ„è®¡ç®—é€»è¾‘
- `BillingEngine._get_or_create_attendance()`: è‡ªåŠ¨åˆ›å»ºæˆ–è·å–è€ƒå‹¤è®°å½•
- `BillingEngine._calculate_maternity_nurse_details()`: æœˆå«‚å·¥èµ„è®¡ç®—æ—¶è¯»å–è€ƒå‹¤æ•°æ®
- `BillingEngine._calculate_nanny_details()`: è‚²å„¿å«‚å·¥èµ„è®¡ç®—æ—¶è¯»å–è€ƒå‹¤æ•°æ®
- è€ƒå‹¤æ•°æ®ä¸­çš„ `overtime_days` ç›´æ¥å½±å“åŠ ç­è´¹è®¡ç®—

## 2. åŠŸèƒ½éœ€æ±‚

### 2.1 æ ¸å¿ƒåŠŸèƒ½

#### 2.1.1 ç”µå­è€ƒå‹¤è¡¨åˆ›å»ºä¸å¡«å†™
**åŠŸèƒ½æè¿°**: å‘˜å·¥é€šè¿‡å›ºå®šé“¾æ¥è®¿é—®è€ƒå‹¤è¡¨,å¡«å†™å½“æœˆçš„ä¸Šæœˆè€ƒå‹¤æ•°æ®

**è¯¦ç»†éœ€æ±‚**:
1. **è€ƒå‹¤è¡¨ç”Ÿæˆä¸è®¿é—®æ–¹å¼**
   - **å‘˜å·¥å›ºå®šé“¾æ¥**: æ¯ä¸ªå‘˜å·¥æœ‰ä¸€ä¸ªå›ºå®šçš„è€ƒå‹¤è¡¨é“¾æ¥,ç”±ç³»ç»Ÿç”Ÿæˆ
   - **æ— éœ€ç™»å½•**: å‘˜å·¥é€šè¿‡é“¾æ¥ç›´æ¥è®¿é—®,æ— éœ€ç™»å½•ç³»ç»Ÿ
   - **å¡«å†™æ—¶æœº**: å½“æœˆå¡«å†™ä¸Šä¸ªæœˆçš„è€ƒå‹¤è¡¨
     - ä¾‹å¦‚: 2025å¹´2æœˆå¡«å†™2025å¹´1æœˆçš„è€ƒå‹¤è¡¨
   - **å‘¨æœŸè‡ªåŠ¨è¯†åˆ«**: ç³»ç»Ÿæ ¹æ®å½“å‰æ—¥æœŸè‡ªåŠ¨ç¡®å®šè€ƒå‹¤å‘¨æœŸ
   - **è¿è¥äººå‘˜å‘é€**: è¿è¥äººå‘˜å°†å›ºå®šé“¾æ¥å‘é€ç»™å‘˜å·¥

2. **è€ƒå‹¤è¡¨å†…å®¹å­—æ®µ**
   - **åŸºç¡€ä¿¡æ¯**(è‡ªåŠ¨å¡«å……,ä¸å¯ç¼–è¾‘):
     - å‘˜å·¥å§“å
     - å®¢æˆ·å§“å
     - åˆåŒç¼–å·(ç³»ç»Ÿè‡ªåŠ¨å…³è”å‘˜å·¥å½“å‰æ´»è·ƒåˆåŒ)
     - è€ƒå‹¤å‘¨æœŸ(èµ·æ­¢æ—¥æœŸ,è‡ªåŠ¨è®¡ç®—ä¸Šæœˆå‘¨æœŸ)
     - å½“æœˆæ€»å¤©æ•°(è‡ªç„¶å¤©æ•°)
   
   **è¯´æ˜**: ç³»ç»Ÿæ ¹æ®å‘˜å·¥è®¿é—®ä»¤ç‰Œè‡ªåŠ¨è¯†åˆ«å‘˜å·¥,å¹¶å…³è”è¯¥å‘˜å·¥å½“å‰æ­£åœ¨è¿›è¡Œçš„åˆåŒ(ä¸€ä¸ªå‘˜å·¥åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªæ´»è·ƒåˆåŒ)
   
   - **è€ƒå‹¤æ˜ç»†**(å‘˜å·¥é€šè¿‡æ—¥æœŸé€‰æ‹©å¡«å†™):
     - **ä¼‘æ¯è®°å½•**(ç²¾ç¡®åˆ°å°æ—¶åˆ†é’Ÿ):
       - é€‰æ‹©ä¼‘æ¯æ—¥æœŸ(å¤šé€‰)
       - æ¯ä¸ªä¼‘æ¯æ—¥çš„æ—¶é•¿(å°æ—¶:åˆ†é’Ÿ,é»˜è®¤24å°æ—¶è¡¨ç¤ºå…¨å¤©ä¼‘æ¯)
     - **è¯·å‡è®°å½•**(ä»…ç”¨äºæ ¸å¯¹,ä¸æ‰£æ¬¾):
       - é€‰æ‹©è¯·å‡æ—¥æœŸ(å¤šé€‰)
       - æ¯ä¸ªè¯·å‡æ—¥çš„æ—¶é•¿(å°æ—¶:åˆ†é’Ÿ)
       - è¯·å‡ç±»å‹(äº‹å‡/ç—…å‡/å¹´å‡ç­‰)
     - **åŠ ç­è®°å½•**:
       - é€‰æ‹©åŠ ç­æ—¥æœŸ(å¤šé€‰)
       - æ¯ä¸ªåŠ ç­æ—¥çš„æ—¶é•¿(å°æ—¶:åˆ†é’Ÿ)
       - **è¯´æ˜**: åŠ ç­æŒ‰æ—¥è–ª*1è®¡ç®—,ä¸åŠ å€
     - **å‡ºäº¬è®°å½•**(å½±å“å·¥èµ„è®¡ç®—,**è®¡å…¥å‡ºå‹¤å¤©æ•°**):
       - é€‰æ‹©å‡ºäº¬æ—¥æœŸ(å¤šé€‰)
       - æ¯ä¸ªå‡ºäº¬æ—¥çš„æ—¶é•¿(å°æ—¶:åˆ†é’Ÿ)
       - **è´¹ç”¨è¯´æ˜**: å®¢æˆ·é¢å¤–æ”¯ä»˜10%å·¥èµ„,å…¬å¸æ”¶å–10%ç®¡ç†è´¹
     - **å‡ºå¢ƒè®°å½•**(å½±å“å·¥èµ„è®¡ç®—,**è®¡å…¥å‡ºå‹¤å¤©æ•°**):
       - é€‰æ‹©å‡ºå¢ƒæ—¥æœŸ(å¤šé€‰)
       - æ¯ä¸ªå‡ºå¢ƒæ—¥çš„æ—¶é•¿(å°æ—¶:åˆ†é’Ÿ)
       - **è´¹ç”¨è¯´æ˜**: å®¢æˆ·é¢å¤–æ”¯ä»˜20%å·¥èµ„,å…¬å¸æ”¶å–20%ç®¡ç†è´¹
     - **å¸¦è–ªä¼‘å‡æ—¥æœŸ**(å¤šé€‰,**åŒ…å«åœ¨å‡ºå‹¤å¤©æ•°å†…,ä»…ç”¨äºæ˜¾ç¤º**)
   
   - **è‡ªåŠ¨è®¡ç®—é€»è¾‘**:
     - **å‡ºå‹¤å¤©æ•°**(å«å¸¦è–ªä¼‘å‡ã€å‡ºäº¬ã€å‡ºå¢ƒ) = å½“æœˆæ€»å¤©æ•° - è¯·å‡å¤©æ•° - ä¼‘æ¯å¤©æ•°
     - æ‰€æœ‰æ—¶é•¿(å°æ—¶:åˆ†é’Ÿ)éƒ½è½¬æ¢ä¸ºå¤©æ•°: `å¤©æ•° = (å°æ—¶ + åˆ†é’Ÿ/60) / 24`
     - ç³»ç»Ÿè‡ªåŠ¨è®¡ç®—å¹¶å®æ—¶æ˜¾ç¤º
     - **æ•°æ®éªŒè¯**: å‡ºå‹¤å¤©æ•° + ä¼‘æ¯å¤©æ•° + è¯·å‡å¤©æ•° = å½“æœˆè‡ªç„¶å¤©æ•°
     - **ç”¨æˆ·æç¤º**: "å‡ºå‹¤å¤©æ•°(å«å¸¦è–ªä¼‘å‡ã€å‡ºäº¬ã€å‡ºå¢ƒ) + ä¼‘æ¯å¤©æ•° + è¯·å‡å¤©æ•° åº”ç­‰äºå½“æœˆæ€»å¤©æ•°"
   
   - **æ—¥å†å¯è§†åŒ–å±•ç¤º**(é¢„è§ˆå’Œç­¾ç½²é¡µé¢):
     - æ˜¾ç¤ºå½“æœˆæ—¥å†
     - ä¸åŒé¢œè‰²/å›¾æ ‡æ ‡ç¤º:
       - ğŸŸ¢ å‡ºå‹¤æ—¥
       - ğŸ”´ ä¼‘æ¯æ—¥
       - ğŸŸ¡ è¯·å‡æ—¥(æ˜¾ç¤ºè¯·å‡ç±»å‹)
       - ğŸ”µ åŠ ç­æ—¥(æ˜¾ç¤ºåŠ ç­æ—¶é•¿)
       - ğŸŸ  å‡ºäº¬æ—¥(æ˜¾ç¤ºæ—¶é•¿)
       - ğŸŸ£ å‡ºå¢ƒæ—¥(æ˜¾ç¤ºæ—¶é•¿)
       - ğŸ’š å¸¦è–ªä¼‘å‡æ—¥
     - æ—¥å†ä¸‹æ–¹ç”¨æ–‡å­—æ˜ç»†å±•ç¤ºå„é¡¹ç»Ÿè®¡
   
   - **ç»Ÿè®¡ä¿¡æ¯**(è‡ªåŠ¨è®¡ç®—):
     - **å‡ºå‹¤å¤©æ•°**(å«å¸¦è–ªä¼‘å‡ã€å‡ºäº¬ã€å‡ºå¢ƒ,è‡ªåŠ¨è®¡ç®—)
     - ä¼‘æ¯å¤©æ•°
     - è¯·å‡æ€»å¤©æ•°
     - åŠ ç­æ€»å¤©æ•°
     - å‡ºäº¬æ€»å¤©æ•°(åŒ…å«åœ¨å‡ºå‹¤å¤©æ•°å†…)
     - å‡ºå¢ƒæ€»å¤©æ•°(åŒ…å«åœ¨å‡ºå‹¤å¤©æ•°å†…)
     - å¸¦è–ªä¼‘å‡å¤©æ•°(åŒ…å«åœ¨å‡ºå‹¤å¤©æ•°å†…,**ä»…ç”¨äºæ˜¾ç¤º**)

3. **å¡«å†™æƒé™**
   - å‘˜å·¥å¯ä»¥å¡«å†™å’Œä¿®æ”¹è‡ªå·±çš„è€ƒå‹¤è¡¨(å®¢æˆ·ç­¾ç½²å‰)
   - å®¢æˆ·**ä¸èƒ½**ä¿®æ”¹è€ƒå‹¤è¡¨,å¦‚æœ‰ç–‘é—®éœ€å‘˜å·¥é‡æ–°å¡«å†™
   - ç®¡ç†å‘˜å¯ä»¥æŸ¥çœ‹å’Œä¿®æ”¹æ‰€æœ‰è€ƒå‹¤è¡¨

4. **åˆåŒæ ¡éªŒ**
   - å‘˜å·¥è¿›å…¥è€ƒå‹¤è¡¨å¡«å†™é¡µé¢æ—¶,ç³»ç»Ÿæ£€æŸ¥æ˜¯å¦æœ‰æ´»è·ƒåˆåŒ
   - å¦‚æœæ²¡æœ‰æ´»è·ƒåˆåŒ,æ˜¾ç¤ºæç¤ºä¿¡æ¯å¹¶é€€å‡º
   - æç¤ºå†…å®¹: "æ‚¨å½“å‰æ²¡æœ‰è¿›è¡Œä¸­çš„åˆåŒ,æ— æ³•å¡«å†™è€ƒå‹¤è¡¨"

5. **å¤åˆ¶é“¾æ¥åŠŸèƒ½**
   - å‘˜å·¥ç”Ÿæˆç­¾ç½²é“¾æ¥å,é¡µé¢æ˜¾ç¤º"å¤åˆ¶é“¾æ¥"æŒ‰é’®
   - ç‚¹å‡»åè‡ªåŠ¨å¤åˆ¶å®¢æˆ·ç­¾ç½²é“¾æ¥åˆ°å‰ªè´´æ¿
   - æ˜¾ç¤ºå¤åˆ¶æˆåŠŸæç¤º

#### 2.1.2 è€ƒå‹¤è¡¨åœ¨çº¿ç­¾ç½²
**åŠŸèƒ½æè¿°**: å‘˜å·¥å¡«å†™å¹¶é¢„è§ˆç¡®è®¤å,ç”Ÿæˆç­¾ç½²é“¾æ¥è‡ªå·±å‘é€ç»™å®¢æˆ·,å®¢æˆ·ç­¾ç½²åç”Ÿæ•ˆ

**è¯¦ç»†éœ€æ±‚**:
1. **ç­¾ç½²æµç¨‹**(ç®€åŒ–ä¸ºå•æ–¹ç­¾ç½²)
   - å‘˜å·¥å¡«å†™å®Œæˆå,é¢„è§ˆè€ƒå‹¤è¡¨(åŒ…å«å…¬å¸logo)
   - å‘˜å·¥ç¡®è®¤æ— è¯¯å,ç‚¹å‡»"ç”Ÿæˆç­¾ç½²é“¾æ¥"
   - ç³»ç»Ÿç”Ÿæˆå®¢æˆ·ç­¾ç½²é“¾æ¥å’ŒPDFé¢„è§ˆ
   - **å‘˜å·¥è‡ªå·±**å°†ç­¾ç½²é“¾æ¥å‘é€ç»™å®¢æˆ·(é€šè¿‡"å¤åˆ¶é“¾æ¥"æŒ‰é’®)
   - å®¢æˆ·é€šè¿‡é“¾æ¥è®¿é—®(æ— éœ€ç™»å½•),æŸ¥çœ‹è€ƒå‹¤è¡¨(åŒ…å«å…¬å¸logo)
   - å®¢æˆ·åœ¨çº¿ç­¾ç½²(ä½¿ç”¨ç°æœ‰ç”µå­ç­¾ååŠŸèƒ½)
   - å®¢æˆ·ç­¾ç½²å®Œæˆå,è€ƒå‹¤è¡¨ç«‹å³ç”Ÿæ•ˆ
   - å‘˜å·¥å‘ŠçŸ¥è¿è¥äººå‘˜å·²ç­¾ç½²
   - è‡ªåŠ¨è§¦å‘æ•°æ®åŒæ­¥åˆ° `AttendanceRecord`

2. **ç­¾ç½²çŠ¶æ€ç®¡ç†**
   - `draft`: è‰ç¨¿(å‘˜å·¥å¡«å†™ä¸­)
   - `employee_confirmed`: å‘˜å·¥å·²ç¡®è®¤(ç”Ÿæˆç­¾ç½²é“¾æ¥)
   - `customer_signed`: å®¢æˆ·å·²ç­¾ç½²
   - `synced`: å·²åŒæ­¥åˆ°å·¥èµ„å•

3. **é¡µé¢å±•ç¤ºè¦æ±‚**
   - é¢„è§ˆé¡µé¢å’Œç­¾ç½²é¡µé¢éƒ½è¦æ˜¾ç¤º**å…¬å¸logo**
   - å‚è€ƒç°æœ‰çš„"åˆåŒåœ¨çº¿ç­¾ç½²"é¡µé¢è®¾è®¡
   - ä½¿ç”¨ç›¸åŒçš„PDFç”Ÿæˆåº“å’Œæ ·å¼

4. **ç­¾ç½²è®°å½•**
   - è®°å½•å®¢æˆ·ç­¾ç½²æ—¶é—´ã€ç­¾ç½²IP
   - ä¿å­˜ç­¾ç½²åçš„PDFæ–‡ä»¶
   - **å¤ç”¨ç°æœ‰ç­¾ååŠŸèƒ½**: ä½¿ç”¨ç³»ç»Ÿå·²æœ‰çš„ç”µå­ç­¾åç»„ä»¶

#### 2.1.3 è€ƒå‹¤æ•°æ®è‡ªåŠ¨å…³è”åˆ°å·¥èµ„å•
**åŠŸèƒ½æè¿°**: å®¢æˆ·ç­¾ç½²å®Œæˆå,è‡ªåŠ¨å°†è€ƒå‹¤æ•°æ®åŒæ­¥åˆ° `AttendanceRecord`,è§¦å‘å·¥èµ„é‡ç®—

**è¯¦ç»†éœ€æ±‚**:
1. **æ•°æ®åŒæ­¥é€»è¾‘**
   - å®¢æˆ·ç­¾ç½²å®Œæˆå,ç«‹å³è‡ªåŠ¨è§¦å‘æ•°æ®åŒæ­¥
   - å°†è€ƒå‹¤è¡¨ä¸­çš„æ•°æ®è½¬æ¢ä¸º `AttendanceRecord` æ ¼å¼:

     - `statutory_holiday_days`: èŠ‚å‡æ—¥åŠ ç­æ—¶é•¿è½¬æ¢ä¸ºå¤©æ•°
     - `out_of_beijing_days`: **å‡ºäº¬æ€»æ—¶é•¿è½¬æ¢ä¸ºå¤©æ•°**(æ–°å¢)
     - `out_of_country_days`: **å‡ºå¢ƒæ€»æ—¶é•¿è½¬æ¢ä¸ºå¤©æ•°**(æ–°å¢)
     - `attendance_details`: ä¿å­˜åŸå§‹è¯¦ç»†æ•°æ®(JSONB),åŒ…å«å¸¦è–ªä¼‘å‡æ—¥æœŸ(ä»…ç”¨äºæ˜¾ç¤º)
   
2. **å·¥èµ„å•é‡ç®—**(åŒ…å«å‡ºäº¬å‡ºå¢ƒç®¡ç†è´¹)
   - æ•°æ®åŒæ­¥å®Œæˆå,è‡ªåŠ¨è§¦å‘è¯¥å‘¨æœŸçš„å·¥èµ„å•é‡ç®—
   - è°ƒç”¨ `BillingEngine.calculate_for_month(year, month, contract_id, force_recalculate=True)`
   - **è®¡ç®—é€»è¾‘**:
     - åŸºç¡€å·¥èµ„ = çº§åˆ« * (å‡ºå‹¤å¤©æ•° / 26)
     - åŠ ç­è´¹ = çº§åˆ« * (åŠ ç­å¤©æ•° / 26)
     - **å‡ºäº¬ç®¡ç†è´¹**: 
       - å®¢æˆ·é¢å¤–æ”¯ä»˜ = çº§åˆ« * 10% * å‡ºäº¬å¤©æ•° / 26
       - å…¬å¸ç®¡ç†è´¹ = çº§åˆ« * 10% * å‡ºäº¬å¤©æ•° / 26
     - **å‡ºå¢ƒç®¡ç†è´¹**:
       - å®¢æˆ·é¢å¤–æ”¯ä»˜ = çº§åˆ« * 20% * å‡ºå¢ƒå¤©æ•° / 26
       - å…¬å¸ç®¡ç†è´¹ = çº§åˆ« * 20% * å‡ºå¢ƒå¤©æ•° / 26
   - **è¯´æ˜**: å¸¦è–ªä¼‘å‡å¤©æ•°ä»…ç”¨äºæ˜¾ç¤º,ä¸å‚ä¸å·¥èµ„è®¡ç®—(å·²åŒ…å«åœ¨å‡ºå‹¤å¤©æ•°å†…)

3. **å…³è”è®°å½•**
   - åœ¨ `AttendanceRecord` ä¸­æ–°å¢å­—æ®µ `attendance_form_data_id`,å…³è”åˆ° `DynamicFormData`
   - åœ¨ `DynamicFormData` ä¸­è®°å½•ç­¾ç½²çŠ¶æ€å’Œç­¾ç½²æ—¶é—´

4. **å¼‚å¸¸å¤„ç†**
   - å¦‚æœå®¢æˆ·æ‹’ç»ç­¾ç½²,ç®¡ç†å‘˜å¯ä»¥ç»§ç»­ä½¿ç”¨ç°æœ‰æ–¹å¼æ‰‹åŠ¨å½•å…¥è€ƒå‹¤æ•°æ®
   - æ‰‹åŠ¨å½•å…¥å’Œç”µå­è¡¨å•ä¸¤ç§æ–¹å¼å¹¶å­˜

### 2.2 æ•°æ®æ¨¡å‹è®¾è®¡

#### 2.2.1 æ–°å¢ AttendanceForm æ¨¡å‹
**è¯´æ˜**: åˆ›å»ºä¸“é—¨çš„ç”µå­è€ƒå‹¤è¡¨æ¨¡å‹,ä¸ä¿®æ”¹é€šç”¨çš„ DynamicFormData è¡¨

```python
class AttendanceForm(db.Model):
    """ç”µå­è€ƒå‹¤è¡¨æ¨¡å‹"""
    __tablename__ = "attendance_forms"
    __table_args__ = (
        db.UniqueConstraint('contract_id', 'cycle_start_date', name='uq_contract_cycle'),
        {"comment": "ç”µå­è€ƒå‹¤è¡¨"}
    )
    
    # ä¸»é”®
    id = db.Column(PG_UUID(as_uuid=True), primary_key=True, default=uuid.uuid4)
    
    # å…³è”ä¿¡æ¯
    contract_id = db.Column(
        PG_UUID(as_uuid=True), 
        db.ForeignKey("contracts.id", ondelete="CASCADE"), 
        nullable=False, 
        index=True,
        comment="å…³è”åˆåŒID"
    )
    employee_id = db.Column(
        PG_UUID(as_uuid=True), 
        nullable=False, 
        index=True,
        comment="å‘˜å·¥ID"
    )
    
    # å‘¨æœŸä¿¡æ¯
    cycle_start_date = db.Column(
        db.DateTime(timezone=True), 
        nullable=False,
        comment="è€ƒå‹¤å‘¨æœŸå¼€å§‹æ—¥æœŸ"
    )
    cycle_end_date = db.Column(
        db.DateTime(timezone=True), 
        nullable=False,
        comment="è€ƒå‹¤å‘¨æœŸç»“æŸæ—¥æœŸ"
    )
    
    # è€ƒå‹¤æ•°æ® (JSONB å­˜å‚¨æ‰€æœ‰è¡¨å•æ•°æ®)
    form_data = db.Column(
        PG_JSONB, 
        nullable=False, 
        server_default='{}',
        comment="è€ƒå‹¤è¡¨å•æ•°æ®,åŒ…å«ä¼‘æ¯ã€è¯·å‡ã€åŠ ç­ã€å‡ºäº¬ã€å‡ºå¢ƒã€å¸¦è–ªä¼‘å‡ç­‰æ‰€æœ‰æ˜ç»†"
    )
    
    # è®¿é—®ä»¤ç‰Œ (ç”¨äºæ— éœ€ç™»å½•è®¿é—®)
    employee_access_token = db.Column(
        db.String(255), 
        nullable=True,
        unique=True, 
        index=True,
        comment="å‘˜å·¥è®¿é—®ä»¤ç‰Œ,ç”¨äºç”Ÿæˆå›ºå®šé“¾æ¥"
    )
    
    # ç­¾ç½²ä»¤ç‰Œ (ç”¨äºå®¢æˆ·æ— éœ€ç™»å½•ç­¾ç½²)
    customer_signature_token = db.Column(
        db.String(255), 
        nullable=True,
        unique=True, 
        index=True,
        comment="å®¢æˆ·ç­¾ç½²ä»¤ç‰Œ,ç”¨äºç”Ÿæˆç­¾ç½²é“¾æ¥"
    )
    
    # çŠ¶æ€ç®¡ç†
    status = db.Column(
        db.String(50), 
        nullable=False,
        default='draft', 
        server_default='draft',
        index=True,
        comment="çŠ¶æ€: draft, employee_confirmed, customer_signed, synced"
    )
    
    # ç­¾ç½²ä¿¡æ¯
    customer_signed_at = db.Column(
        db.DateTime(timezone=True), 
        nullable=True,
        comment="å®¢æˆ·ç­¾ç½²æ—¶é—´"
    )
    signature_data = db.Column(
        PG_JSONB, 
        nullable=True,
        comment="ç­¾ç½²è®°å½•,åŒ…å«ç­¾ç½²äººã€æ—¶é—´ã€IPç­‰ä¿¡æ¯"
    )
    
    # åŒæ­¥çŠ¶æ€
    synced_to_attendance = db.Column(
        db.Boolean, 
        nullable=False,
        default=False, 
        server_default='false',
        comment="æ˜¯å¦å·²åŒæ­¥åˆ°AttendanceRecord"
    )
    attendance_record_id = db.Column(
        PG_UUID(as_uuid=True), 
        db.ForeignKey("attendance_records.id", ondelete="SET NULL"),
        nullable=True,
        comment="å…³è”çš„AttendanceRecord ID"
    )
    
    # æ—¶é—´æˆ³
    created_at = db.Column(
        db.DateTime(timezone=True), 
        nullable=False,
        server_default=db.func.now()
    )
    updated_at = db.Column(
        db.DateTime(timezone=True), 
        nullable=False,
        server_default=db.func.now(), 
        onupdate=db.func.now()
    )
    
    # å…³ç³»
    contract = db.relationship("BaseContract", backref=db.backref("attendance_forms", lazy="dynamic"))
    attendance_record = db.relationship("AttendanceRecord", backref=db.backref("attendance_form", uselist=False))
```

**form_data JSONB å­—æ®µç»“æ„ç¤ºä¾‹**:
```json
{
  "rest_records": [
    {"date": "2025-01-05", "hours": 24, "minutes": 0}
  ],
  "leave_records": [
    {"date": "2025-01-10", "hours": 4, "minutes": 30, "type": "äº‹å‡"}
  ],
  "overtime_records": [
    {"date": "2025-01-15", "hours": 2, "minutes": 0}
  ],
  "beijing_records": [
    {"date": "2025-01-20", "hours": 48, "minutes": 0}
  ],
  "country_records": [],
  "paid_leave_dates": ["2025-01-25"],
  "calculated_stats": {
    "attendance_days": 25.5,
    "rest_days": 1,
    "leave_days": 0.1875,
    "overtime_days": 0.0833,
    "beijing_days": 2,
    "country_days": 0
  }
}
```

#### 2.2.2 AttendanceRecord æ¨¡å‹æ‰©å±•
```python
# æ–°å¢å­—æ®µ: å‡ºäº¬å‡ºå¢ƒå¤©æ•°
out_of_beijing_days = db.Column(
    db.Numeric(10, 3),
    nullable=True,
    default=0,
    comment="å‡ºäº¬å¤©æ•°(ç²¾ç¡®åˆ°0.001å¤©)"
)

out_of_country_days = db.Column(
    db.Numeric(10, 3),
    nullable=True,
    default=0,
    comment="å‡ºå¢ƒå¤©æ•°(ç²¾ç¡®åˆ°0.001å¤©)"
)

# æ–°å¢å­—æ®µ: å…³è”è€ƒå‹¤è¡¨å•
attendance_form_id = db.Column(
    PG_UUID(as_uuid=True),
    db.ForeignKey("attendance_forms.id", ondelete="SET NULL"),
    nullable=True,
    comment="å…³è”çš„ç”µå­è€ƒå‹¤è¡¨ID"
)

# æ–°å¢å­—æ®µ:è¯¦ç»†è€ƒå‹¤æ•°æ®(JSONB,ç”¨äºæ˜¾ç¤º)
attendance_details = db.Column(
    PG_JSONB,
    nullable=True,
    comment="è¯¦ç»†è€ƒå‹¤æ•°æ®,åŒ…å«å¸¦è–ªä¼‘å‡ç­‰æ˜ç»†(ä»…ç”¨äºæ˜¾ç¤º)"
)
```

### 2.3 API æ¥å£è®¾è®¡
```json
{
  "title": "å‘˜å·¥è€ƒå‹¤è¡¨",
  "pages": [
    {
      "name": "basic_info",
      "title": "åŸºç¡€ä¿¡æ¯",
      "elements": [
        {
          "type": "text",
          "name": "employee_name",
          "title": "å‘˜å·¥å§“å",
          "readOnly": true
        },
        {
          "type": "text",
          "name": "customer_name",
          "title": "å®¢æˆ·å§“å",
          "readOnly": true
        },
        {
          "type": "text",
          "name": "contract_id",
          "title": "åˆåŒç¼–å·",
          "readOnly": true
        },
        {
          "type": "text",
          "name": "cycle_period",
          "title": "è€ƒå‹¤å‘¨æœŸ",
          "readOnly": true
        }
      ]
    },
    {
      "name": "attendance_details",
      "title": "è€ƒå‹¤æ˜ç»†",
      "elements": [
        {
          "type": "paneldynamic",
          "name": "leave_records",
          "title": "è¯·å‡è®°å½•",
          "templateElements": [
            {
              "type": "text",
              "name": "leave_date",
              "title": "è¯·å‡æ—¥æœŸ",
              "inputType": "date"
            },
            {
              "type": "text",
              "name": "leave_hours",
              "title": "è¯·å‡æ—¶é•¿(å°æ—¶)",
              "inputType": "number"
            },
            {
              "type": "text",
              "name": "leave_minutes",
              "title": "è¯·å‡æ—¶é•¿(åˆ†é’Ÿ)",
              "inputType": "number"
            },
            {
              "type": "dropdown",
              "name": "leave_type",
              "title": "è¯·å‡ç±»å‹",
              "choices": ["äº‹å‡", "ç—…å‡", "å¹´å‡", "å…¶ä»–"]
            }
          ]
        },
        {
          "type": "paneldynamic",
          "name": "overtime_records",
          "title": "åŠ ç­è®°å½•",
          "templateElements": [
            {
              "type": "text",
              "name": "overtime_date",
              "title": "åŠ ç­æ—¥æœŸ",
              "inputType": "date"
            },
            {
              "type": "text",
              "name": "overtime_hours",
              "title": "åŠ ç­æ—¶é•¿(å°æ—¶)",
              "inputType": "number"
            },
            {
              "type": "text",
              "name": "overtime_minutes",
              "title": "åŠ ç­æ—¶é•¿(åˆ†é’Ÿ)",
              "inputType": "number"
            },
            {
              "type": "dropdown",
              "name": "overtime_type",
              "title": "åŠ ç­ç±»å‹",
              "choices": ["å¹³æ—¥åŠ ç­", "èŠ‚å‡æ—¥åŠ ç­"]
            }
          ]
        },
        {
          "type": "paneldynamic",
          "name": "out_of_beijing_records",
          "title": "å‡ºäº¬è®°å½•",
          "templateElements": [
            {
              "type": "text",
              "name": "out_date",
              "title": "å‡ºäº¬æ—¥æœŸ",
              "inputType": "date"
            },
            {
              "type": "text",
              "name": "out_hours",
              "title": "å‡ºäº¬æ—¶é•¿(å°æ—¶)",
              "inputType": "number"
            }
          ]
        },
        {
          "type": "paneldynamic",
          "name": "out_of_country_records",
          "title": "å‡ºå¢ƒè®°å½•",
          "templateElements": [
            {
              "type": "text",
              "name": "out_date",
              "title": "å‡ºå¢ƒæ—¥æœŸ",
              "inputType": "date"
            },
            {
              "type": "text",
              "name": "out_hours",
              "title": "å‡ºå¢ƒæ—¶é•¿(å°æ—¶)",
              "inputType": "number"
            }
          ]
        },
        {
          "type": "text",
          "name": "paid_leave_dates",
          "title": "å¸¦è–ªä¼‘å‡æ—¥æœŸ(å¤šä¸ªæ—¥æœŸç”¨é€—å·åˆ†éš”)",
          "inputType": "text"
        }
      ]
    },
    {
      "name": "summary",
      "title": "ç»Ÿè®¡æ±‡æ€»",
      "elements": [
        {
          "type": "expression",
          "name": "total_leave_days",
          "title": "è¯·å‡æ€»å¤©æ•°",
          "expression": "è®¡ç®—é€»è¾‘"
        },
        {
          "type": "expression",
          "name": "total_overtime_days",
          "title": "åŠ ç­æ€»å¤©æ•°",
          "expression": "è®¡ç®—é€»è¾‘"
        }
      ]
    }
  ]
}
```

### 2.3 API æ¥å£è®¾è®¡

#### 2.3.1 è€ƒå‹¤è¡¨ç®¡ç†æ¥å£(æ— éœ€ç™»å½•)
```
GET    /api/attendance-forms/by-token/<employee_token>  # å‘˜å·¥é€šè¿‡ä»¤ç‰Œè®¿é—®è€ƒå‹¤è¡¨
       # ç³»ç»Ÿè‡ªåŠ¨è¯†åˆ«å‘˜å·¥å¹¶å…³è”å…¶å½“å‰æ´»è·ƒåˆåŒ
       # è¿”å› AttendanceForm æ•°æ®,åŒ…å«è‡ªåŠ¨å¡«å……çš„åŸºç¡€ä¿¡æ¯
PUT    /api/attendance-forms/by-token/<employee_token>  # å‘˜å·¥æ›´æ–°è€ƒå‹¤è¡¨
       # æ›´æ–° AttendanceForm.form_data å­—æ®µ
POST   /api/attendance-forms/by-token/<employee_token>/confirm  # å‘˜å·¥ç¡®è®¤å¹¶ç”Ÿæˆç­¾ç½²é“¾æ¥
       # æ›´æ–° status ä¸º 'employee_confirmed'
       # ç”Ÿæˆ customer_signature_token
```

**è‡ªåŠ¨å…³è”åˆåŒé€»è¾‘**:
1. æ ¹æ® `employee_token` æŸ¥æ‰¾å¯¹åº”çš„ AttendanceForm
2. å¦‚æœä¸å­˜åœ¨,æŸ¥è¯¢å‘˜å·¥å½“å‰æ´»è·ƒçš„åˆåŒ(status = 'active')
3. è‡ªåŠ¨åˆ›å»º AttendanceForm è®°å½•,å¡«å……å®¢æˆ·å§“åã€åˆåŒç¼–å·ç­‰åŸºç¡€ä¿¡æ¯
4. æ ¹æ®å½“å‰æ—¥æœŸç¡®å®šè€ƒå‹¤å‘¨æœŸ(å½“æœˆå¡«ä¸Šæœˆ)

#### 2.3.2 ç­¾ç½²æ¥å£(æ— éœ€ç™»å½•)
```
GET    /api/attendance-forms/sign/<signature_token>  # å®¢æˆ·æŸ¥çœ‹è€ƒå‹¤è¡¨
       # æ ¹æ® customer_signature_token æŸ¥æ‰¾ AttendanceForm
POST   /api/attendance-forms/sign/<signature_token>  # å®¢æˆ·ç­¾ç½²è€ƒå‹¤è¡¨
       # æ›´æ–° status ä¸º 'customer_signed'
       # è®°å½• signature_data å’Œ customer_signed_at
       # è§¦å‘æ•°æ®åŒæ­¥
GET    /api/attendance-forms/<form_id>/pdf      # è·å–ç­¾ç½²åçš„PDF
```

#### 2.3.3 ç®¡ç†å‘˜æ¥å£(éœ€è¦ç™»å½•)
```
GET    /api/admin/attendance-forms                    # æŸ¥è¯¢è€ƒå‹¤è¡¨åˆ—è¡¨
       # æ”¯æŒæŒ‰æœˆç­›é€‰,è¿”å› AttendanceForm åˆ—è¡¨
POST   /api/admin/attendance-forms/create             # åˆ›å»ºè€ƒå‹¤è¡¨
GET    /api/admin/attendance-forms/<form_id>          # æŸ¥çœ‹è€ƒå‹¤è¡¨è¯¦æƒ…
PUT    /api/admin/attendance-forms/<form_id>          # ä¿®æ”¹è€ƒå‹¤è¡¨
POST   /api/admin/attendance-forms/<form_id>/sync     # æ‰‹åŠ¨åŒæ­¥åˆ°è€ƒå‹¤è®°å½•
```

### 2.4 å‰ç«¯ç•Œé¢éœ€æ±‚

#### 2.4.0 å‰ç«¯æŠ€æœ¯æ ˆ
**UI ç»„ä»¶åº“**: ä½¿ç”¨ **shadcn/ui** ç»„ä»¶åº“å¼€å‘æ–°ç•Œé¢
- è€ƒå‹¤è¡¨å¡«å†™é¡µé¢ä½¿ç”¨ shadcn ç»„ä»¶
- è€ƒå‹¤è¡¨ç­¾ç½²é¡µé¢ä½¿ç”¨ shadcn ç»„ä»¶
- è€ƒå‹¤è¡¨åˆ—è¡¨é¡µé¢ä½¿ç”¨ shadcn ç»„ä»¶
- ä¿æŒä¸ç°æœ‰ç³»ç»Ÿçš„è§†è§‰ä¸€è‡´æ€§

**æ—¥å†ç»„ä»¶**: ä½¿ç”¨ **react-calendar** æˆ– shadcn Calendar
- æ”¯æŒå¤šé€‰æ—¥æœŸ
- è‡ªå®šä¹‰æ ·å¼å’Œé¢œè‰²
- å®æ—¶å¯è§†åŒ–åé¦ˆ

**è¡¨å•å¤„ç†**: **çº¯è‡ªå®šä¹‰è¡¨å•**(ä¸ä½¿ç”¨ SurveyJS)
- ä½¿ç”¨ shadcn Form ç»„ä»¶
- è‡ªå®šä¹‰éªŒè¯é€»è¾‘
- ç›´æ¥ä¿å­˜ JSON åˆ° AttendanceForm.form_data

#### 2.4.1 è€ƒå‹¤è¡¨å¡«å†™é¡µé¢(çº¯è‡ªå®šä¹‰è¡¨å•)
- ä½¿ç”¨ **shadcn Card, Form, Button, Calendar, Input** ç»„ä»¶
- **æ—¥å†ç»„ä»¶**: 
  - ä½¿ç”¨ react-calendar æ˜¾ç¤ºå½“æœˆæ—¥å†
  - æ”¯æŒå¤šé€‰æ—¥æœŸ(ä¼‘æ¯ã€è¯·å‡ã€åŠ ç­ç­‰)
  - è‡ªå®šä¹‰æ ·å¼,ç”¨ä¸åŒé¢œè‰²æ ‡ç¤ºä¸åŒçŠ¶æ€
- **è¡¨å•å­—æ®µ**:
  - ä¼‘æ¯æ—¥æœŸé€‰æ‹© + æ—¶é•¿è¾“å…¥
  - è¯·å‡æ—¥æœŸé€‰æ‹© + æ—¶é•¿è¾“å…¥ + ç±»å‹é€‰æ‹©
  - åŠ ç­æ—¥æœŸé€‰æ‹© + æ—¶é•¿è¾“å…¥
  - å‡ºäº¬æ—¥æœŸé€‰æ‹© + æ—¶é•¿è¾“å…¥
  - å‡ºå¢ƒæ—¥æœŸé€‰æ‹© + æ—¶é•¿è¾“å…¥
  - å¸¦è–ªä¼‘å‡æ—¥æœŸé€‰æ‹©
- **å®æ—¶è®¡ç®—**: æ ¹æ®é€‰æ‹©çš„æ—¥æœŸè‡ªåŠ¨è®¡ç®—å‡ºå‹¤å¤©æ•°
- **å¯è§†åŒ–é¢„è§ˆ**: æ—¥å†ä¸Šå®æ—¶æ˜¾ç¤ºä¸åŒé¢œè‰²æ ‡ç¤º
- **æ•°æ®éªŒè¯**: å®æ—¶éªŒè¯å¹¶æ˜¾ç¤ºå‹å¥½æç¤º
- æ”¯æŒä¿å­˜è‰ç¨¿(shadcn Button + Toast æç¤º)
- æäº¤å‰è¿›è¡Œæ•°æ®éªŒè¯(shadcn Alert æ˜¾ç¤ºé”™è¯¯)

#### 2.4.2 è´¦å•è¯¦æƒ…é¡µé¢ (FinancialManagementModal)
**åŠŸèƒ½**:
- åœ¨è´¦å•è¯¦æƒ…ä¸­æ˜¾ç¤ºè¯¦ç»†çš„è€ƒå‹¤ç»Ÿè®¡ä¿¡æ¯ã€‚
- **æ˜¾ç¤ºå­—æ®µ**:
  - å‡ºäº¬å¤©æ•° (`out_of_beijing_days`)
  - å‡ºå¢ƒå¤©æ•° (`out_of_country_days`)
  - è¯·å‡å¤©æ•° (`leave_days`)
  - å¸¦è–ªä¼‘å‡å¤©æ•° (`paid_leave_days`)
  - ä¼‘æ¯å¤©æ•° (`rest_days`)
- **æ˜¾ç¤ºè§„åˆ™**:
  - ä»…å½“æ•°å€¼å¤§äº 0 æ—¶æ˜¾ç¤ºã€‚
  - æ•°æ®æ¥æº: `AttendanceRecord` åŠå…¶ `attendance_details` å­—æ®µã€‚

**æ•°æ®ç»“æ„**:
```javascript
const formData = {
  rest_records: [{date: '2025-01-05', hours: 24, minutes: 0}],
  leave_records: [{date: '2025-01-10', hours: 4, minutes: 30, type: 'äº‹å‡'}],
  overtime_records: [{date: '2025-01-15', hours: 2, minutes: 0}],
  beijing_records: [{date: '2025-01-20', hours: 48, minutes: 0}],
  country_records: [],
  paid_leave_dates: ['2025-01-25'],
  calculated_stats: {
    attendance_days: 25.5,
    rest_days: 1,
    leave_days: 0.1875,
    overtime_days: 0.0833,
    beijing_days: 2,
    country_days: 0
  }
};
// ç›´æ¥ä¿å­˜åˆ° AttendanceForm.form_data
```

#### 2.4.2 è€ƒå‹¤è¡¨é¢„è§ˆå’Œç­¾ç½²é¡µé¢
- ä½¿ç”¨ **shadcn Card, Calendar, Badge** ç»„ä»¶
- **æ—¥å†å¯è§†åŒ–**: æ˜¾ç¤ºå½“æœˆå®Œæ•´æ—¥å†,ç”¨ä¸åŒé¢œè‰²/å›¾æ ‡æ ‡ç¤º:
  - ğŸŸ¢ å‡ºå‹¤æ—¥(ç»¿è‰²)
  - ğŸ”´ ä¼‘æ¯æ—¥(çº¢è‰²)
  - ğŸŸ¡ è¯·å‡æ—¥(é»„è‰²,æ˜¾ç¤ºè¯·å‡ç±»å‹)
  - ğŸ”µ åŠ ç­æ—¥(è“è‰²,æ˜¾ç¤ºåŠ ç­æ—¶é•¿)
  - ğŸŸ  å‡ºäº¬æ—¥(æ©™è‰²,æ˜¾ç¤ºæ—¶é•¿)
  - ğŸŸ£ å‡ºå¢ƒæ—¥(ç´«è‰²,æ˜¾ç¤ºæ—¶é•¿)
  - ğŸ’š å¸¦è–ªä¼‘å‡æ—¥(æ·±ç»¿è‰²)
- **æ–‡å­—æ˜ç»†**: æ—¥å†ä¸‹æ–¹ç”¨æ–‡å­—åˆ—è¡¨å±•ç¤ºå„é¡¹ç»Ÿè®¡
- ç”µå­ç­¾åç»„ä»¶(å¤ç”¨ç°æœ‰)

#### 2.4.3 è¿è¥äººå‘˜è€ƒå‹¤è¡¨åˆ—è¡¨é¡µé¢
- ä½¿ç”¨ **shadcn Table, Select, DatePicker, Badge** ç»„ä»¶
- **æŒ‰æœˆæŸ¥çœ‹**: é»˜è®¤æ˜¾ç¤ºå½“æœˆ,å¯åˆ‡æ¢å…¶ä»–æœˆä»½
- **åˆ—è¡¨å†…å®¹**:
  - åˆ—å‡ºå½“æœˆæ‰€æœ‰è¿›è¡Œä¸­åˆåŒçš„å‘˜å·¥å§“å
  - å®¢æˆ·å§“å
  - è€ƒå‹¤è¡¨çŠ¶æ€(ä½¿ç”¨ Badge æ˜¾ç¤º):
    - "å‘˜å·¥æœªå¡«å†™" (ç°è‰²)
    - "å®¢æˆ·æœªç­¾ç½²" (é»„è‰²)
    - "å®¢æˆ·å·²ç­¾ç½²" (ç»¿è‰²)
    - "å·²åŒæ­¥" (è“è‰²)
- **æ“ä½œåŠŸèƒ½**:
  - **æŸ¥çœ‹æŒ‰é’®**: æŸ¥çœ‹ç”Ÿæˆåçš„ç”µå­è€ƒå‹¤è¡¨å’Œç­¾ç½²ç»“æœ(ç±»ä¼¼"é¢„è§ˆåˆåŒ")
  - **ä¸‹è½½æŒ‰é’®**: ä¸‹è½½è€ƒå‹¤è¡¨PDF(ç±»ä¼¼"ä¸‹è½½åˆåŒ",å¤ç”¨ç°æœ‰PDFåº“)
- **çŠ¶æ€è¯´æ˜**:
  - å‘˜å·¥å¡«å†™å¹¶ç”Ÿæˆé¢„è§ˆå,çŠ¶æ€æ˜¾ç¤ºä¸º"å®¢æˆ·æœªç­¾ç½²"
  - å®¢æˆ·ç­¾ç½²å,çŠ¶æ€æ˜¾ç¤ºä¸º"å®¢æˆ·å·²ç­¾ç½²"
  - æ•°æ®åŒæ­¥å,çŠ¶æ€æ˜¾ç¤ºä¸º"å·²åŒæ­¥"

#### 2.4.4 å·¥èµ„å•å’Œè´¦å•é¡µé¢å¢å¼º
- åœ¨å‘˜å·¥å·¥èµ„å•(EmployeePayroll)é¡µé¢æ˜¾ç¤ºæ–°å¢å­—æ®µ:
  - å‡ºäº¬å¤©æ•°(ä»…å½“å€¼ > 0æ—¶æ˜¾ç¤º)
  - å‡ºå¢ƒå¤©æ•°(ä»…å½“å€¼ > 0æ—¶æ˜¾ç¤º)
  - å¸¦è–ªä¼‘å‡å¤©æ•°(ä»…å½“å€¼ > 0æ—¶æ˜¾ç¤º)
  - è¯·å‡å¤©æ•°(ä»…å½“å€¼ > 0æ—¶æ˜¾ç¤º)
- åœ¨å®¢æˆ·è´¦å•(CustomerBill)é¡µé¢æ˜¾ç¤ºæ–°å¢å­—æ®µ:
  - å‡ºäº¬ç®¡ç†è´¹(ä»…å½“å‡ºäº¬å¤©æ•° > 0æ—¶æ˜¾ç¤º)
  - å‡ºå¢ƒç®¡ç†è´¹(ä»…å½“å‡ºå¢ƒå¤©æ•° > 0æ—¶æ˜¾ç¤º)
- ä½¿ç”¨ shadcn Badge æˆ– Card ç»„ä»¶å±•ç¤ºè¿™äº›ä¿¡æ¯

#### 2.4.5 è€ƒå‹¤è¡¨ç­¾ç½²é¡µé¢
- ä½¿ç”¨ **shadcn Card, Dialog, Button** ç»„ä»¶
- æ˜¾ç¤ºè€ƒå‹¤è¡¨å†…å®¹é¢„è§ˆ(shadcn ScrollArea)
- ç”µå­ç­¾åç»„ä»¶(é›†æˆç¬¬ä¸‰æ–¹ç­¾ååº“)
- ç­¾ç½²ç¡®è®¤æµç¨‹(shadcn AlertDialog)
- ç­¾ç½²æˆåŠŸæç¤º(shadcn Toast)

## 3. éåŠŸèƒ½æ€§éœ€æ±‚

### 3.1 æ€§èƒ½è¦æ±‚
- è€ƒå‹¤è¡¨åŠ è½½æ—¶é—´ < 2ç§’
- ç­¾ç½²æ“ä½œå“åº”æ—¶é—´ < 1ç§’
- æ”¯æŒå¹¶å‘ç­¾ç½²

### 3.2 å®‰å…¨è¦æ±‚
- å‘˜å·¥åªèƒ½è®¿é—®è‡ªå·±çš„è€ƒå‹¤è¡¨
- ç­¾ç½²æ“ä½œéœ€è¦èº«ä»½éªŒè¯
- ç­¾ç½²è®°å½•ä¸å¯ç¯¡æ”¹

### 3.3 æ•°æ®å®Œæ•´æ€§
- ç­¾ç½²åçš„è€ƒå‹¤è¡¨ä¸å¯ä¿®æ”¹
- è€ƒå‹¤æ•°æ®åŒæ­¥åˆ° AttendanceRecord å,ä¿æŒä¸€è‡´æ€§
- æ”¯æŒæ•°æ®å›æ»šå’Œå®¡è®¡

## 4. è¾¹ç•Œæ¡ä»¶ä¸çº¦æŸ

### 4.1 ä¸šåŠ¡çº¦æŸ
1. ä¸€ä¸ªåˆåŒçš„ä¸€ä¸ªè®¡è´¹å‘¨æœŸåªèƒ½æœ‰ä¸€å¼ è€ƒå‹¤è¡¨
2. è€ƒå‹¤è¡¨å¿…é¡»åŒæ–¹ç­¾ç½²åæ‰èƒ½åŒæ­¥åˆ°å·¥èµ„å•
3. å·²åŒæ­¥çš„è€ƒå‹¤è¡¨ä¸èƒ½å†æ¬¡ä¿®æ”¹

### 4.2 æŠ€æœ¯çº¦æŸ
1. å¤ç”¨ç°æœ‰çš„ DynamicForm ç³»ç»Ÿ
2. ä¸ä¿®æ”¹ç°æœ‰çš„å·¥èµ„è®¡ç®—é€»è¾‘,åªä¿®æ”¹è€ƒå‹¤æ•°æ®æ¥æº
3. ç­¾ç½²åŠŸèƒ½å¯ä»¥å¤ç”¨ç°æœ‰çš„åˆåŒç­¾ç½²é€»è¾‘

### 4.3 æ•°æ®è¿ç§»
1. ç°æœ‰çš„ AttendanceRecord æ•°æ®ä¿æŒä¸å˜
2. æ–°ç³»ç»Ÿä¸Šçº¿å,é€æ­¥è¿ç§»åˆ°ç”µå­è€ƒå‹¤è¡¨æµç¨‹
3. æ”¯æŒæ‰‹åŠ¨å½•å…¥å’Œç”µå­è¡¨å•ä¸¤ç§æ–¹å¼å¹¶å­˜

## 5. ç”¨æˆ·åœºæ™¯

### 5.1 åœºæ™¯1: å‘˜å·¥å¡«å†™è€ƒå‹¤è¡¨(æ— éœ€ç™»å½•)
1. è¿è¥äººå‘˜å°†å‘˜å·¥çš„å›ºå®šè€ƒå‹¤è¡¨é“¾æ¥å‘é€ç»™å‘˜å·¥
2. å‘˜å·¥ç‚¹å‡»é“¾æ¥,ç›´æ¥è¿›å…¥è€ƒå‹¤è¡¨å¡«å†™é¡µé¢(æ— éœ€ç™»å½•)
3. ç³»ç»Ÿè‡ªåŠ¨æ˜¾ç¤ºå½“å‰éœ€è¦å¡«å†™çš„å‘¨æœŸ(å½“æœˆå¡«ä¸Šæœˆ)å’Œå½“æœˆæ—¥å†
4. å‘˜å·¥é€šè¿‡æ—¥å†é€‰æ‹©å¡«å†™è€ƒå‹¤æ•°æ®:
   - é€‰æ‹©ä¼‘æ¯æ—¥æœŸ,å¹¶å¡«å†™æ¯å¤©çš„ä¼‘æ¯æ—¶é•¿(é»˜è®¤24å°æ—¶è¡¨ç¤ºå…¨å¤©ä¼‘æ¯)
   - é€‰æ‹©è¯·å‡æ—¥æœŸ,å¹¶å¡«å†™æ¯å¤©çš„è¯·å‡æ—¶é•¿å’Œç±»å‹
   - é€‰æ‹©åŠ ç­æ—¥æœŸ,å¹¶å¡«å†™æ¯å¤©çš„åŠ ç­æ—¶é•¿å’Œç±»å‹
   - é€‰æ‹©å‡ºäº¬æ—¥æœŸ,å¹¶å¡«å†™æ¯å¤©çš„å‡ºäº¬æ—¶é•¿
   - é€‰æ‹©å‡ºå¢ƒæ—¥æœŸ,å¹¶å¡«å†™æ¯å¤©çš„å‡ºå¢ƒæ—¶é•¿
   - é€‰æ‹©å¸¦è–ªä¼‘å‡æ—¥æœŸ
5. ç³»ç»Ÿå®æ—¶è®¡ç®—å¹¶æ˜¾ç¤º:
   - å‡ºå‹¤å¤©æ•° = å½“æœˆæ€»å¤©æ•° - è¯·å‡å¤©æ•° - ä¼‘æ¯å¤©æ•°(è‡ªåŠ¨è®¡ç®—,å«å¸¦è–ªä¼‘å‡ã€å‡ºäº¬ã€å‡ºå¢ƒ)
   - å„é¡¹ç»Ÿè®¡æ•°æ®
   - æ—¥å†ä¸Šç”¨ä¸åŒé¢œè‰²æ ‡ç¤ºå„ç±»çŠ¶æ€
6. ç³»ç»ŸéªŒè¯æ•°æ®åˆç†æ€§:
   - éªŒè¯è§„åˆ™: å‡ºå‹¤å¤©æ•° + ä¼‘æ¯å¤©æ•° + è¯·å‡å¤©æ•° = å½“æœˆæ€»å¤©æ•°
   - å‹å¥½æç¤º: "å‡ºå‹¤å¤©æ•°(å«å¸¦è–ªä¼‘å‡ã€å‡ºäº¬ã€å‡ºå¢ƒ) + ä¼‘æ¯å¤©æ•° + è¯·å‡å¤©æ•° åº”ç­‰äºå½“æœˆæ€»å¤©æ•°"
7. å‘˜å·¥é¢„è§ˆæ—¥å†å¯è§†åŒ–æ•ˆæœ
8. å‘˜å·¥ä¿å­˜è‰ç¨¿æˆ–ç¡®è®¤æäº¤

### 5.2 åœºæ™¯2: å‘˜å·¥ç”Ÿæˆå¹¶å‘é€ç­¾ç½²é“¾æ¥
1. å‘˜å·¥å¡«å†™å®Œæˆå,é¢„è§ˆè€ƒå‹¤è¡¨(åŒ…å«å…¬å¸logo)
2. å‘˜å·¥ç¡®è®¤æ— è¯¯å,ç‚¹å‡»"ç”Ÿæˆç­¾ç½²é“¾æ¥"
3. ç³»ç»Ÿç”Ÿæˆå®¢æˆ·ç­¾ç½²é“¾æ¥å’ŒPDFé¢„è§ˆ
4. é¡µé¢æ˜¾ç¤º"å¤åˆ¶é“¾æ¥"æŒ‰é’®
5. å‘˜å·¥ç‚¹å‡»"å¤åˆ¶é“¾æ¥",ç³»ç»Ÿè‡ªåŠ¨å¤åˆ¶é“¾æ¥åˆ°å‰ªè´´æ¿
6. **å‘˜å·¥è‡ªå·±**å°†é“¾æ¥å‘é€ç»™å®¢æˆ·(é€šè¿‡å¾®ä¿¡ã€çŸ­ä¿¡ç­‰)
7. å‘˜å·¥ç­¾ç½²å®Œæˆåå‘ŠçŸ¥è¿è¥äººå‘˜

### 5.3 åœºæ™¯3: å®¢æˆ·ç­¾ç½²è€ƒå‹¤è¡¨(æ— éœ€ç™»å½•)
1. å®¢æˆ·æ”¶åˆ°å‘˜å·¥å‘é€çš„ç­¾ç½²é“¾æ¥
2. å®¢æˆ·ç‚¹å‡»é“¾æ¥,ç›´æ¥è¿›å…¥ç­¾ç½²é¡µé¢(æ— éœ€ç™»å½•,é¡µé¢åŒ…å«å…¬å¸logo)
3. å®¢æˆ·æŸ¥çœ‹è€ƒå‹¤è¡¨å†…å®¹(æ—¥å†å¯è§†åŒ–)å’ŒPDFé¢„è§ˆ
4. å®¢æˆ·ç¡®è®¤å,ä½¿ç”¨ç”µå­ç­¾ååŠŸèƒ½ç­¾ç½²(å¤ç”¨ç°æœ‰ç­¾åç»„ä»¶)
5. ç­¾ç½²å®Œæˆå,è€ƒå‹¤è¡¨çŠ¶æ€å˜ä¸º"å®¢æˆ·å·²ç­¾ç½²"
6. ç³»ç»Ÿè‡ªåŠ¨è§¦å‘æ•°æ®åŒæ­¥åˆ° AttendanceRecord

### 5.4 åœºæ™¯4: è¿è¥äººå‘˜æŸ¥çœ‹è€ƒå‹¤è¡¨
1. è¿è¥äººå‘˜ç™»å½•ç³»ç»Ÿ,è¿›å…¥è€ƒå‹¤è¡¨åˆ—è¡¨é¡µé¢
2. é€‰æ‹©æŸ¥çœ‹å½“æœˆè€ƒå‹¤è¡¨
3. åˆ—è¡¨æ˜¾ç¤ºæ‰€æœ‰è¿›è¡Œä¸­åˆåŒçš„å‘˜å·¥å’Œå®¢æˆ·
4. æŸ¥çœ‹æ¯ä¸ªè€ƒå‹¤è¡¨çš„çŠ¶æ€(å‘˜å·¥æœªå¡«å†™/å®¢æˆ·æœªç­¾ç½²/å®¢æˆ·å·²ç­¾ç½²/å·²åŒæ­¥)
5. ç‚¹å‡»"æŸ¥çœ‹"æŒ‰é’®,æŸ¥çœ‹è€ƒå‹¤è¡¨è¯¦æƒ…å’Œç­¾ç½²ç»“æœ
6. ç‚¹å‡»"ä¸‹è½½"æŒ‰é’®,ä¸‹è½½è€ƒå‹¤è¡¨PDF

### 5.5 åœºæ™¯5: å·¥èµ„å•è‡ªåŠ¨æ›´æ–°(åŒ…å«å‡ºäº¬å‡ºå¢ƒç®¡ç†è´¹)
1. å®¢æˆ·ç­¾ç½²å®Œæˆå,ç³»ç»Ÿè‡ªåŠ¨åŒæ­¥æ•°æ®
2. å°†è€ƒå‹¤è¡¨æ•°æ®è½¬æ¢å¹¶ä¿å­˜åˆ° `AttendanceRecord`:
   - å‡ºå‹¤å¤©æ•°
   - åŠ ç­å¤©æ•°
   - å‡ºäº¬å¤©æ•°
   - å‡ºå¢ƒå¤©æ•°
3. è§¦å‘è¯¥å‘¨æœŸçš„å·¥èµ„å•é‡ç®—
4. `BillingEngine` é‡æ–°è®¡ç®—å·¥èµ„,åŒ…æ‹¬:
   - åŸºç¡€å·¥èµ„
   - åŠ ç­è´¹
   - **å‡ºäº¬ç®¡ç†è´¹**: å®¢æˆ·é¢å¤–æ”¯ä»˜10%,å…¬å¸æ”¶å–10%
   - **å‡ºå¢ƒç®¡ç†è´¹**: å®¢æˆ·é¢å¤–æ”¯ä»˜20%,å…¬å¸æ”¶å–20%
5. å·¥èµ„å•æ›´æ–°å®Œæˆ,ç®¡ç†å‘˜å¯æŸ¥çœ‹
6. å·¥èµ„å•é¡µé¢æ˜¾ç¤ºæ–°å¢å­—æ®µ(ä»…å½“å€¼>0æ—¶):
   - å‡ºäº¬å¤©æ•°å’Œç®¡ç†è´¹
   - å‡ºå¢ƒå¤©æ•°å’Œç®¡ç†è´¹
   - å¸¦è–ªä¼‘å‡å¤©æ•°
   - è¯·å‡å¤©æ•°

### 5.6 åœºæ™¯6: å®¢æˆ·æ‹’ç»ç­¾ç½²çš„å¼‚å¸¸å¤„ç†
1. å®¢æˆ·æ”¶åˆ°ç­¾ç½²é“¾æ¥ä½†æ‹’ç»ç­¾ç½²
2. å®¢æˆ·è”ç³»å‘˜å·¥è¯´æ˜é—®é¢˜
3. å¦‚éœ€ä¿®æ”¹,å‘˜å·¥é‡æ–°å¡«å†™è€ƒå‹¤è¡¨å¹¶é‡æ–°å‘é€é“¾æ¥
4. å¦‚å®¢æˆ·åšæŒæ‹’ç»,ç®¡ç†å‘˜å¯ä»¥:
   - ç»§ç»­ä½¿ç”¨ç°æœ‰æ–¹å¼æ‰‹åŠ¨å½•å…¥è€ƒå‹¤æ•°æ®
   - åœ¨å·¥èµ„å•ä¸­æ‰‹åŠ¨å¡«å†™åŠ ç­æ—¶é—´ç­‰ä¿¡æ¯

## 6. å·²ç¡®è®¤çš„ä¸šåŠ¡è§„åˆ™

ä»¥ä¸‹é—®é¢˜å·²ä¸ç”¨æˆ·ç¡®è®¤å¹¶æ˜ç¡®:

1. **è€ƒå‹¤è¡¨çš„ç”Ÿæˆæ—¶æœº**: âœ… **å·²ç¡®è®¤**
   - å‘˜å·¥é€šè¿‡å›ºå®šé“¾æ¥è®¿é—®,ç³»ç»Ÿæ ¹æ®å½“å‰æ—¥æœŸè‡ªåŠ¨è¯†åˆ«å‘¨æœŸ
   - å½“æœˆå¡«å†™ä¸Šä¸ªæœˆçš„è€ƒå‹¤è¡¨(ä¾‹å¦‚2æœˆå¡«1æœˆçš„)

2. **ç­¾ç½²é¡ºåº**: âœ… **å·²ç¡®è®¤**
   - æ— éœ€å‘˜å·¥ç­¾ç½²,å‘˜å·¥å¡«å†™å¹¶é¢„è§ˆç¡®è®¤åç”Ÿæˆç­¾ç½²é“¾æ¥
   - ä»…å®¢æˆ·ç­¾ç½²,ç­¾ç½²åå³ç”Ÿæ•ˆ

3. **å‡ºäº¬è®°å½•å½±å“**: âœ… **å·²ç¡®è®¤**
   - å®¢æˆ·é¢å¤–æ”¯ä»˜10%å·¥èµ„
   - å…¬å¸æ”¶å–é¢å¤–10%ç®¡ç†è´¹
   - è®¡ç®—å…¬å¼: çº§åˆ« * 10% * å‡ºäº¬å¤©æ•° / 26

4. **å‡ºå¢ƒè®°å½•å½±å“**: âœ… **å·²ç¡®è®¤**
   - å®¢æˆ·é¢å¤–æ”¯ä»˜20%å·¥èµ„
   - å…¬å¸æ”¶å–é¢å¤–20%ç®¡ç†è´¹
   - è®¡ç®—å…¬å¼: çº§åˆ« * 20% * å‡ºå¢ƒå¤©æ•° / 26

5. **å¸¦è–ªä¼‘å‡è§„åˆ™**: âœ… **å·²ç¡®è®¤**
   - å¸¦è–ªä¼‘å‡è®¡å…¥å‡ºå‹¤å¤©æ•°
   - ä¾‹å¦‚: å‡ºå‹¤26å¤©,å…¶ä¸­1å¤©ä¸ºå¸¦è–ªä¼‘å‡

6. **è¯·å‡æ‰£æ¬¾è§„åˆ™**: âœ… **å·²ç¡®è®¤**
   - è¯·å‡ä¸æ‰£æ¬¾,ä»…ç”¨äºè¾…åŠ©æ ¸å¯¹å‡ºå‹¤å¤©æ•°
   - æ•°æ®éªŒè¯: å‡ºå‹¤å¤©æ•° + è¯·å‡å¤©æ•° + å‡ºäº¬å¤©æ•° + å‡ºå¢ƒå¤©æ•° â‰¤ å½“æœˆè‡ªç„¶å¤©æ•°

7. **è€ƒå‹¤è¡¨ä¿®æ”¹æƒé™**: âœ… **å·²ç¡®è®¤**
   - å®¢æˆ·ä¸èƒ½ä¿®æ”¹è€ƒå‹¤è¡¨
   - å¦‚æœ‰ç–‘é—®éœ€å‘˜å·¥é‡æ–°å¡«å†™å¹¶é‡æ–°å‘é€ç­¾ç½²é“¾æ¥

8. **å†å²æ•°æ®å¤„ç†**: âœ… **å·²ç¡®è®¤**
   - å†å²è®°å½•ä¸éœ€è¦å¤„ç†
   - æ–°æ—§ç³»ç»Ÿå¹¶å­˜,æ”¯æŒæ‰‹åŠ¨å½•å…¥å’Œç”µå­è¡¨å•ä¸¤ç§æ–¹å¼

9. **å¼‚å¸¸å¤„ç†**: âœ… **å·²ç¡®è®¤**
   - å®¢æˆ·æ‹’ç»ç­¾ç½²æ—¶,ç®¡ç†å‘˜å¯ç»§ç»­ä½¿ç”¨ç°æœ‰æ–¹å¼æ‰‹åŠ¨å½•å…¥è€ƒå‹¤æ•°æ®
   - åœ¨å·¥èµ„å•ä¸­æ‰‹åŠ¨å¡«å†™åŠ ç­æ—¶é—´ç­‰ä¿¡æ¯

10. **è®¿é—®æ–¹å¼**: âœ… **å·²ç¡®è®¤**
    - å‘˜å·¥å’Œå®¢æˆ·å‡æ— éœ€ç™»å½•ç³»ç»Ÿ
    - é€šè¿‡ä»¤ç‰Œ(token)è®¿é—®å’Œç­¾ç½²

11. **ç­¾ååŠŸèƒ½**: âœ… **å·²ç¡®è®¤**
    - å¤ç”¨ç³»ç»Ÿç°æœ‰çš„ç”µå­ç­¾ååŠŸèƒ½
    - æ— éœ€é›†æˆæ–°çš„ç¬¬ä¸‰æ–¹ç­¾ååº“

