# 合同模板管理功能增强需求文档

## 1. 背景与目标 (Background & Goals)

- **背景:** 当前的合同模板管理器功能过于简单，只支持创建和基础的文本编辑，无法满足版本管理、使用安全和非技术人员编辑的需求。
- **目标:** 对合同模板管理功能进行全面升级，引入版本控制、使用检查、可视化编辑和版本对比等高级功能，提升易用性、安全性和管理效率。

## 2. 功能需求 (Functional Requirements)

- **FR1: 列表视图 (List View)**
    - FR1.1: 默认视图应为表格/列表形式，取代现有的左右布局。
    - FR1.2: 列表应展示以下字段：模板名称、版本号、合同类型、创建时间、最后更新时间。
    - FR1.3: 每行应提供独立的操作按钮：查看、编辑、对比、删除。

- **FR2: 查看功能 (View Functionality)**
    - FR2.1: 点击“查看”按钮，应弹出一个模态框。
    - FR2.2: 模态框内应显示该模板内容经过Markdown渲染后的最终HTML效果。

- **FR3: 编辑功能 (Edit Functionality)**
    - FR3.1: 点击“编辑”按钮，应跳转到一个新的、独立的编辑页面 (e.g., `/contract-templates/edit/:id`)。
    - FR3.2: 编辑页面应提供双模式编辑器：
        - **分屏模式 (Split View):** 左侧为Markdown源码输入框，右侧实时显示渲染后的预览。此为默认模式。
        - **源码模式 (Source View):** 只显示一个全屏的Markdown源码输入框。
    - FR3.3: 用户应可以在两种模式间自由切换。

- **FR4: 保存逻辑 (Save Logic)**
    - FR4.1: 编辑页面提供两个保存按钮：“覆盖保存”和“另存为新版”。
    - FR4.2: **使用检查:** 在加载编辑页面时，后端需检查该模板ID是否已被任何合同使用。
    - FR4.3: **条件禁用:** 如果模板已被使用，则“覆盖保存”按钮应被禁用，并提示用户原因。
    - FR4.4: **覆盖保存:** 点击后，使用 `PUT` 请求更新当前模板。模板ID不变，`updated_at` 时间戳更新。
    - FR4.5: **另存为新版:** 点击后，使用 `POST` 请求在后端创建一个新的模板记录。新模板继承原模板的`template_name`, `contract_type`, `content`等，但`version`号加1，`created_at` 和 `updated_at` 设为当前时间。

- **FR5: 版本对比功能 (Version Diff Functionality)**
    - FR5.1: 点击“对比”按钮，应弹出一个模态框。
    - FR5.2: 该功能仅对版本号 > 1 的模板启用。
    - FR5.3: 模态框内应并排显示当前版本与上一个版本（version - 1）的Markdown源码内容，以便直观对比差异。

## 3. 非功能性需求 (Non-Functional Requirements)

- **NFR1: 性能:** 列表加载不应有明显延迟。
- **NFR2: 用户体验:** 界面应直观，操作有明确的反馈（如保存成功/失败的提示）。
- **NFR3: 安全性:** “覆盖保存”的禁用逻辑必须可靠，防止已生效合同的内容被意外修改。
