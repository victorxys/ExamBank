# 需求文档: 合同终止与余额结转流程优化

## 1. 需求背景

当前，育儿嫂合同在到期或手动终止时，其最后一个月的账单处理流程需要优化，以适应公司代付工资及客户账户余额处理的财务需求。为了确保财务操作的准确性、自动化和可追溯性，需要引入新的系统逻辑来处理合同终止时的特殊账务。

## 2. 功能目标

1.  **自动化处理末月工资**: 在育儿嫂合同终止时，自动在客户的最后一个月账单中添加一笔“公司代付员工工资”的财务调整项。
2.  **实现账户余额结转**: 允许将合同终止后的最终账单余额（无论是正数还是负数）方便地转移到该客户名下的其他合同中。
3.  **复用现有机制**: 新功能应最大程度地复用系统中已有的财务调整项转移功能和UI组件，以保证系统行为的一致性和开发效率。
4.  **保证可追溯性**: 所有转移操作必须有清晰的记录，用户可以方便地从转入记录追溯到原始的转出账单。

## 3. 核心功能描述

### 3.1. 合同终止时的自动化财务调整

此流程在育儿嫂合同被终止时触发。

1.  **生成“公司代付工资”调整项**:
    *   **触发时机**: 在合同终止流程中，为该合同生成最后一个客户账单后。
    *   **系统行为**: 系统自动在该账单下创建一笔新的财务调整项。
    *   **调整项详情**:
        *   **类型**: `COMPANY_PAID_SALARY`
        *   **描述**: “公司代付员工工资”
        *   **金额**: 该合同最后一个薪酬单的“应发总额” (`payroll.total_due`)。
        *   **创建者**: 系统自动
    *   **最终结果**: 此步骤执行完毕后，最后一个客户账单将包含所有常规结算项以及这笔“公司代付工资”项，并呈现一个最终的、**未结平的**“总应付款”。

### 3.2. 按需手动转移账单余额

此流程由用户在UI上发起，用于处理上一步产生的最终账单余额。

1.  **新增“转移余额”功能**:
    *   **UI变更**: 在已终止合同的最后一个账单的界面（例如 `FinancialManagementModal.jsx`），在“总应付款”附近，新增一个“**转移余额**”按钮。
    *   **显示条件**: 此按钮仅在当前账单是“已终止合同的最后一个账单”时显示。
    *   **用户操作**:
        1.  财务人员点击“转移余额”按钮。
        2.  系统弹出对话框（可复用 `TransferDepositDialog.jsx`），让用户选择一个属于同一客户名下的、有效的目标合同。
        3.  用户选择目标合同后点击“确认”。

2.  **新增“创建并转移”后端接口**:
    *   **新接口**: `POST /api/bills/<bill_id>/transfer-balance`
    *   **前端调用**: 用户在上述步骤3中点击“确认”后，前端调用此新接口，并传递目标合同ID。
    *   **后端原子操作**: 该接口会一步到位地执行以下操作：
        1.  **计算余额**: 获取当前账单的“总应付款” (`total_due`)。
        2.  **创建“结转”项**: 在当前账单下，自动创建一笔新的财务调整项，描述为“[系统] 账户余额结转”，金额为 `total_due` 的**负值**。
        3.  **调用转移服务**: 立即获取这个新创建的“结转”项的ID，并调用现有的内部转移服务，将其完整地转移到目标合同的第一个账单中。
        4.  **最终结果**: 原账单的总应付款变为零，余额成功出现在新合同的账单中，并带有可追溯的链接。

## 4. 非功能性需求

*   **准确性**: 所有财务计算必须精确到分。
*   **性能**: 在合同终止流程中增加的自动化操作不应显著增加处理时长。
*   **一致性**: UI和操作流程需与系统中现有的财务转移功能保持一致。
