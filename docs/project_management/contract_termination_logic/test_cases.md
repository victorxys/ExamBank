# 测试用例: 合同终止与余额结转

---

### 测试用例: 1. 育儿嫂合同正常终止 - 产生贷方余额 (客户有退款)

**测试目的:**
验证在合同正常终止，且客户有剩余款项的情况下，系统能否正确生成“代付工资”项，并允许财务通过新功能将最终余额结转。

**涉及模块/文件:**
- `backend/api/billing_api.py` (`terminate_contract`, 新的 `transfer-balance` 接口)
- `backend/services/billing_engine.py`
- `frontend/src/components/FinancialManagementModal.jsx`

**输入:**
1.  客户A拥有一个育儿嫂合同C1，月管理费1000元，已支付。
2.  合同C1在月中被手动终止。
3.  终止时，系统计算出客户C1有 `500` 元的预付管理费应退还。
4.  与最终账单关联的薪酬单，其“应发总额”为 `2000` 元。
5.  客户A名下存在另一个有效的合同C2。

**期望输出:**

**第一阶段：调用 `terminate_contract`**
1.  **后端**: 
    - 合同C1的最后一个账单B1被生成或更新。
    - 账单B1中自动出现一笔财务调整项，描述为“公司代付员工工资”，金额为 `2000` 元 (来自薪酬单)。
    - 经过重算，账单B1的最终“总应付款”为 `-500 + 2000 = 1500` 元。**账单不会被结平**。
    - **不会**自动创建“[系统] 账户余额结转”项。
2.  **前端**: 
    - 在账单B1的财务管理弹窗中，显示“总应付款”为 `1500` 元。
    - 在总额附近出现一个“转移余额”按钮。

**第二阶段：用户点击“转移余额”并调用 `transfer-balance` 接口**
1.  **后端** (`transfer-balance` 接口被调用后):
    - 在账单B1下创建一笔新的调整项，描述为“[系统] 账户余额结转”，金额为 `-1500` 元。
    - 调用内部转移服务，将这笔 `-1500` 元的调整项成功转移到合同C2的账单中。
    - 最终，账单B1的总应付款更新为 `0` 元。
2.  **前端**:
    - 刷新后，账单B1的“总应付款”显示为 `0`。
**实际输出 & 测试结果:**
- 单元测试: 通过
- 集成测试: [待填充]
- **最终检查结果:** [待填充]

---

### 测试用例: 2. 育儿嫂合同正常终止 - 产生借方余额 (客户有欠款)

**测试目的:**
验证在客户有欠款的情况下，系统能正确计算最终欠款，并通过“转移余额”功能将债务转移到新合同。

**输入:**
1.  客户A拥有一个育儿嫂合同C1。
2.  合同C1终止时，经计算，客户仍有 `400` 元的费用未支付。
3.  最终薪酬单的“应发总额”为 `2000` 元。
4.  客户A名下存在另一个有效的合同C2。

**期望输出:**

**第一阶段：调用 `terminate_contract`**
1.  **后端**: 
    - 账单B1中自动出现“公司代付员工工资”调整项，金额 `2000` 元。
    - 最终“总应付款”为 `400 + 2000 = 2400` 元。

**第二阶段：用户点击“转移余额”并调用 `transfer-balance` 接口**
1.  **后端**:
    - 在账单B1下创建“账户余额结转”项，金额为 `-2400` 元。
    - 成功将这笔 `-2400` 元的债务转移到合同C2。
    - 账单B1的总应付款更新为 `0` 元。

**实际输出 & 测试结果:**
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果:** [待填充]

---

### 测试用例: 3. 边界情况 - 最终余额为零

**测试目的:**
验证当最终账单余额恰好为零时，系统不提供“转移余额”功能。

**输入:**
1.  合同终止时，所有费用和退款（包括“公司代付工资”）相抵后，总应付款恰好为 `0`。

**期望输出:**
1.  **前端**: 在最终账单的财务管理弹窗中，“总应付款”为 `0`，且**不应该**显示“转移余额”按钮。

**实际输出 & 测试结果:**
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果:** [待填充]

---

### 测试用例: 4. 边界情况 - 终止时使用旧的 `transfer_options`

**测试目的:**
验证当 `terminate_contract` 接口被调用且带有 `transfer_options` 参数时，系统执行旧的、一步到位的转签逻辑，且不执行任何新的“按需创建”逻辑。

**输入:**
1.  同测试用例1的输入。
2.  在调用 `terminate_contract` 接口时，在请求体中加入了 `transfer_options`，指定了目标合同C2。

**期望输出:**
1.  **后端**:
    - 系统应执行旧的转签逻辑，将计算出的所有可退款项（如管理费退款、保证金退款）直接在合同C2上创建对应的冲抵项。
    - **不会**创建“公司代付工资”调整项。
    - **不会**创建“账户余额结转”调整项。
    - 前端不会看到“转移余额”按钮，因为旧逻辑已经处理了所有事情。

**实际输出 & 测试结果:**
- 单元测试: [待填充]
- 集成测试: [待填充]
- **最终检查结果:** [待填充]
