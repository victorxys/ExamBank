# 合同管理功能需求文档

## 1. 总览

本项目旨在为现有系统增加一个全面的合同管理模块。该模块将支持标准化合同模板的创建、基于模板生成正式合同、完整的线上签约流程、以及合同的续约和变更管理，并确保所有合同都能无缝对接到现有的账单和财务系统中。

## 2. 核心设计原则 (Linus's Rules)

1.  **不破坏现有逻辑**: 任何改动都不能影响现有的合同数据和账单生成流程。这是最高优先级。
2.  **遵循现有架构**: 新功能必须融入现有技术栈和设计模式，特别是数据库的多态继承结构和财务调整逻辑。
3.  **拒绝劣质品味**: 明确拒绝使用“纵表”(EAV)等反模式。设计必须追求简洁、清晰和类型安全。

## 3. 核心实体与数据模型

### 3.1. 客户 (甲方) [Done]

-   利用或扩展现有的 `Customer` 模型来存储正式的客户信息。
-   必须从 `jinshuju` 的历史合同中同步客户数据。
-   使用**身份证号**作为客户的唯一标识符。
-   **核心字段**: 姓名, 联系电话, 身份证号, 地址。

### 3.2. 员工 (乙方, `ServicePersonnel`)[Done]

-   以现有的 `ServicePersonnel` 模型为基础进行扩展。
-   同样需要从 `jinshuju` 同步历史数据。
-   使用**身份证号**作为员工的唯一标识符。
-   **核心字段**: 姓名, 姓名拼音, 联系电话, 身份证号, 员工类型 (月嫂/育儿嫂)。
-   员工的“劳务费报酬”是动态的，`ServicePersonnel` 表只记录最新值。

### 3.3. 员工薪资历史 (`EmployeeSalaryHistory`)

-   创建一个新模型 `EmployeeSalaryHistory` 来追踪员工薪资的变动。
-   **字段**:
    -   `personnel_id`: 关联到 `ServicePersonnel`。
    -   `contract_id`: 关联到导致薪资变更的合同。
    -   `salary`: 变更后的薪资。
    -   `effective_date`: 生效日期。

### 3.4. 合同模板 (`ContractTemplate`)[Done]

-   需要一个新模型 `ContractTemplate` 用于存储“制式合同”的模板。
-   **字段**:
    -   `template_name`: 模板名称 (如: "育儿嫂-年签", "月嫂-26天")。
    -   `contract_type`: 关联的合同类型 (如: `nanny`, `maternity_nurse`)。
    -   `content`: 合同主体内容，使用 Markdown 格式存储。
    -   `version`: 模板版本号。

### 3.5. 合同模型的扩展

为了支持正式合同的创建、签署和管理，我们选择**直接扩展现有的 `BaseContract` 模型**，而不是创建一个新的子类。这种方法更简洁，也更清晰地反映了业务实质：“正式合同”是信息更完备的“虚拟合同”，而非一个全新的类型。

-   **核心决策**: 不新增 `FormalContract` 模型，所有新字段将作为**可为空 (`nullable=True`)** 的列直接添加到 `contracts` 表中。[Done]
-   **在 `BaseContract` 中新增的字段**:[Done]
    -   `template_id`: 外键，关联到 `ContractTemplate`，可为空。
    -   `service_content`: 服务内容 (如: "婴幼儿养护", "家务服务")，可多选，存储为 JSON 或特定格式的字符串。
    -   `service_type`: 服务方式 (如: "全日住家型", "日间照料型")。
    -   `is_auto_renew`: 是否自动续签 (布尔值, 默认为 `False`)。
    -   `attachment_content`: 附件内容 (文本)。
    -   `signing_status`: 签署状态 (枚举: `unsigned`, `customer_signed`, `employee_signed`, `active`, `terminated`, `expired`, 默认为 `unsigned`)。
    -   `customer_signature`: 甲方签名信息 (存储图片路径或Base64数据)。
    -   `employee_signature`: 乙方签名信息。
    -   `unique_signing_token`: 用于生成唯一签署链接的令牌，需要建立唯一索引。
    -   `previous_contract_id`: 外键，自关联到 `contracts.id`，用于标识续约或变更前的源合同。

-   **虚拟合同与正式合同的定义**:
    -   **虚拟合同**: 一个 `BaseContract` 记录，其中上述新增的与“正式化”相关的字段（如 `template_id`, `signing_status`, `unique_signing_token` 等）基本为空。它主要用于内部财务和运营管理。
    -   **正式合同**: 一个 `BaseContract` 记录，其利用了上述新增字段，旨在通过线上流程完成签署，具备完整的法律效力。
-  由于业务的特殊性，有些客户为了保密或其他原因不会签署正式合同，不会有签名等。运营人员仍然会通过“创建虚拟合同”的方式来生成账单，进行后续的财务以及运营管理
-  在开始开发前，请从 frontend/src/components/CreateVirtualContractModal.jsx 作为入口，了解现在虚拟合同是如何创建的，包括但不限于前端页面的操作以及易用性逻辑，后端api的调用以及相关数据模型的结构
-  创建合同后要触发已有的方法来自动创建账单（对于育儿嫂合同）,就方法需要查看 backend/services/billing_engine.py 文件中的  BillingEngine 类，已经有了成熟的方法
-  创建正式合同的时候一定要从运营人员输入客户、员工信息时，先输入姓名，如果有此用户则可直接选择，并带出库中 已存的身份证、手机号、地址等基本数据，以及员工级别（最新月薪）。因此我们需要先有一个方法来填充客户(customer 表)以及 员工表(service_personnel),在此之前需要先扩充现有数据表的字段




## 4. 功能需求

### 4.1. 合同模板管理

-   提供后台界面，允许运营人员对 `ContractTemplate` 进行增删改查(CRUD)操作。
-   模板内容编辑器需要支持 Markdown。

### 4.2. 合同创建流程

1.  **选择模板**: 运营人员从已有的合同模板列表开始创建。
2.  **填写信息**:
    -   **乙方信息**: 通过姓名拼音模糊搜索 `ServicePersonnel` 表，选中后自动填充姓名、电话、身份证号等信息。
    -   **核心条款**: 填写劳务报酬、保证金、管理费、合同起止日期等。
    -   **扩展条款**: 勾选/填写服务内容、服务方式、是否自动续约等 `FormalContract` 中的新增字段。
3.  **生成待签合同**:
    -   系统创建一条 `FormalContract` 记录，状态为 `unsigned`。
    -   生成一个唯一的、安全的签署链接 (基于 `unique_signing_token`)。
    -   根据模板生成包含费用明细和签约链接的通知消息。

### 4.3. 电子签约流程

1.  **客户签署**: 客户通过链接完成甲方信息的填写和手写签名。
2.  **员工签署**: 员工通过链接完成乙方签名。
3.  **合同生效**: 双方签署完毕后，合同状态变为 `active`，并自动触发**现有的账单生成逻辑**。

### 4.4. 合同生命周期管理 (续约与变更)

1.  **发起续约/变更**: 在已生效的合同详情页，提供“续约”或“变更重签”按钮。
    -   目前系统已经有了一个合并、转移管理费等的功能，入口在这里 frontend/src/components/MergePreviewModal.jsx (此功能用来转移末期账单的所有费用客户+员工工资)，以及 frontend/src/components/FinancialManagementModal.jsx 中的 “转移客户账单余额”功能(此功能用来仅仅转移客户账单中应付总额，其中包含了末月应退的管理费)
    -   对于续约或者是变更来讲，前一个合同都是要终止的，请使用已有的终止功能 在 backend/api/billing_api.py 中的 terminate_contract()函数，里面已经有了详细的路基
2.  **创建新合同**: 点击后，系统跳转到合同创建页面，并**预先填充源合同的大部分信息**。
3.  **编辑信息**: 运营人员可以修改新合同的信息，关键场景包括：
    -   更换乙方 (`ServicePersonnel`)。
    -   调整乙方劳务报酬。
4.  **薪酬记录**: 如果劳务报酬发生变化，在**新合同生效时**，必须同步更新 `ServicePersonnel` 表中的最新薪酬，并向 `EmployeeSalaryHistory` 表中添加一条变更记录。
5.  **管理费转移**: 在此流程中，系统必须提供一个明确的选项给运营人员：“**是否将源合同的剩余管理费转移至新合同？**”
    -   如果选择“是”，则必须调用**系统中已有的财务调整项转移功能**，生成相应的 `FinancialAdjustment` 记录，将费用从旧合同转移到新合同，以正确抵扣客户应付费用。

## 5. 非功能性需求

-   **数据同步**: 需要编写或修改一次性脚本，用于从 `jinshuju` 解析历史数据并填充到 `Customer` 和 `ServicePersonnel` 表中。
-   **安全性**: 签约链接必须是唯一的、不可猜测的。签名数据需要安全存储。
-   **性能**: 员工信息的拼音搜索必须快速、高效。
