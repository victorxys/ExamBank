# 管理费退款修复脚本使用说明

## 问题描述

对于开始日和结束日相同的非月签育儿嫂合同（如17日开始17日结束），在终止时计算管理费退款存在bug：

**错误逻辑：**
- 将"终止日到下个月的周期结束日"作为部分周期
- 导致少算了一个完整周期

**示例：**
- 合同周期：2025-10-17 ~ 2026-10-17
- 终止日期：2026-01-06
- 错误计算：部分周期 1月6日~2月16日（42天），完整周期8个
- 正确计算：部分周期 1月6日~1月16日（11天），完整周期9个

## 修复内容

脚本会：
1. 查找所有受影响的已终止非月签育儿嫂合同
2. 重新计算正确的管理费退款金额
3. 删除错误的退款调整项
4. 创建正确的退款调整项

## 使用方法

### 1. 演习模式（推荐先运行）

查看将要修复的数据，不会实际修改数据库：

```bash
python fix_management_fee_refund.py --dry-run
```

### 2. 执行修复

实际修改数据库：

```bash
python fix_management_fee_refund.py
```

执行时会要求确认：
```
确认要执行修复吗？(yes/no): yes
```

## 输出示例

```
================================================================================
非月签育儿嫂合同管理费退款修复脚本
================================================================================

【演习模式】- 只显示将要修复的数据，不会实际修改数据库

正在查找受影响的合同...
找到 150 个已终止的非月签育儿嫂合同

找到 3 个需要修复的合同

[演习] 修复合同 abc-123-def
  客户: 张三
  员工: 李四
  合同周期: 2025-10-17 ~ 2026-10-17
  终止日期: 2026-01-06
  当前退款: 2820.00元
  正确退款: 2810.00元
  差额: -10.00元
  当前周期结束: 2026-01-16
  部分周期天数: 11天
  剩余完整周期: 9个

================================================================================
总计: 3 个合同需要修复
总差额: -30.00元
================================================================================

【演习模式】未修改数据库
如需实际执行修复，请运行: python fix_management_fee_refund.py
```

## 注意事项

1. **备份数据库**：执行修复前建议备份数据库
2. **先运行演习模式**：确认修复的数据正确后再执行实际修复
3. **检查结果**：修复后检查相关账单和调整项是否正确
4. **影响范围**：只影响已终止的非月签育儿嫂合同的管理费退款调整项

## 修复的合同条件

脚本只会修复满足以下所有条件的合同：

1. 合同类型：育儿嫂合同（NannyContract）
2. 合同状态：已终止（terminated）
3. 合同类型：非月签（is_monthly_auto_renew = False）
4. 有终止日期（termination_date 不为空）
5. 开始日和结束日相同（如都是17日）
6. 跨月终止（终止月份不是合同结束月份）
7. 存在管理费退款调整项
8. 当前退款金额与正确金额不一致

## 代码修复

除了运行修复脚本，以下文件的代码也已修复，防止未来再次出现此问题：

1. `backend/api/billing_api.py` - 终止合同API接口
2. `backend/management_commands.py` - 管理命令中的相同逻辑

## 技术细节

### 正确的周期计算逻辑

对于17日开始17日结束的合同，周期定义为：
- 第1周期：10月17日 ~ 11月16日
- 第2周期：11月17日 ~ 12月16日
- 第3周期：12月17日 ~ 1月16日
- ...

当在1月6日终止时：
- 当前周期：12月17日 ~ 1月16日
- 部分周期退款：1月6日 ~ 1月16日（11天）
- 完整周期退款：1月17日开始的所有完整周期

### 关键代码逻辑

```python
# 找到终止日所在周期的结束日
if termination_date.day >= contract_start_day:
    # 终止日在当前周期内
    current_cycle_end = date(year, month + 1, contract_start_day - 1)
else:
    # 终止日在上个周期的后半段
    current_cycle_end = date(year, month, contract_start_day - 1)
```

## 问题排查

如果脚本运行出错，请检查：

1. 数据库连接是否正常
2. 相关表是否存在：`nanny_contract`, `customer_bill`, `financial_adjustment`
3. Python环境是否正确配置
4. 是否有足够的数据库权限

## 联系支持

如有问题，请联系技术支持团队。
